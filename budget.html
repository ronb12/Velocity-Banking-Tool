<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>💰 Bradley's Budget Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Enhanced Utility Scripts -->
  <script src="config.js"></script>
  <script src="utils/validation.js"></script>
  <script src="utils/errorHandler.js"></script>
  <script src="utils/performance.js"></script>
  <script src="utils/mobileOptimizer.js"></script>
  <script src="utils/accessibility.js"></script>
  <script src="utils/analytics.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .header h1 {
      color: #007bff;
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .header p {
      color: #6c757d;
      font-size: 1.1rem;
      margin-bottom: 20px;
    }
    
    .month-selector {
      display: flex;
      align-items: center;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .month-selector label {
      font-weight: 600;
      color: #495057;
      font-size: 1rem;
    }
    
    .month-selector input[type="month"] {
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    .month-selector input[type="month"]:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #007bff;
      text-decoration: none;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 8px;
      background: rgba(0, 123, 255, 0.1);
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }
    
    .back-link:hover {
      background: rgba(0, 123, 255, 0.2);
      transform: translateX(-5px);
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      border-left: 4px solid;
    }
    
    .summary-card.income { border-left-color: #28a745; }
    .summary-card.budgeted { border-left-color: #ffc107; }
    .summary-card.spent { border-left-color: #dc3545; }
    .summary-card.remaining { border-left-color: #007bff; }
    
    .summary-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .summary-label {
      color: #6c757d;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e9ecef;
    }
    
    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Make table action buttons smaller to fit in container */
    #expenseTable .btn {
      padding: 4px 6px;
      font-size: 0.7rem;
      gap: 2px;
      min-width: auto;
      white-space: nowrap;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      color: #007bff;
      border: 2px solid #007bff;
    }
    
    .btn-outline:hover {
      background: #007bff;
      color: white;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.9rem;
    }
    
    th, td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }
    
    /* Give more space to bill name column */
    #expenseTable th:nth-child(2),
    #expenseTable td:nth-child(2) {
      min-width: 180px;
      width: 25%;
    }
    
    /* Make category column much wider to show full names */
    #expenseTable th:nth-child(1),
    #expenseTable td:nth-child(1) {
      width: 25%;
      min-width: 180px;
    }
    
    /* Make number columns wider for dollar amounts */
    #expenseTable th:nth-child(3),
    #expenseTable td:nth-child(3),
    #expenseTable th:nth-child(4),
    #expenseTable td:nth-child(4),
    #expenseTable th:nth-child(5),
    #expenseTable td:nth-child(5) {
      width: 12%;
      min-width: 130px;
    }
    
    /* Make due date column narrower */
    #expenseTable th:nth-child(6),
    #expenseTable td:nth-child(6) {
      width: 12%;
      min-width: 120px;
    }
    
    /* Make paid from column */
    #expenseTable th:nth-child(7),
    #expenseTable td:nth-child(7) {
      width: 12%;
      min-width: 100px;
    }
    
    /* Make actions column narrower and ensure buttons fit */
    #expenseTable th:nth-child(8),
    #expenseTable td:nth-child(8) {
      width: 6%;
      min-width: 60px;
      text-align: center;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      background: white;
      min-height: 36px;
    }
    
    /* Make bill name input specifically larger */
    input[type="text"] {
      font-size: 1rem;
      padding: 8px 12px;
      min-height: 36px;
    }
    
    /* Make number inputs larger to fit all numbers */
    input[type="number"] {
      font-size: 0.9rem;
      padding: 8px 12px;
      min-height: 36px;
      text-align: right;
    }
    
    /* Make category select boxes bigger */
    select {
      font-size: 0.9rem;
      padding: 8px 12px;
      min-height: 36px;
      white-space: nowrap;
      overflow: visible;
      text-overflow: unset;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    input[type="number"] {
      text-align: right;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
    }
    
    .notes-section {
      margin-top: 30px;
    }
    
    .notes-section textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .success-msg {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
    
    .warning {
      color: #dc3545;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .month-selector {
        flex-direction: column;
        gap: 10px;
      }
      
      .month-selector input[type="month"] {
        min-width: 200px;
      }
      
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      
      .section {
        padding: 20px;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .controls {
        flex-direction: column;
        align-items: center;
      }
      
      table {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 8px 6px;
      }
      
      /* Make bill name column even wider on mobile */
      #expenseTable th:nth-child(2),
      #expenseTable td:nth-child(2) {
        min-width: 180px;
        width: 35%;
      }
      
      /* Make category column wider on mobile too */
      #expenseTable th:nth-child(1),
      #expenseTable td:nth-child(1) {
        width: 30%;
        min-width: 150px;
      }
      
      /* Make text inputs compact on mobile */
      input[type="text"] {
        font-size: 0.9rem;
        padding: 6px 10px;
        min-height: 32px;
      }
      
      /* Make number inputs compact on mobile too */
      input[type="number"] {
        font-size: 0.8rem;
        padding: 6px 10px;
        min-height: 32px;
      }
      
      /* Make select boxes compact on mobile too */
      select {
        font-size: 0.8rem;
        padding: 6px 10px;
        min-height: 32px;
      }
      
      /* Adjust number column widths on mobile */
      #expenseTable th:nth-child(3),
      #expenseTable td:nth-child(3),
      #expenseTable th:nth-child(4),
      #expenseTable td:nth-child(4),
      #expenseTable th:nth-child(5),
      #expenseTable td:nth-child(5) {
        width: 18%;
        min-width: 100px;
      }
      
      /* Make paid from column on mobile */
      #expenseTable th:nth-child(7),
      #expenseTable td:nth-child(7) {
        width: 12%;
        min-width: 100px;
      }
      
      /* Make actions column even smaller on mobile */
      #expenseTable th:nth-child(8),
      #expenseTable td:nth-child(8) {
        width: 5%;
        min-width: 50px;
      }
      
      /* Make action buttons even smaller on mobile */
      #expenseTable .btn {
        padding: 3px 5px;
        font-size: 0.65rem;
        gap: 1px;
      }
    }
    
    @media (max-width: 480px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .summary-value {
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <a href="index.html" class="back-link">
      ← Back to Dashboard
    </a>
    
    <div class="header">
      <h1>💰 Bradley's Budget Tracker</h1>
      <p>Take control of your finances with our zero-based budgeting system</p>
      <div class="month-selector">
        <label for="monthSelect">Select Month:</label>
        <input type="month" id="monthSelect" onchange="onMonthChange()" />
        <button class="btn btn-outline" onclick="goToCurrentMonth()">📅 Current Month</button>
      </div>
    </div>
    
    <div class="summary-cards">
      <div class="summary-card income">
        <div class="summary-value" id="tileIncome">$0</div>
        <div class="summary-label">Total Income</div>
      </div>
      <div class="summary-card budgeted">
        <div class="summary-value" id="tileBudgeted">$0</div>
        <div class="summary-label">Budgeted</div>
      </div>
      <div class="summary-card spent">
        <div class="summary-value" id="tileSpent">$0</div>
        <div class="summary-label">Spent</div>
      </div>
      <div class="summary-card remaining">
        <div class="summary-value" id="tileRemaining">$0</div>
        <div class="summary-label">Remaining</div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">💰 Income</h3>
        <button class="btn btn-primary" onclick="addIncome()">+ Add Income</button>
      </div>
      <table id="incomeTable">
        <thead>
          <tr>
            <th>Source</th>
            <th>Amount ($)</th>
            <th>Remaining to Allocate</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">💳 Expenses</h3>
        <button class="btn btn-primary" onclick="addExpense()">+ Add Expense</button>
      </div>
      <table id="expenseTable">
        <thead>
          <tr>
            <th>Category</th>
            <th>Bill Name</th>
            <th>Budgeted</th>
            <th>Spent</th>
            <th>Remaining</th>
            <th>Due Date</th>
            <th>Paid From</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">📝 Monthly Notes</h3>
      </div>
      <div class="notes-section">
        <textarea id="monthlyNotes" placeholder="Write your financial goals, notes, and reminders here..."></textarea>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">🛠️ Actions</h3>
      </div>
      <div class="controls">
        <button class="btn btn-outline" onclick="calculateBudget()">🧮 Recalculate</button>
        <button class="btn btn-success" onclick="saveBudget()">💾 Save Budget</button>
        <button class="btn btn-outline" onclick="loadBudget()">📥 Load Budget</button>
        <button class="btn btn-primary" onclick="loadSampleBudget()">🎯 Load Sample</button>
        <button class="btn btn-outline" onclick="zeroBasedBudget()">✅ Zero-Based Check</button>
        <button class="btn btn-outline" onclick="exportBudgetToCSV()">📊 Export CSV</button>
        <button class="btn btn-outline" onclick="exportToPDF()">📄 Export PDF</button>
      </div>
    </div>
    
    <div class="success-msg" id="zeroBasedMessage">
      🎉 Congratulations! You've created a Zero-Based Budget!
    </div>
  </div>
  
  <div id="loadingIndicator" class="loading" style="display: none !important;">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = window.CONFIG?.firebase || {
      apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
      authDomain: "mobile-debt-tracker.firebaseapp.com",
      projectId: "mobile-debt-tracker",
      storageBucket: "mobile-debt-tracker.appspot.com",
      messagingSenderId: "153601029964",
      appId: "1:153601029964:web:ddd1880ba21bce2e9041e9"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let userId = "";
    
    // Initialize utility functions
    if (window.ErrorHandler) {
      window.ErrorHandler.setupGlobalErrorHandling();
    }
    
    if (window.MobileOptimizer) {
      window.MobileOptimizer.init();
    }
    
    // AccessibilityUtils disabled to remove skip link
    // if (window.AccessibilityUtils) {
    //   window.AccessibilityUtils.init();
    // }
    
    if (window.Analytics) {
      window.Analytics.init();
      window.Analytics.trackPageView('/budget.html', 'Budget Tracker');
    }
    
    // Authentication
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      userId = user.uid;
      console.log('User authenticated, loading budget data...');
      
      // Set current month as default
      const currentMonth = new Date().toISOString().slice(0, 7);
      document.getElementById('monthSelect').value = currentMonth;
      
      loadBudget();
    });
    
    // Month change handler
    function onMonthChange() {
      const selectedMonth = document.getElementById('monthSelect').value;
      console.log('Month changed to:', selectedMonth);
      
      // Clear current data
      document.querySelector("#incomeTable tbody").innerHTML = "";
      document.querySelector("#expenseTable tbody").innerHTML = "";
      document.getElementById("monthlyNotes").value = "";
      
      // Load budget for selected month
      loadBudget();
    }
    
    // Go to current month
    function goToCurrentMonth() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      document.getElementById('monthSelect').value = currentMonth;
      onMonthChange();
    }
    
    // Add Income function
    function addIncome(source = "", amount = 0) {
      const tbody = document.querySelector("#incomeTable tbody");
      const row = tbody.insertRow();
      
      row.innerHTML = `
        <td><input type="text" value="${source}" placeholder="Income source" onchange="calculateBudget()"></td>
        <td><input type="number" value="${amount}" placeholder="0.00" onchange="calculateBudget()"></td>
        <td class="remaining-cell">$0.00</td>
        <td><button class="btn btn-outline" onclick="this.closest('tr').remove(); calculateBudget()">🗑️ Remove</button></td>
      `;
      
      calculateBudget();
      updatePaidFromDropdowns();
    }
    
    // Add Expense function
    function addExpense(category = '', name = '', budgeted = 0, dueDate = '') {
      const tbody = document.querySelector("#expenseTable tbody");
      const row = tbody.insertRow();
      
      row.innerHTML = `
        <td>
          <select onchange="calculateBudget()">
            <option value="">Select Category</option>
            <option value="Housing" ${category === 'Housing' ? 'selected' : ''}>Housing</option>
            <option value="Transportation" ${category === 'Transportation' ? 'selected' : ''}>Transportation</option>
            <option value="Food" ${category === 'Food' ? 'selected' : ''}>Food</option>
            <option value="Utilities" ${category === 'Utilities' ? 'selected' : ''}>Utilities</option>
            <option value="Health" ${category === 'Health' ? 'selected' : ''}>Health</option>
            <option value="Personal" ${category === 'Personal' ? 'selected' : ''}>Personal</option>
            <option value="Lifestyle" ${category === 'Lifestyle' ? 'selected' : ''}>Lifestyle</option>
            <option value="Savings" ${category === 'Savings' ? 'selected' : ''}>Savings</option>
            <option value="Debt" ${category === 'Debt' ? 'selected' : ''}>Debt</option>
            <option value="Other" ${category === 'Other' ? 'selected' : ''}>Other</option>
          </select>
        </td>
        <td><input type="text" value="${name}" placeholder="Bill name" onchange="calculateBudget()"></td>
        <td><input type="number" value="${budgeted}" placeholder="0.00" onchange="calculateBudget()"></td>
        <td><input type="number" placeholder="0.00" onchange="calculateBudget()"></td>
        <td><input type="number" readonly></td>
        <td><input type="date" value="${dueDate}" onchange="calculateBudget()"></td>
        <td>
          <select onchange="calculateBudget()">
            <option value="">Select Income Source</option>
          </select>
        </td>
        <td><button class="btn btn-outline" onclick="this.closest('tr').remove(); calculateBudget()">🗑️ Remove</button></td>
      `;
      
      calculateBudget();
      updatePaidFromDropdowns();
    }
    
    // Update Paid From dropdowns with current income sources
    function updatePaidFromDropdowns() {
      const incomeSources = Array.from(document.querySelectorAll("#incomeTable tbody tr")).map(
        row => row.cells[0].querySelector("input").value.trim()
      ).filter(Boolean);
      
      document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
        const select = row.cells[6].querySelector("select");
        const currentValue = select.value;
        
        select.innerHTML = '<option value="">Select Income Source</option>' +
          incomeSources.map(source => 
            `<option value="${source}" ${source === currentValue ? 'selected' : ''}>${source}</option>`
          ).join('');
      });
    }
    
    // Calculate Budget function
    function calculateBudget() {
      let incomeTotal = 0;
      let budgetedTotal = 0;
      let spentTotal = 0;
      
      // Create income map to track allocation
      const incomeMap = {};
      
      // Calculate income and initialize income map
      document.querySelectorAll("#incomeTable tbody tr").forEach(row => {
        const source = row.cells[0].querySelector("input").value.trim();
        const amount = parseFloat(row.cells[1].querySelector("input").value) || 0;
        incomeTotal += amount;
        if (source) {
          incomeMap[source] = { amount: amount, allocated: 0 };
        }
      });
      
      // Calculate expenses and track allocation
      document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
        const budgeted = parseFloat(row.cells[2].querySelector("input").value) || 0;
        const spent = parseFloat(row.cells[3].querySelector("input").value) || 0;
        const remaining = budgeted - spent;
        const paidFrom = row.cells[6].querySelector("select").value;
        
        budgetedTotal += budgeted;
        spentTotal += spent;
        
        // Update remaining cell
        row.cells[4].querySelector("input").value = remaining.toFixed(2);
        
        // Allocate to specific income source if selected
        if (paidFrom && incomeMap[paidFrom]) {
          incomeMap[paidFrom].allocated += budgeted;
        }
      });
      
      // No automatic allocation - only allocate when "Paid From" is specifically selected
      // This ensures "Remaining to Allocate" shows full amounts when no allocation is made
      
      // Update income remaining to allocate
      document.querySelectorAll("#incomeTable tbody tr").forEach(row => {
        const source = row.cells[0].querySelector("input").value.trim();
        if (source && incomeMap[source]) {
          const remainingToAllocate = incomeMap[source].amount - incomeMap[source].allocated;
          row.cells[2].textContent = `$${remainingToAllocate.toFixed(2)}`;
        } else {
          const amount = parseFloat(row.cells[1].querySelector("input").value) || 0;
          row.cells[2].textContent = `$${amount.toFixed(2)}`;
        }
      });
      
      const remaining = incomeTotal - budgetedTotal;
      
      // Update summary cards
      document.getElementById("tileIncome").textContent = `$${incomeTotal.toFixed(2)}`;
      document.getElementById("tileBudgeted").textContent = `$${budgetedTotal.toFixed(2)}`;
      document.getElementById("tileSpent").textContent = `$${spentTotal.toFixed(2)}`;
      document.getElementById("tileRemaining").textContent = `$${remaining.toFixed(2)}`;
      
      // Update remaining color
      const remainingElement = document.getElementById("tileRemaining");
      remainingElement.style.color = remaining < 0 ? "#dc3545" : remaining > 0 ? "#28a745" : "#2c3e50";
      
      // Show zero-based message
      document.getElementById("zeroBasedMessage").style.display = 
        (incomeTotal > 0 && Math.abs(remaining) < 0.01) ? "block" : "none";
    }
    
    // Save Budget function
    async function saveBudget() {
      const loadingIndicator = document.getElementById("loadingIndicator");
      loadingIndicator.style.display = "block";
      
      try {
        const budgetData = {
          income: Array.from(document.querySelectorAll("#incomeTable tbody tr")).map(row => ({
            source: row.cells[0].querySelector("input").value,
            amount: parseFloat(row.cells[1].querySelector("input").value) || 0
          })),
          expenses: Array.from(document.querySelectorAll("#expenseTable tbody tr")).map(row => ({
            category: row.cells[0].querySelector("select").value,
            name: row.cells[1].querySelector("input").value,
            budgeted: parseFloat(row.cells[2].querySelector("input").value) || 0,
            spent: parseFloat(row.cells[3].querySelector("input").value) || 0,
            due: row.cells[5].querySelector("input").value
          })),
          notes: document.getElementById("monthlyNotes").value,
          month: new Date().toISOString().slice(0, 7) // YYYY-MM format
        };
        
        await db.collection("budgets").doc(userId).set(budgetData);
        
        if (window.ErrorHandler) {
          window.ErrorHandler.showSuccess('Budget saved successfully!');
        } else {
          alert('Budget saved successfully!');
        }
      } catch (error) {
        console.error('Error saving budget:', error);
        if (window.ErrorHandler) {
          window.ErrorHandler.handleFirebaseError(error);
        } else {
          alert('Error saving budget: ' + error.message);
        }
      } finally {
        loadingIndicator.style.display = "none";
      }
    }
    
    // Load Budget function
    async function loadBudget() {
      const loadingIndicator = document.getElementById("loadingIndicator");
      loadingIndicator.style.display = "block";
      
      try {
        const doc = await db.collection("budgets").doc(userId).get();
        
        if (doc.exists) {
          const data = doc.data();
          
          // Clear existing data
          document.querySelector("#incomeTable tbody").innerHTML = "";
          document.querySelector("#expenseTable tbody").innerHTML = "";
          document.getElementById("monthlyNotes").value = "";
          
          // Load income data
          if (data.income && Array.isArray(data.income)) {
            data.income.forEach(inc => {
              if (inc.source && inc.amount) {
                addIncome(inc.source, inc.amount);
              }
            });
          }
          
          // Load expense data
          if (data.expenses && Array.isArray(data.expenses)) {
            data.expenses.forEach(exp => {
              if (exp.category && exp.name) {
                addExpense(exp.category, exp.name, exp.budgeted || 0, exp.due || '');
              }
            });
          }
          
          // Load notes
          if (data.notes) {
            document.getElementById("monthlyNotes").value = data.notes;
          }
          
          calculateBudget();
          
          if (window.ErrorHandler) {
            window.ErrorHandler.showSuccess('Budget loaded successfully!');
          }
        } else {
          if (window.ErrorHandler) {
            window.ErrorHandler.showWarning('No budget data found. Start by adding income and expenses.');
          }
        }
      } catch (error) {
        console.error('Error loading budget:', error);
        if (window.ErrorHandler) {
          window.ErrorHandler.handleFirebaseError(error);
        } else {
          alert('Error loading budget: ' + error.message);
        }
      } finally {
        loadingIndicator.style.display = "none";
      }
    }
    
    // Load Sample Budget function
    async function loadSampleBudget() {
      const sampleBudgetData = {
        month: new Date().toISOString().slice(0, 7),
        notes: 'Sample budget for testing purposes. This includes typical income and expense categories.',
        income: [
          { source: 'Primary Job', amount: 5000 },
          { source: 'Freelance Work', amount: 1200 },
          { source: 'Investment Returns', amount: 300 }
        ],
        expenses: [
          { category: 'Housing', name: 'Rent/Mortgage', budgeted: 1500, spent: 1500, due: '2024-01-01' },
          { category: 'Housing', name: 'Utilities', budgeted: 200, spent: 180, due: '2024-01-15' },
          { category: 'Transportation', name: 'Car Payment', budgeted: 400, spent: 400, due: '2024-01-05' },
          { category: 'Transportation', name: 'Gas', budgeted: 200, spent: 180, due: '2024-01-01' },
          { category: 'Food', name: 'Groceries', budgeted: 600, spent: 550, due: '2024-01-01' },
          { category: 'Food', name: 'Dining Out', budgeted: 200, spent: 180, due: '2024-01-01' },
          { category: 'Personal', name: 'Phone Bill', budgeted: 100, spent: 100, due: '2024-01-15' },
          { category: 'Health', name: 'Health Insurance', budgeted: 300, spent: 300, due: '2024-01-01' },
          { category: 'Debt', name: 'Credit Card Payment', budgeted: 500, spent: 500, due: '2024-01-25' },
          { category: 'Savings', name: 'Emergency Fund', budgeted: 500, spent: 500, due: '2024-01-01' }
        ]
      };
      
      try {
        // Clear existing data
        document.querySelector("#incomeTable tbody").innerHTML = "";
        document.querySelector("#expenseTable tbody").innerHTML = "";
        document.getElementById("monthlyNotes").value = "";
        
        // Load sample data
        sampleBudgetData.income.forEach(inc => {
          addIncome(inc.source, inc.amount);
        });
        
        sampleBudgetData.expenses.forEach(exp => {
          addExpense(exp.category, exp.name, exp.budgeted, exp.due);
        });
        
        document.getElementById("monthlyNotes").value = sampleBudgetData.notes;
        
        calculateBudget();
        
        if (window.ErrorHandler) {
          window.ErrorHandler.showSuccess('Sample budget loaded successfully!');
        } else {
          alert('Sample budget loaded successfully!');
        }
      } catch (error) {
        console.error('Error loading sample budget:', error);
        if (window.ErrorHandler) {
          window.ErrorHandler.handleFirebaseError(error);
        } else {
          alert('Error loading sample budget: ' + error.message);
        }
      }
    }
    
    // Zero-Based Budget Check function
    function zeroBasedBudget() {
      calculateBudget();
      const incomeTotal = parseFloat(document.getElementById("tileIncome").textContent.replace(/[^0-9.-]+/g, ""));
      const budgetedTotal = parseFloat(document.getElementById("tileBudgeted").textContent.replace(/[^0-9.-]+/g, ""));
      const remaining = incomeTotal - budgetedTotal;
      
      if (incomeTotal === 0) {
        alert("⚠️ Please add some income first!");
        return;
      }
      
      if (Math.abs(remaining) < 0.01) {
        alert("✅ Perfect! Your budget is zero-based!");
        return;
      }
      
      if (remaining > 0) {
        alert(`You have $${remaining.toFixed(2)} remaining to allocate to your budget.`);
      } else {
        alert(`You are over budget by $${Math.abs(remaining).toFixed(2)}.`);
      }
    }
    
    // Export to CSV function
    function exportBudgetToCSV() {
      const incomeRows = document.querySelectorAll("#incomeTable tbody tr");
      const expenseRows = document.querySelectorAll("#expenseTable tbody tr");
      let csvContent = "data:text/csv;charset=utf-8,";
      
      csvContent += "Income Source,Amount\n";
      incomeRows.forEach(row => {
        const source = row.cells[0].querySelector("input").value;
        const amount = row.cells[1].querySelector("input").value;
        csvContent += `${source},${amount}\n`;
      });
      
      csvContent += "\nExpense Category,Bill Name,Budgeted,Spent,Due Date\n";
      expenseRows.forEach(row => {
        const category = row.cells[0].querySelector("select").value;
        const name = row.cells[1].querySelector("input").value;
        const budgeted = row.cells[2].querySelector("input").value;
        const spent = row.cells[3].querySelector("input").value;
        const due = row.cells[5].querySelector("input").value;
        csvContent += `${category},${name},${budgeted},${spent},${due}\n`;
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "budget_data.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Export to PDF function
    function exportToPDF() {
      // Get current budget data
      const incomeTotal = document.getElementById("tileIncome").textContent;
      const budgetedTotal = document.getElementById("tileBudgeted").textContent;
      const spentTotal = document.getElementById("tileSpent").textContent;
      const remainingTotal = document.getElementById("tileRemaining").textContent;
      const selectedMonth = document.getElementById("monthSelect").value || new Date().toISOString().slice(0, 7);
      
      // Create a new window for printing
      const printWindow = window.open('', '_blank');
      
      // Get income data
      const incomeRows = Array.from(document.querySelectorAll("#incomeTable tbody tr")).map(row => ({
        source: row.cells[0].querySelector("input").value,
        amount: row.cells[1].querySelector("input").value
      })).filter(inc => inc.source && inc.amount);
      
      // Get expense data
      const expenseRows = Array.from(document.querySelectorAll("#expenseTable tbody tr")).map(row => ({
        category: row.cells[0].querySelector("select").value,
        name: row.cells[1].querySelector("input").value,
        budgeted: row.cells[2].querySelector("input").value,
        spent: row.cells[3].querySelector("input").value,
        remaining: row.cells[4].querySelector("input").value,
        dueDate: row.cells[5].querySelector("input").value,
        paidFrom: row.cells[6].querySelector("select").value
      })).filter(exp => exp.name);
      
      // Get notes
      const notes = document.getElementById("monthlyNotes").value;
      
      // Create HTML content for PDF
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Budget Report - ${selectedMonth}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .summary { display: flex; justify-content: space-around; margin-bottom: 30px; }
            .summary-item { text-align: center; padding: 10px; border: 1px solid #ccc; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
            th { background-color: #f5f5f5; }
            .section { margin-bottom: 30px; }
            .notes { margin-top: 20px; }
            @media print { body { margin: 0; } }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>💰 Bradley's Budget Tracker</h1>
            <h2>Budget Report - ${selectedMonth}</h2>
          </div>
          
          <div class="summary">
            <div class="summary-item">
              <h3>Total Income</h3>
              <p>${incomeTotal}</p>
            </div>
            <div class="summary-item">
              <h3>Budgeted</h3>
              <p>${budgetedTotal}</p>
            </div>
            <div class="summary-item">
              <h3>Spent</h3>
              <p>${spentTotal}</p>
            </div>
            <div class="summary-item">
              <h3>Remaining</h3>
              <p>${remainingTotal}</p>
            </div>
          </div>
          
          <div class="section">
            <h3>💰 Income Sources</h3>
            <table>
              <thead>
                <tr>
                  <th>Source</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                ${incomeRows.map(inc => `
                  <tr>
                    <td>${inc.source}</td>
                    <td>$${parseFloat(inc.amount || 0).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div class="section">
            <h3>💳 Expenses</h3>
            <table>
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Bill Name</th>
                  <th>Budgeted</th>
                  <th>Spent</th>
                  <th>Remaining</th>
                  <th>Due Date</th>
                  <th>Paid From</th>
                </tr>
              </thead>
              <tbody>
                ${expenseRows.map(exp => `
                  <tr>
                    <td>${exp.category}</td>
                    <td>${exp.name}</td>
                    <td>$${parseFloat(exp.budgeted || 0).toFixed(2)}</td>
                    <td>$${parseFloat(exp.spent || 0).toFixed(2)}</td>
                    <td>$${parseFloat(exp.remaining || 0).toFixed(2)}</td>
                    <td>${exp.dueDate || ''}</td>
                    <td>${exp.paidFrom || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          ${notes ? `
          <div class="notes">
            <h3>📝 Notes</h3>
            <p>${notes}</p>
          </div>
          ` : ''}
          
          <div style="margin-top: 30px; text-align: center; color: #666;">
            <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
          </div>
        </body>
        </html>
      `;
      
      // Write content to new window
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      // Wait for content to load, then print
      printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
      };
      
      if (window.ErrorHandler) {
        window.ErrorHandler.showSuccess('Budget exported to PDF successfully!');
      } else {
        alert('Budget exported to PDF successfully!');
      }
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      calculateBudget();
    });
  </script>
</body>
</html>
