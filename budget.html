<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üí∞ Bradley's Zero-Based Budget Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Enhanced Utility Scripts -->
  <script src="config.js"></script>
  <script src="utils/validation.js"></script>
  <script src="utils/errorHandler.js"></script>
  <script src="utils/performance.js"></script>
  <script src="utils/mobileOptimizer.js"></script>
  <script src="utils/accessibility.js"></script>
  <script src="utils/analytics.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; padding: 20px; margin: 0; text-align: center; }
    h1 { color: #007bff; }
    .container { max-width: 1200px; margin: auto; }
    .grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
    .main-content { grid-column: 1; }
    .sidebar { grid-column: 2; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    th { background: #007bff; color: white; }
    input, select, textarea { width: 100%; padding: 6px; box-sizing: border-box; }
    .controls, .summary { margin-top: 20px; }
    .controls button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .controls button:hover { background: #0056b3; }
    .dashboard-tile {
      display: inline-block; margin: 10px; padding: 10px 20px;
      background: #fff; border-left: 5px solid; border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1); min-width: 180px;
    }
    .dashboard-total-income { border-color: #28a745; }
    .dashboard-total-budgeted { border-color: #ffc107; }
    .dashboard-total-spent { border-color: #dc3545; }
    .dashboard-total-remaining { border-color: #007bff; }
    .dashboard-total-paid { border-color: #6f42c1; }
    .success-msg { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; display: none; margin-top: 15px; }
    #savePopup {
      position: fixed; top: 10px; right: 10px;
      background: #28a745; color: white; padding: 10px; border-radius: 6px; display: none;
    }
    .warning { color: #dc3545; font-weight: bold; }
    .back { display: inline-block; margin-top: 20px; text-decoration: none; font-weight: bold; color: #007bff; }
    .dark-mode {
      background: #333;
      color: #fff;
    }
    .dark-mode table {
      background: #444;
      color: #fff;
    }
    .dark-mode th {
      background: #555;
    }
    .dark-mode input, .dark-mode select, .dark-mode textarea {
      background: #555;
      color: #fff;
      border: 1px solid #777;
    }
    .chart-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .category-filters {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .category-filters select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .smart-features {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .reminder {
      background: #fff3cd;
      padding: 10px;
      border-radius: 4px;
      margin: 5px 0;
      text-align: left;
    }
    .reminder.due-soon {
      border-left: 4px solid #ffc107;
    }
    .reminder.overdue {
      border-left: 4px solid #dc3545;
    }
    .keyboard-shortcuts {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: none;
    }
    .keyboard-shortcuts.show {
      display: block;
    }
    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: 1fr;
      }
      .sidebar {
        grid-column: 1;
      }
    }
  </style>
</head>

<body>
<div class="container">
  <h1>üí∏ Bradley's Budget Tracker</h1>
  <label for="month">Select Month:</label>
  <input type="month" id="month" onchange="onMonthChange()" />

  <div class="grid-container">
    <div class="main-content">
      <div class="category-filters">
        <select id="categoryFilter" onchange="filterByCategory()">
          <option value="">All Categories</option>
          <option value="Giving">Giving (10%)</option>
          <option value="Savings">Savings</option>
          <option value="Housing">Housing (25%)</option>
          <option value="Utilities">Utilities</option>
          <option value="Transportation">Transportation</option>
          <option value="Food">Food</option>
          <option value="Personal">Personal</option>
          <option value="Lifestyle">Lifestyle</option>
          <option value="Health">Health</option>
          <option value="Insurance">Insurance</option>
          <option value="Debt">Debt</option>
          <option value="Sinking Funds">Sinking Funds</option>
          <option value="Other">Other</option>
        </select>
        <button onclick="toggleKeyboardShortcuts()" title="Show Keyboard Shortcuts">‚å®Ô∏è</button>
      </div>

      <h3>Income Sources</h3>
      <table id="incomeTable">
        <thead><tr><th>Source</th><th>Amount ($)</th><th>Remaining to Allocate</th><th>Remove</th></tr></thead>
        <tbody></tbody>
      </table>
      <button onclick="addIncome()">+ Add Income</button>

      <h3>Expenses</h3>
      <table id="expenseTable">
        <thead>
          <tr>
            <th><input type="checkbox" onclick="checkAll(this)"></th>
            <th>Category & Bill Name</th>
            <th>Budgeted</th>
            <th>Spent</th>
            <th>Remaining</th>
            <th>Due Date</th>
            <th>Paid From</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="addExpense()">+ Add Expense</button>

      <h3>Monthly Notes</h3>
      <textarea id="monthlyNotes" rows="4" placeholder="Write financial goals, notes, reminders..."></textarea>

      <div class="controls">
        <button onclick="calculateBudget()" title="Recalculate your budget">üßÆ Recalculate</button>
        <button onclick="saveBudget()" title="Save your budget data">üíæ Save</button>
        <button onclick="loadBudget()" title="Load your saved budget">üì• Load Budget</button>
        <button onclick="prefillSpent()" title="Prefill spent amounts">‚ö° Prefill Spent</button>
        <button onclick="undoPrefill()" title="Undo prefill changes">‚Ü©Ô∏è Undo Prefill</button>
        <button onclick="zeroBasedBudget()" title="Check if your budget is zero-based">‚úÖ Zero-Based Check</button>
        <button onclick="exportBudgetToCSV()" title="Export budget data to CSV">üìä Export to CSV</button>
        <button onclick="importBudgetFromCSV()" title="Import budget data from CSV">üì• Import from CSV</button>
        <button onclick="saveAsTemplate()" title="Save current budget as a template">üìã Save as Template</button>
        <button onclick="loadTemplate()" title="Load a saved budget template">üìã Load Template</button>
        <button onclick="exportToPDF()" title="Export budget to PDF">üìÑ Export to PDF</button>
      </div>

      <div class="summary">
        <div class="dashboard-tile dashboard-total-income" id="tileIncome">Total Income: $0</div>
        <div class="dashboard-tile dashboard-total-budgeted" id="tileBudgeted">Budgeted: $0</div>
        <div class="dashboard-tile dashboard-total-spent" id="tileSpent">Spent: $0</div>
        <div class="dashboard-tile dashboard-total-remaining" id="tileRemaining">Remaining: $0</div>
        <div class="dashboard-tile dashboard-total-paid" id="tilePaid">Paid: $0</div>
      </div>
    </div>

    <div class="sidebar">
      <div class="chart-container">
        <h3>Budget Overview</h3>
        <canvas id="budgetChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>Expense Categories</h3>
        <canvas id="categoryChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>Monthly Comparison</h3>
        <canvas id="monthlyChart"></canvas>
      </div>

      <div class="smart-features">
        <h3>Smart Features</h3>
        <div id="budgetRecommendations"></div>
        <div id="dueDateReminders"></div>
        <div id="recurringExpenses"></div>
      </div>
    </div>
  </div>

  <div class="success-msg" id="zeroBasedMessage">üéâ Congratulations! You've created a Zero-Based Budget!</div>
  <div id="savePopup">‚úÖ Saved!</div>

  <div class="keyboard-shortcuts" id="keyboardShortcuts">
    <h4>Keyboard Shortcuts</h4>
    <p>Ctrl + I: Add Income</p>
    <p>Ctrl + E: Add Expense</p>
    <p>Ctrl + S: Save Budget</p>
    <p>Ctrl + L: Load Budget</p>
    <p>Ctrl + Z: Undo Prefill</p>
    <p>Ctrl + F: Filter Categories</p>
    <p>Esc: Close this panel</p>
  </div>

  <a class="back" href="index.html">‚Üê Back to Dashboard</a>
</div>

<div id="loadingIndicator" style="display: none; text-align: center; margin: 20px 0;">
  <p>Loading...</p>
</div>

<button id="darkModeToggle" onclick="toggleDarkMode()" style="position: absolute; top: 10px; right: 10px;">üåô Toggle Dark Mode</button>

<script>
// Use centralized configuration
const firebaseConfig = window.CONFIG?.firebase || {
  apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
  authDomain: "mobile-debt-tracker.firebaseapp.com",
  projectId: "mobile-debt-tracker",
  storageBucket: "mobile-debt-tracker.appspot.com",
  messagingSenderId: "153601029964",
  appId: "1:153601029964:web:ddd1880ba21bce2e9041e9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let userId = "";
let prefillBackup = [];

// Initialize utility functions
if (window.ErrorHandler) {
  window.ErrorHandler.setupGlobalErrorHandling();
}

if (window.MobileOptimizer) {
  window.MobileOptimizer.init();
}

if (window.AccessibilityUtils) {
  window.AccessibilityUtils.init();
}

if (window.Analytics) {
  window.Analytics.init();
  window.Analytics.trackPageView('/budget.html', 'Budget Tracker');
}

auth.onAuthStateChanged(user => {
  if (!user) return window.location.href = "login.html";
  userId = user.uid;
  console.log('User authenticated, loading budget data...');
  loadBudget();
  setInterval(saveBudget, 30000);
});

function onMonthChange() {
  document.querySelector("#incomeTable tbody").innerHTML = "";
  document.querySelector("#expenseTable tbody").innerHTML = "";
  document.getElementById("monthlyNotes").value = "";
  loadBudget();
}

function addIncome(source = "", amount = 0) {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input type="text" value="${source}"></td>
    <td><input type="number" value="${amount}"></td>
    <td class="remaining-cell">$0.00</td>
    <td><button onclick="this.closest('tr').remove(); calculateBudget(); updatePaidFromDropdowns();">üóëÔ∏è</button></td>
  `;
  document.querySelector("#incomeTable tbody").appendChild(row);
  updatePaidFromDropdowns();
}

function addExpense(category = '', name = '', budgeted = 0, dueDate = '') {
  const tbody = document.querySelector("#expenseTable tbody");
  const row = tbody.insertRow();
  
  // Checkbox cell
  const checkboxCell = row.insertCell();
  checkboxCell.innerHTML = '<input type="checkbox">';
  
  // Category and Name cell
  const categoryCell = row.insertCell();
  categoryCell.innerHTML = `
    <select onchange="updateExpenseCategory(this)" style="margin-bottom: 5px;">
      <option value="">Select Category</option>
      <option value="Giving" ${category === 'Giving' ? 'selected' : ''}>Giving (10%)</option>
      <option value="Savings" ${category === 'Savings' ? 'selected' : ''}>Savings</option>
      <option value="Housing" ${category === 'Housing' ? 'selected' : ''}>Housing (25%)</option>
      <option value="Utilities" ${category === 'Utilities' ? 'selected' : ''}>Utilities</option>
      <option value="Transportation" ${category === 'Transportation' ? 'selected' : ''}>Transportation</option>
      <option value="Food" ${category === 'Food' ? 'selected' : ''}>Food</option>
      <option value="Personal" ${category === 'Personal' ? 'selected' : ''}>Personal</option>
      <option value="Lifestyle" ${category === 'Lifestyle' ? 'selected' : ''}>Lifestyle</option>
      <option value="Health" ${category === 'Health' ? 'selected' : ''}>Health</option>
      <option value="Insurance" ${category === 'Insurance' ? 'selected' : ''}>Insurance</option>
      <option value="Debt" ${category === 'Debt' ? 'selected' : ''}>Debt</option>
      <option value="Sinking Funds" ${category === 'Sinking Funds' ? 'selected' : ''}>Sinking Funds</option>
      <option value="Other" ${category === 'Other' ? 'selected' : ''}>Other</option>
    </select>
    <input type="text" value="${name}" placeholder="Bill Name" onchange="calculateBudget()">
  `;
  
  // Budgeted cell
  const budgetedCell = row.insertCell();
  budgetedCell.innerHTML = `<input type="number" value="${budgeted}" onchange="calculateBudget()">`;
  
  // Spent cell
  const spentCell = row.insertCell();
  spentCell.innerHTML = `<input type="number" onchange="calculateBudget()">`;
  
  // Remaining cell
  const remainingCell = row.insertCell();
  remainingCell.innerHTML = `<input type="number" readonly>`;
  
  // Due Date cell
  const dueDateCell = row.insertCell();
  dueDateCell.innerHTML = `<input type="date" value="${dueDate}" onchange="calculateBudget()">`;
  
  // Paid From cell
  const paidFromCell = row.insertCell();
  paidFromCell.innerHTML = `<input type="text" placeholder="Income Source">`;
  
  // Remove cell
  const removeCell = row.insertCell();
  removeCell.innerHTML = `<button onclick="this.closest('tr').remove(); calculateBudget()">‚ùå</button>`;
  
  calculateBudget();
}

function updatePaidFromDropdowns() {
  const sources = Array.from(document.querySelectorAll("#incomeTable tbody tr")).map(
    row => row.cells[0].querySelector("input").value.trim()
  ).filter(Boolean);

  document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
    const select = row.cells[6].querySelector("select");
    const currentSelected = select.value || select.querySelector("option")?.innerText || "";
    select.innerHTML = sources.map(source =>
      `<option value="${source}" ${source === currentSelected ? "selected" : ""}>${source}</option>`).join("");
  });
}

function calculateBudget() {
  let incomeTotal = 0, budgetedTotal = 0, spentTotal = 0, paidTotal = 0;
  const incomeMap = {};

  const incomeRows = document.querySelectorAll("#incomeTable tbody tr");
  incomeRows.forEach((row, i) => {
    const name = row.cells[0].querySelector("input").value.trim();
    const amount = parseFloat(row.cells[1].querySelector("input").value) || 0;
    incomeTotal += amount;
    if (name) incomeMap[name] = { amount, spent: 0, rowIndex: i };
  });

  document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
    const budgeted = parseFloat(row.cells[2].querySelector("input").value) || 0;
    const spent = parseFloat(row.cells[3].querySelector("input").value) || 0;
    const paid = row.cells[0].querySelector("input").checked;
    const paidFrom = row.cells[6].querySelector("select").value;
    const remaining = budgeted - spent;

    budgetedTotal += budgeted;
    spentTotal += spent;
    if (paid) paidTotal += spent;

    if (paidFrom && incomeMap[paidFrom]) {
      incomeMap[paidFrom].spent += budgeted;
    }

    row.style.backgroundColor = paid ? "#e6f7e6" : "white";
    row.cells[4].innerText = `$${remaining.toFixed(2)}`;
  });

  const remaining = incomeTotal - budgetedTotal;
  document.getElementById("tileIncome").innerText = `Total Income: $${incomeTotal.toFixed(2)}`;
  document.getElementById("tileBudgeted").innerText = `Budgeted: $${budgetedTotal.toFixed(2)}`;
  document.getElementById("tileSpent").innerText = `Spent: $${spentTotal.toFixed(2)}`;
  document.getElementById("tileRemaining").innerText = `Remaining: $${remaining.toFixed(2)}`;
  document.getElementById("tilePaid").innerText = `Paid: $${paidTotal.toFixed(2)}`;

  // Add visual feedback for remaining amount
  const remainingElement = document.getElementById("tileRemaining");
  remainingElement.style.color = remaining < 0 ? "#dc3545" : remaining > 0 ? "#28a745" : "#007bff";
  remainingElement.style.fontWeight = remaining !== 0 ? "bold" : "normal";

  document.getElementById("zeroBasedMessage").style.display = (incomeTotal > 0 && incomeTotal === budgetedTotal) ? "block" : "none";
}

async function saveBudget() {
  const loadingIndicator = document.getElementById("loadingIndicator");
  loadingIndicator.style.display = "block";
  try {
    const budgetData = {
      income: Array.from(document.querySelectorAll("#incomeTable tbody tr")).map(row => ({
        source: row.cells[0].querySelector("input").value,
        amount: parseFloat(row.cells[1].querySelector("input").value) || 0
      })),
      expenses: Array.from(document.querySelectorAll("#expenseTable tbody tr")).map(row => ({
        category: row.cells[1].querySelector("select").value,
        budgeted: parseFloat(row.cells[2].querySelector("input").value) || 0,
        spent: parseFloat(row.cells[3].querySelector("input").value) || 0,
        due: row.cells[5].querySelector("input").value,
        paid: row.cells[0].querySelector("input").checked,
        source: row.cells[6].querySelector("select").value
      })),
      notes: document.getElementById("monthlyNotes").value,
      month: document.getElementById("month").value
    };
    await db.collection("budgets").doc(userId).set(budgetData);
    document.getElementById("savePopup").style.display = "block";
    setTimeout(() => document.getElementById("savePopup").style.display = "none", 2000);
  } catch (error) {
    alert("Error saving budget: " + error.message);
  } finally {
    loadingIndicator.style.display = "none";
  }
}

async function loadBudget() {
  const loadingIndicator = document.getElementById("loadingIndicator");
  loadingIndicator.style.display = "block";
  
  try {
    console.log('Loading budget data from Firebase for user:', userId);
    const doc = await db.collection("budgets").doc(userId).get();
    
    if (doc.exists) {
      const data = doc.data();
      console.log('Budget data loaded successfully:', data);
      
      document.getElementById("month").value = data.month || "";
      document.getElementById("monthlyNotes").value = data.notes || "";
      document.querySelector("#incomeTable tbody").innerHTML = "";
      document.querySelector("#expenseTable tbody").innerHTML = "";
      data.income.forEach(inc => addIncome(inc.source, inc.amount));
      data.expenses.forEach(exp => addExpense(exp.category, exp.name, exp.budgeted, exp.due));
      calculateBudget();
      
      // Show success message
      if (window.ErrorHandler) {
        window.ErrorHandler.showSuccess('Budget data loaded successfully from Firebase!');
      }
    } else {
      console.log('No budget data found for user:', userId);
      if (window.ErrorHandler) {
        window.ErrorHandler.showWarning('No budget data found. Start by adding income and expenses.');
      }
    }
  } catch (error) {
    console.error('Error loading budget from Firebase:', error);
    if (window.ErrorHandler) {
      window.ErrorHandler.handleFirebaseError(error);
    } else {
      alert("Error loading budget: " + error.message);
    }
  } finally {
    loadingIndicator.style.display = "none";
  }
}

function prefillSpent() {
  prefillBackup = Array.from(document.querySelectorAll("#expenseTable tbody tr")).map(row =>
    row.cells[3].querySelector("input").value
  );
  document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
    const budgeted = parseFloat(row.cells[2].querySelector("input").value) || 0;
    row.cells[3].querySelector("input").value = budgeted;
  });
  calculateBudget();
}

function undoPrefill() {
  if (!prefillBackup.length) return alert("‚ö†Ô∏è No prefill action to undo!");
  document.querySelectorAll("#expenseTable tbody tr").forEach((row, i) => {
    const spentInput = row.cells[3].querySelector("input");
    if (spentInput) {
      spentInput.value = prefillBackup[i] || 0;
    }
  });
  prefillBackup = [];
  calculateBudget();
}

function checkAll(box) {
  const checked = box.checked;
  document.querySelectorAll("#expenseTable tbody tr input[type='checkbox']").forEach(cb => cb.checked = checked);
}

function zeroBasedBudget() {
  calculateBudget();
  const incomeTotal = parseFloat(document.getElementById("tileIncome").innerText.replace(/[^0-9.-]+/g, ""));
  const budgetedTotal = parseFloat(document.getElementById("tileBudgeted").innerText.replace(/[^0-9.-]+/g, ""));
  const remaining = incomeTotal - budgetedTotal;

  if (incomeTotal === 0) {
    alert("‚ö†Ô∏è Please add some income first!");
    return;
  }

  if (remaining === 0) {
    alert("‚úÖ Perfect! Your budget is already zero-based!");
    return;
  }

  if (remaining > 0) {
    alert(`You have $${remaining.toFixed(2)} remaining to allocate to your budget.`);
  } else {
    alert(`You are over budget by $${Math.abs(remaining).toFixed(2)}.`);
  }
}

function validateInput(input) {
  if (input.value < 0) {
    alert("Please enter a positive number.");
    input.value = 0;
  }
}

document.querySelectorAll("#incomeTable input[type='number']").forEach(input => {
  input.addEventListener("blur", () => validateInput(input));
});

document.querySelectorAll("#expenseTable input[type='number']").forEach(input => {
  input.addEventListener("blur", () => validateInput(input));
});

function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
  const isDarkMode = document.body.classList.contains("dark-mode");
  localStorage.setItem("darkMode", isDarkMode);
}

if (localStorage.getItem("darkMode") === "true") {
  document.body.classList.add("dark-mode");
}

function confirmDelete(button) {
  if (confirm("Are you sure you want to delete this entry?")) {
    button.closest('tr').remove();
    calculateBudget();
  }
}

function exportBudgetToCSV() {
  const incomeRows = document.querySelectorAll("#incomeTable tbody tr");
  const expenseRows = document.querySelectorAll("#expenseTable tbody tr");
  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Income Source,Amount\n";
  incomeRows.forEach(row => {
    const source = row.cells[0].querySelector("input").value;
    const amount = row.cells[1].querySelector("input").value;
    csvContent += `${source},${amount}\n`;
  });
  csvContent += "\nExpense Category,Budgeted,Spent,Due Date,Paid From\n";
  expenseRows.forEach(row => {
    const category = row.cells[1].querySelector("select").value;
    const budgeted = row.cells[2].querySelector("input").value;
    const spent = row.cells[3].querySelector("input").value;
    const due = row.cells[5].querySelector("input").value;
    const paidFrom = row.cells[6].querySelector("select").value;
    csvContent += `${category},${budgeted},${spent},${due},${paidFrom}\n`;
  });
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "budget_data.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function importBudgetFromCSV() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".csv";
  input.onchange = function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const lines = text.split("\n");
      document.querySelector("#incomeTable tbody").innerHTML = "";
      document.querySelector("#expenseTable tbody").innerHTML = "";
      let isIncome = true;
      lines.forEach(line => {
        if (line.trim() === "") {
          isIncome = false;
          return;
        }
        const [col1, col2, col3, col4, col5] = line.split(",");
        if (isIncome) {
          addIncome(col1, col2);
        } else {
          addExpense({ category: col1, budgeted: col2, spent: col3, due: col4, source: col5 });
        }
      });
      calculateBudget();
    };
    reader.readAsText(file);
  };
  input.click();
}

function saveAsTemplate() {
  const template = {
    name: prompt("Enter a name for this template:"),
    date: new Date().toISOString(),
    income: [],
    expenses: []
  };

  // Save income sources
  document.querySelectorAll("#incomeTable tbody tr").forEach(row => {
    template.income.push({
      source: row.cells[0].querySelector("input").value,
      amount: parseFloat(row.cells[1].querySelector("input").value) || 0
    });
  });

  // Save expenses
  document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
    template.expenses.push({
      category: row.cells[1].querySelector("select").value,
      name: row.cells[1].querySelector("input").value,
      budgeted: parseFloat(row.cells[2].querySelector("input").value) || 0,
      dueDate: row.cells[5].querySelector("input").value
    });
  });

  // Save to Firebase
  const user = firebase.auth().currentUser;
  if (user) {
    firebase.firestore().collection('users').doc(user.uid)
      .collection('budgetTemplates').add(template)
      .then(() => {
        alert("Template saved successfully!");
      })
      .catch(error => {
        console.error("Error saving template:", error);
        alert("Error saving template. Please try again.");
      });
  } else {
    alert("Please sign in to save templates.");
  }
}

function loadTemplate() {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert("Please sign in to load templates.");
    return;
  }

  firebase.firestore().collection('users').doc(user.uid)
    .collection('budgetTemplates').get()
    .then(snapshot => {
      const templates = [];
      snapshot.forEach(doc => {
        templates.push({ id: doc.id, ...doc.data() });
      });

      if (templates.length === 0) {
        alert("No templates found.");
        return;
      }

      const templateList = templates.map((t, i) => 
        `${i + 1}. ${t.name} (${new Date(t.date).toLocaleDateString()})`
      ).join('\n');

      const choice = prompt(`Select a template (1-${templates.length}):\n${templateList}`);
      const index = parseInt(choice) - 1;

      if (isNaN(index) || index < 0 || index >= templates.length) {
        alert("Invalid selection.");
        return;
      }

      const template = templates[index];
      
      // Clear existing data
      document.querySelector("#incomeTable tbody").innerHTML = "";
      document.querySelector("#expenseTable tbody").innerHTML = "";

      // Load income sources
      template.income.forEach(income => {
        addIncome(income.source, income.amount);
      });

      // Load expenses
      template.expenses.forEach(expense => {
        addExpense(expense.category, expense.name, expense.budgeted, expense.dueDate);
      });

      calculateBudget();
      alert("Template loaded successfully!");
    })
    .catch(error => {
      console.error("Error loading templates:", error);
      alert("Error loading templates. Please try again.");
    });
}

function filterByCategory() {
  const category = document.getElementById("categoryFilter").value;
  const rows = document.querySelectorAll("#expenseTable tbody tr");

  rows.forEach(row => {
    const rowCategory = row.cells[1].querySelector("select").value;
    row.style.display = !category || rowCategory === category ? "" : "none";
  });
}

function updateExpenseCategory(select) {
  const row = select.closest('tr');
  const nameInput = row.cells[1].querySelector('input[type="text"]');
  nameInput.value = select.value;
}

// Add new functions for enhanced features
function initializeCharts() {
  // Budget Overview Chart
  const ctx = document.getElementById('budgetChart').getContext('2d');
  window.budgetChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Income', 'Expenses', 'Remaining'],
      datasets: [{
        data: [0, 0, 0],
        backgroundColor: ['#28a745', '#dc3545', '#007bff']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // Category Chart
  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  window.categoryChart = new Chart(categoryCtx, {
    type: 'pie',
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: [
          '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1',
          '#17a2b8', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // Monthly Chart
  const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
  window.monthlyChart = new Chart(monthlyCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'Income',
        data: [],
        backgroundColor: '#28a745'
      }, {
        label: 'Expenses',
        data: [],
        backgroundColor: '#dc3545'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

function updateChart() {
  const income = parseFloat(document.getElementById('tileIncome').innerText.replace(/[^0-9.-]+/g, ''));
  const spent = parseFloat(document.getElementById('tileSpent').innerText.replace(/[^0-9.-]+/g, ''));
  const remaining = parseFloat(document.getElementById('tileRemaining').innerText.replace(/[^0-9.-]+/g, ''));

  window.budgetChart.data.datasets[0].data = [income, spent, remaining];
  window.budgetChart.update();
}

function updateCharts() {
  // Update Category Chart
  const categoryData = {};
  document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
    const category = row.cells[1].querySelector("select").value;
    const amount = parseFloat(row.cells[2].querySelector("input").value) || 0;
    categoryData[category] = (categoryData[category] || 0) + amount;
  });

  window.categoryChart.data.labels = Object.keys(categoryData);
  window.categoryChart.data.datasets[0].data = Object.values(categoryData);
  window.categoryChart.update();

  // Update Monthly Chart
  // This would typically load historical data from Firebase
  // For now, we'll just show current month
  const incomeTotal = parseFloat(document.getElementById("tileIncome").innerText.replace(/[^0-9.-]+/g, ""));
  const spentTotal = parseFloat(document.getElementById("tileSpent").innerText.replace(/[^0-9.-]+/g, ""));

  window.monthlyChart.data.labels = [document.getElementById("month").value];
  window.monthlyChart.data.datasets[0].data = [incomeTotal];
  window.monthlyChart.data.datasets[1].data = [spentTotal];
  window.monthlyChart.update();
}

function checkDueDates() {
  const today = new Date();
  const reminders = [];
  
  document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
    const dueDate = new Date(row.cells[5].querySelector("input").value);
    const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
    const amount = parseFloat(row.cells[2].querySelector("input").value) || 0;
    const name = row.cells[1].querySelector("input").value;

    if (daysUntilDue <= 7 && daysUntilDue >= 0) {
      reminders.push({
        type: 'due-soon',
        message: `${name} is due in ${daysUntilDue} days ($${amount})`
      });
    } else if (daysUntilDue < 0) {
      reminders.push({
        type: 'overdue',
        message: `${name} is overdue by ${Math.abs(daysUntilDue)} days ($${amount})`
      });
    }
  });

  const remindersContainer = document.getElementById('dueDateReminders');
  remindersContainer.innerHTML = reminders.length ? 
    reminders.map(r => `<div class="reminder ${r.type}">${r.message}</div>`).join('') :
    '<p>No upcoming due dates</p>';
}

function detectRecurringExpenses() {
  const expenses = {};
  document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
    const name = row.cells[1].querySelector("input").value;
    const amount = parseFloat(row.cells[2].querySelector("input").value) || 0;
    const key = `${name}-${amount}`;
    expenses[key] = (expenses[key] || 0) + 1;
  });

  const recurringContainer = document.getElementById('recurringExpenses');
  const recurring = Object.entries(expenses)
    .filter(([_, count]) => count > 1)
    .map(([key]) => {
      const [name, amount] = key.split('-');
      return `<div class="reminder">Recurring expense detected: ${name} ($${amount})</div>`;
    });

  recurringContainer.innerHTML = recurring.length ? 
    recurring.join('') :
    '<p>No recurring expenses detected</p>';
}

function validateZeroBasedBudget() {
  const income = parseFloat(document.getElementById('tileIncome').innerText.replace(/[^0-9.-]+/g, ''));
  const budgeted = parseFloat(document.getElementById('tileBudgeted').innerText.replace(/[^0-9.-]+/g, ''));
  const remaining = parseFloat(document.getElementById('tileRemaining').innerText.replace(/[^0-9.-]+/g, ''));
  
  if (Math.abs(remaining) > 0.01) { // Using 0.01 to account for floating point precision
    alert(`Your budget is not zero-based! You have $${remaining.toFixed(2)} remaining to allocate.`);
    return false;
  }
  return true;
}

function checkCategoryPercentages() {
  const income = parseFloat(document.getElementById('tileIncome').innerText.replace(/[^0-9.-]+/g, ''));
  const categoryTotals = {};
  
  document.querySelectorAll("#expenseTable tbody tr").forEach(row => {
    const category = row.cells[1].querySelector("select").value;
    const amount = parseFloat(row.cells[2].querySelector("input").value) || 0;
    categoryTotals[category] = (categoryTotals[category] || 0) + amount;
  });

  const recommendations = [];
  
  // Check giving (10%)
  if (categoryTotals['Giving']) {
    const givingPercentage = (categoryTotals['Giving'] / income) * 100;
    if (givingPercentage < 10) {
      recommendations.push(`Consider increasing your giving to reach 10% (currently ${givingPercentage.toFixed(1)}%)`);
    }
  }

  // Check housing (25%)
  if (categoryTotals['Housing']) {
    const housingPercentage = (categoryTotals['Housing'] / income) * 100;
    if (housingPercentage > 25) {
      recommendations.push(`Your housing costs (${housingPercentage.toFixed(1)}%) exceed the recommended 25%`);
    }
  }

  // Check food (10-15%)
  if (categoryTotals['Food']) {
    const foodPercentage = (categoryTotals['Food'] / income) * 100;
    if (foodPercentage > 15) {
      recommendations.push(`Your food budget (${foodPercentage.toFixed(1)}%) exceeds the recommended 15%`);
    }
  }

  // Check transportation (10-15%)
  if (categoryTotals['Transportation']) {
    const transportPercentage = (categoryTotals['Transportation'] / income) * 100;
    if (transportPercentage > 15) {
      recommendations.push(`Your transportation costs (${transportPercentage.toFixed(1)}%) exceed the recommended 15%`);
    }
  }

  // Check utilities (5-10%)
  if (categoryTotals['Utilities']) {
    const utilitiesPercentage = (categoryTotals['Utilities'] / income) * 100;
    if (utilitiesPercentage > 10) {
      recommendations.push(`Your utilities costs (${utilitiesPercentage.toFixed(1)}%) exceed the recommended 10%`);
    }
  }

  // Check health (5-10%)
  if (categoryTotals['Health']) {
    const healthPercentage = (categoryTotals['Health'] / income) * 100;
    if (healthPercentage > 10) {
      recommendations.push(`Your health costs (${healthPercentage.toFixed(1)}%) exceed the recommended 10%`);
    }
  }

  // Check personal (5-10%)
  if (categoryTotals['Personal']) {
    const personalPercentage = (categoryTotals['Personal'] / income) * 100;
    if (personalPercentage > 10) {
      recommendations.push(`Your personal expenses (${personalPercentage.toFixed(1)}%) exceed the recommended 10%`);
    }
  }

  // Check lifestyle (5-10%)
  if (categoryTotals['Lifestyle']) {
    const lifestylePercentage = (categoryTotals['Lifestyle'] / income) * 100;
    if (lifestylePercentage > 10) {
      recommendations.push(`Your lifestyle expenses (${lifestylePercentage.toFixed(1)}%) exceed the recommended 10%`);
    }
  }

  // Check insurance (10-25%)
  if (categoryTotals['Insurance']) {
    const insurancePercentage = (categoryTotals['Insurance'] / income) * 100;
    if (insurancePercentage > 25) {
      recommendations.push(`Your insurance costs (${insurancePercentage.toFixed(1)}%) exceed the recommended 25%`);
    }
  }

  // Check savings (10-15%)
  if (categoryTotals['Savings']) {
    const savingsPercentage = (categoryTotals['Savings'] / income) * 100;
    if (savingsPercentage < 10) {
      recommendations.push(`Consider increasing your savings to reach 10% (currently ${savingsPercentage.toFixed(1)}%)`);
    }
  }

  // Update recommendations in the UI
  const recommendationsContainer = document.getElementById('budgetRecommendations');
  if (recommendations.length > 0) {
    recommendationsContainer.innerHTML = recommendations.map(rec => 
      `<div class="reminder">${rec}</div>`
    ).join('');
  } else {
    recommendationsContainer.innerHTML = '<div class="reminder">Your budget categories are well-balanced! üéâ</div>';
  }
}

// Update the calculateBudget function to include these checks
const originalCalculateBudget = calculateBudget;
calculateBudget = function() {
  originalCalculateBudget();
  updateChart();
  updateCharts();
  checkDueDates();
  detectRecurringExpenses();
  validateZeroBasedBudget();
  checkCategoryPercentages();
};

function toggleKeyboardShortcuts() {
  const shortcuts = document.getElementById('keyboardShortcuts');
  shortcuts.classList.toggle('show');
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey) {
    switch(e.key.toLowerCase()) {
      case 'i':
        e.preventDefault();
        addIncome();
        break;
      case 'e':
        e.preventDefault();
        addExpense();
        break;
      case 's':
        e.preventDefault();
        saveBudget();
        break;
      case 'l':
        e.preventDefault();
        loadBudget();
        break;
      case 'z':
        e.preventDefault();
        undoPrefill();
        break;
      case 'f':
        e.preventDefault();
        document.getElementById('categoryFilter').focus();
        break;
    }
  } else if (e.key === 'Escape') {
    document.getElementById('keyboardShortcuts').classList.remove('show');
  }
});

// Initialize charts when the page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeCharts();
  // Update chart whenever budget is calculated
  const originalCalculateBudget = calculateBudget;
  calculateBudget = function() {
    originalCalculateBudget();
    updateChart();
    updateCharts();
    checkDueDates();
    detectRecurringExpenses();
    validateZeroBasedBudget();
    checkCategoryPercentages();
  };
});
</script>

</body>
</html>
