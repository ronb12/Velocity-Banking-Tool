<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Load auth.js first before any scripts that use it -->
  <script type="module" src="../../../auth.js"></script>
  <script src="../../../utils/authHelper.js"></script>
  <script type="module" src="../../../sync.js"></script>
  <!-- Optional file removed -->
  
  <!-- PWA Scrolling Fix -->
  <script>
    if (window.matchMedia('(display-mode: standalone)').matches) {
      document.addEventListener('DOMContentLoaded', () => {
        document.body.style.overflow = 'auto';
        document.body.style.webkitOverflowScrolling = 'touch';
        document.documentElement.style.overflow = 'auto';
        document.documentElement.style.webkitOverflowScrolling = 'touch';
        document.body.style.overscrollBehavior = 'none';
        document.documentElement.style.overscrollBehavior = 'none';
        document.body.style.minHeight = '100vh';
        document.documentElement.style.height = '100%';
      });
    }
  </script>
  
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Net Worth Intelligence</title>
  <link rel="icon" type="image/x-icon" href="../../../favicon.ico"/>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      color-scheme: light;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    body {
      margin: 0;
      padding: 24px;
      background: linear-gradient(180deg, #f2f5ff 0%, #f6f8fb 60%, #ffffff 100%);
      color: #0f172a;
    }
    a.back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
      padding: 10px 18px;
      border-radius: 999px;
      transition: all 0.2s ease;
      font-weight: 600;
    }
    a.back-link:hover { background: rgba(59, 130, 246, 0.2); }

    .container {
      max-width: 1150px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: clamp(2.2rem, 3vw, 2.8rem);
      color: #0f172a;
      letter-spacing: -0.02em;
    }
    header p {
      margin: 0;
      font-size: 1rem;
      color: #475569;
    }

    .action-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .action-bar button {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 16px rgba(37, 99, 235, 0.25);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .action-bar button::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .action-bar button:hover::before {
      opacity: 1;
    }
    
    .action-bar button:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.35);
    }
    
    .action-bar button:active {
      transform: translateY(0);
      box-shadow: 0 2px 12px rgba(37, 99, 235, 0.25);
    }
    .ghost-button {
      background: rgba(15, 23, 42, 0.06) !important;
      color: #0f172a !important;
      border: 1px solid rgba(148, 163, 184, 0.25) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    .ghost-button:hover {
      background: rgba(15, 23, 42, 0.1) !important;
      border-color: rgba(148, 163, 184, 0.4) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
    }
    
    .ghost-button:active {
      transform: translateY(0) !important;
    }

    #saveStatus {
      font-size: 0.85rem;
      color: #059669;
      opacity: 0;
      transition: opacity 0.35s ease;
    }
    #saveStatus.show { opacity: 1; }

    .card {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.15);
      backdrop-filter: blur(10px);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }
    .summary-card h3 {
      margin: 0;
      font-size: 0.95rem;
      color: #64748b;
    }
    .summary-card .value {
      display: block;
      font-size: 1.9rem;
      font-weight: 700;
      margin-top: 6px;
      color: #0f172a;
    }
    .summary-card .meta {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #475569;
    }
    .summary-card.positive { border-left: 4px solid #22c55e; }
    .summary-card.warning { border-left: 4px solid #f59e0b; }
    .summary-card.danger { border-left: 4px solid #ef4444; }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .chart-card canvas { width: 100%; height: 260px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.95rem;
    }
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.22);
    }
    th {
      background: rgba(37, 99, 235, 0.08);
      color: #1d4ed8;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }
    td button {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      padding: 4px 8px;
      color: #dc2626;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
    }
    td button:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.4);
      color: #b91c1c;
      transform: scale(1.1);
    }
    td button:active {
      transform: scale(0.95);
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 9px 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: rgba(255, 255, 255, 0.9);
    }
    input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      outline: none;
    }

    .goals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .goal-card {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .progress-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #22d3ee);
      border-radius: inherit;
      transition: width 0.35s ease;
    }
    .goal-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #475569;
    }

    .ratio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .ratio-card {
      padding: 18px;
      background: rgba(15, 23, 42, 0.03);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ratio-card.positive { border-left: 4px solid #22c55e; }
    .ratio-card.warning { border-left: 4px solid #f59e0b; }
    .ratio-card.danger { border-left: 4px solid #ef4444; }
    .ratio-card strong { font-size: 1rem; }
    .ratio-card span { font-size: 0.85rem; color: #475569; }

    .alerts-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .alerts-list li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(248, 113, 113, 0.12);
      border: 1px solid rgba(248, 113, 113, 0.25);
      color: #b91c1c;
      font-size: 0.95rem;
    }
    .alerts-list li.warning {
      background: rgba(251, 191, 36, 0.12);
      border-color: rgba(251, 191, 36, 0.25);
      color: #b45309;
    }

    .scenario-manager {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .scenario-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .scenario-controls input {
      flex: 1 1 240px;
      max-width: 320px;
    }
    .scenario-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .scenario-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.03);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }
    .scenario-row span {
      font-weight: 600;
      color: #0f172a;
    }
    .scenario-actions {
      display: flex;
      gap: 8px;
    }
    .scenario-actions button {
      background: rgba(37, 99, 235, 0.1);
      color: #1d4ed8;
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid rgba(37, 99, 235, 0.2);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
    }
    .scenario-actions button:hover {
      background: rgba(37, 99, 235, 0.18);
      border-color: rgba(37, 99, 235, 0.35);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
    }
    .scenario-actions button:active {
      transform: translateY(0);
    }
    .scenario-actions button[data-action="delete"] {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border-color: rgba(239, 68, 68, 0.2);
    }
    .scenario-actions button[data-action="delete"]:hover {
      background: rgba(239, 68, 68, 0.18);
      border-color: rgba(239, 68, 68, 0.35);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
    }

    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      align-items: start;
    }
    .table-card h2 {
      margin: 0;
      font-size: 1.2rem;
      color: #0f172a;
    }
    .table-card .table-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }
    .table-card .table-actions button {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .table-card .table-actions button:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
    }
    
    .table-card .table-actions button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
    }

    #netWorthSummary {
      display: none; /* superseded by summary cards, retained for compatibility */
    }

    .modal-button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 8px;
    }
    
    .modal-button-grid button {
      position: relative;
      padding: 18px 24px;
      border: none;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .modal-button-grid button::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal-button-grid button:hover::before {
      opacity: 1;
    }
    
    .modal-button-grid button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .modal-button-grid button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    #openNetWorthModal {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
    }
    
    #openNetWorthModal:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.35);
    }
    
    #openAssetsModal {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
    }
    
    #openAssetsModal:hover {
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.35);
    }
    
    #openLiabilitiesModal {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    
    #openLiabilitiesModal:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      box-shadow: 0 8px 24px rgba(245, 158, 11, 0.35);
    }
    
    .modal-button-grid button span {
      font-size: 1.5rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .modal-shell {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-shell.show {
      display: flex;
    }

    .modal-panel {
      background: #ffffff;
      width: min(840px, 100%);
      max-height: 92vh;
      border-radius: 20px;
      box-shadow: 0 30px 80px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      padding: 24px 28px;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(99, 102, 241, 0.12));
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.6rem;
      color: #0f172a;
    }

    .modal-header p {
      margin: 6px 0 0;
      color: #475569;
    }

    .modal-header .close-modal {
      background: rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 999px;
      width: 38px;
      height: 38px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .modal-header .close-modal:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: #dc2626;
      transform: rotate(90deg) scale(1.1);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
    }
    
    .modal-header .close-modal:active {
      transform: rotate(90deg) scale(0.95);
    }

    .modal-body {
      padding: 24px 28px 32px;
      overflow-y: auto;
    }

    .modal-body canvas {
      max-height: 420px;
    }

    @media (max-width: 768px) {
      body { padding: 16px; }
      .charts-grid { grid-template-columns: 1fr; }
      .modal-panel { border-radius: 16px; }
      .modal-body { padding: 20px; }
      .modal-button-grid {
        grid-template-columns: 1fr;
      }
      .modal-button-grid button {
        padding: 16px 20px;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../../../index.html" class="back-link">‚Üê Back to Dashboard</a>

    <header>
      <h1>Net Worth Intelligence</h1>
      <p>Track every dollar you own, owe, and grow. Visualize progress, stress-test scenarios, and stay ahead of risk.</p>
      <div class="action-bar">
        <button id="saveButton">üíæ Save Net Worth</button>
        <button id="snapshotButton" class="ghost-button">üì∏ Capture Monthly Snapshot</button>
        <button id="infoButton" class="ghost-button">‚ÑπÔ∏è What is Net Worth?</button>
        <span id="saveStatus">Saved</span>
      </div>
    </header>

    <section class="summary-grid" id="summaryGrid"></section>

    <section class="card">
      <h2>üìä Net Worth Visuals</h2>
      <p style="margin:6px 0 18px;color:#475569;">Open rich visuals on demand to explore trends, allocations, and obligations in detail.</p>
      <div class="modal-button-grid">
        <button id="openNetWorthModal"><span>üìâ</span> View Net Worth Timeline</button>
        <button id="openAssetsModal"><span>üíº</span> View Asset Allocation</button>
        <button id="openLiabilitiesModal"><span>üí≥</span> View Liability Mix</button>
      </div>
    </section>

    <section class="card tables-grid">
      <div class="table-card">
    <h2>Assets</h2>
    <table id="assetsTable">
      <thead>
        <tr><th>Asset Name</th><th>Value ($)</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
        <div class="table-actions">
          <button data-add="assetsTable">+ Add Asset</button>
        </div>
      </div>
      <div class="table-card">
    <h2>Liabilities</h2>
    <table id="liabilitiesTable">
      <thead>
        <tr><th>Liability Name</th><th>Amount Owed ($)</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
        <div class="table-actions">
          <button data-add="liabilitiesTable">+ Add Liability</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>üéØ Net Worth Goals</h2>
      <p style="margin-top:6px;color:#475569;">Set milestone targets and watch your progress bars fill as your net worth advances.</p>
      <div class="goals-grid" id="goalsList"></div>
      <div class="action-bar" style="margin-top:16px;">
        <button id="saveGoalsBtn" class="ghost-button">üìù Save Goal Targets</button>
      </div>
    </section>

    <section class="card">
      <h2>üìà Financial Health Ratios</h2>
      <p style="margin:6px 0 18px;color:#475569;">Key diagnostic metrics and their status so you know where to focus next.</p>
      <div class="ratio-grid" id="ratioGrid"></div>
    </section>

    <section class="card">
      <h2>‚ö†Ô∏è Proactive Alerts</h2>
      <p style="margin:6px 0 18px;color:#475569;">Early warnings when cash buffers thin out, liabilities surge, or goals drift off-track.</p>
      <ul class="alerts-list" id="alertsList"></ul>
    </section>

    <section class="card scenario-manager">
      <h2>üìÇ Scenario Manager</h2>
      <p style="margin:6px 0 0;color:#475569;">Save alternate plans (baseline vs. stretch vs. conservative) and compare outcomes instantly.</p>
      <div class="scenario-controls">
        <input id="scenarioName" type="text" placeholder="e.g., Aggressive Growth 2026"/>
        <button id="saveScenarioBtn" class="ghost-button">üíæ Save Scenario</button>
        <button id="clearScenariosBtn" class="ghost-button">üóëÔ∏è Clear All</button>
      </div>
      <div class="scenario-list" id="scenarioList"></div>
    </section>

    <div id="netWorthSummary">Net Worth: $0.00</div>
    <div id="netWorthModal" class="modal-shell" role="dialog" aria-modal="true" aria-labelledby="netWorthModalTitle">
      <div class="modal-panel">
        <div class="modal-header">
          <div>
            <h2 id="netWorthModalTitle">Net Worth Timeline</h2>
            <p>Month-over-month progress paired with milestone callouts.</p>
          </div>
          <button class="close-modal" data-close="netWorthModal" title="Close">‚úï</button>
        </div>
        <div class="modal-body">
          <canvas id="netWorthModalChart"></canvas>
        </div>
      </div>
    </div>

    <div id="assetsModal" class="modal-shell" role="dialog" aria-modal="true" aria-labelledby="assetsModalTitle">
      <div class="modal-panel">
        <div class="modal-header">
          <div>
            <h2 id="assetsModalTitle">Asset Allocation</h2>
            <p>See how your assets distribute across cash, investments, and property.</p>
          </div>
          <button class="close-modal" data-close="assetsModal" title="Close">‚úï</button>
        </div>
        <div class="modal-body">
          <canvas id="assetsModalChart"></canvas>
        </div>
      </div>
    </div>

    <div id="liabilitiesModal" class="modal-shell" role="dialog" aria-modal="true" aria-labelledby="liabilitiesModalTitle">
      <div class="modal-panel">
        <div class="modal-header">
          <div>
            <h2 id="liabilitiesModalTitle">Liability Mix</h2>
            <p>Understand the makeup of your commitments and where debt reduction matters most.</p>
          </div>
          <button class="close-modal" data-close="liabilitiesModal" title="Close">‚úï</button>
        </div>
        <div class="modal-body">
          <canvas id="liabilitiesModalChart"></canvas>
        </div>
      </div>
    </div>

    <div id="infoModal" class="modal-shell" role="dialog" aria-modal="true" aria-labelledby="infoModalTitle">
      <div class="modal-panel" style="max-width: 700px;">
        <div class="modal-header">
          <div>
            <h2 id="infoModalTitle">Understanding Net Worth, Assets & Liabilities</h2>
            <p>A simple guide to financial fundamentals</p>
          </div>
          <button class="close-modal" data-close="infoModal" title="Close">‚úï</button>
        </div>
        <div class="modal-body" style="line-height: 1.7;">
          <div style="margin-bottom: 28px;">
            <h3 style="color: #2563eb; margin-top: 0; margin-bottom: 12px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
              <span>üí∞</span> What is Net Worth?
            </h3>
            <p style="margin: 0 0 16px 0; color: #334155;">
              <strong>Net Worth</strong> is the total value of everything you own (assets) minus everything you owe (liabilities). It's a snapshot of your financial health at any given moment.
            </p>
            <div style="background: rgba(37, 99, 235, 0.08); padding: 16px; border-radius: 12px; border-left: 4px solid #2563eb; margin: 16px 0;">
              <p style="margin: 0; font-weight: 600; color: #1e293b;">Formula:</p>
              <p style="margin: 8px 0 0 0; font-size: 1.1rem; color: #0f172a;">
                <strong>Net Worth = Assets - Liabilities</strong>
              </p>
            </div>
            <p style="margin: 16px 0 0 0; color: #64748b; font-size: 0.95rem;">
              A positive net worth means you own more than you owe. A negative net worth means you owe more than you own.
            </p>
          </div>

          <div style="margin-bottom: 28px; padding-top: 24px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
            <h3 style="color: #22c55e; margin-top: 0; margin-bottom: 12px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
              <span>üíº</span> What are Assets?
            </h3>
            <p style="margin: 0 0 16px 0; color: #334155;">
              <strong>Assets</strong> are things you own that have value. They can be sold or used to generate income.
            </p>
            <div style="background: rgba(34, 197, 94, 0.08); padding: 16px; border-radius: 12px; margin: 16px 0;">
              <p style="margin: 0 0 12px 0; font-weight: 600; color: #1e293b;">Common Examples:</p>
              <ul style="margin: 0; padding-left: 24px; color: #334155;">
                <li><strong>Cash & Savings:</strong> Checking accounts, savings accounts, money market accounts</li>
                <li><strong>Investments:</strong> Stocks, bonds, mutual funds, retirement accounts (401k, IRA)</li>
                <li><strong>Real Estate:</strong> Your home, rental properties, land</li>
                <li><strong>Vehicles:</strong> Cars, motorcycles, boats (current market value)</li>
                <li><strong>Personal Property:</strong> Jewelry, collectibles, valuable items</li>
                <li><strong>Business Assets:</strong> If you own a business, its value</li>
              </ul>
            </div>
            <p style="margin: 16px 0 0 0; color: #64748b; font-size: 0.95rem;">
              üí° <strong>Tip:</strong> Use current market values, not what you paid. Your car is worth what you could sell it for today, not what you bought it for.
            </p>
          </div>

          <div style="margin-bottom: 20px; padding-top: 24px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
            <h3 style="color: #f59e0b; margin-top: 0; margin-bottom: 12px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
              <span>üí≥</span> What are Liabilities?
            </h3>
            <p style="margin: 0 0 16px 0; color: #334155;">
              <strong>Liabilities</strong> are debts and obligations you owe to others. They reduce your net worth.
            </p>
            <div style="background: rgba(245, 158, 11, 0.08); padding: 16px; border-radius: 12px; margin: 16px 0;">
              <p style="margin: 0 0 12px 0; font-weight: 600; color: #1e293b;">Common Examples:</p>
              <ul style="margin: 0; padding-left: 24px; color: #334155;">
                <li><strong>Mortgages:</strong> Home loans, home equity loans</li>
                <li><strong>Auto Loans:</strong> Car loans, motorcycle loans</li>
                <li><strong>Credit Card Debt:</strong> Outstanding balances on credit cards</li>
                <li><strong>Student Loans:</strong> Education debt</li>
                <li><strong>Personal Loans:</strong> Unsecured loans from banks or lenders</li>
                <li><strong>Other Debts:</strong> Medical bills, tax debt, money owed to family/friends</li>
              </ul>
            </div>
            <p style="margin: 16px 0 0 0; color: #64748b; font-size: 0.95rem;">
              üí° <strong>Tip:</strong> List the current balance you owe, not the original loan amount. As you pay down debt, your liabilities decrease.
            </p>
          </div>

          <div style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(34, 197, 94, 0.1)); padding: 20px; border-radius: 12px; border: 2px solid rgba(37, 99, 235, 0.2); margin-top: 28px;">
            <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 1.1rem;">üìä Example Calculation:</h4>
            <div style="background: white; padding: 16px; border-radius: 8px; margin: 12px 0;">
              <p style="margin: 0 0 8px 0; color: #334155;"><strong>Assets:</strong></p>
              <ul style="margin: 0 0 16px 0; padding-left: 24px; color: #475569;">
                <li>Savings: $10,000</li>
                <li>401k: $50,000</li>
                <li>Home Value: $200,000</li>
                <li><strong>Total Assets: $260,000</strong></li>
              </ul>
              <p style="margin: 16px 0 8px 0; color: #334155;"><strong>Liabilities:</strong></p>
              <ul style="margin: 0 0 16px 0; padding-left: 24px; color: #475569;">
                <li>Mortgage: $150,000</li>
                <li>Car Loan: $8,000</li>
                <li>Credit Cards: $2,000</li>
                <li><strong>Total Liabilities: $160,000</strong></li>
              </ul>
              <div style="border-top: 2px solid #2563eb; padding-top: 12px; margin-top: 12px;">
                <p style="margin: 0; font-size: 1.2rem; font-weight: 700; color: #2563eb;">
                  Net Worth = $260,000 - $160,000 = <strong>$100,000</strong>
                </p>
              </div>
            </div>
          </div>

          <div style="margin-top: 24px; padding: 16px; background: rgba(15, 23, 42, 0.04); border-radius: 12px; border-left: 4px solid #2563eb;">
            <p style="margin: 0; color: #334155; font-size: 0.95rem;">
              <strong>Why Track Net Worth?</strong> Monitoring your net worth over time helps you see if you're building wealth or falling behind. It's the most important number for measuring your financial progress!
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
      authDomain: "mobile-debt-tracker.firebaseapp.com",
      projectId: "mobile-debt-tracker"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const IS_LOCALHOST = ['localhost', '127.0.0.1'].includes(window.location.hostname);

    const elements = {
      summaryGrid: document.getElementById('summaryGrid'),
      goalsList: document.getElementById('goalsList'),
      ratioGrid: document.getElementById('ratioGrid'),
      alertsList: document.getElementById('alertsList'),
      scenarioName: document.getElementById('scenarioName'),
      scenarioList: document.getElementById('scenarioList'),
      saveStatus: document.getElementById('saveStatus'),
      assetsTableBody: document.querySelector('#assetsTable tbody'),
      liabilitiesTableBody: document.querySelector('#liabilitiesTable tbody'),
      netWorthSummary: document.getElementById('netWorthSummary'),
      netWorthModal: document.getElementById('netWorthModal'),
      assetsModal: document.getElementById('assetsModal'),
      liabilitiesModal: document.getElementById('liabilitiesModal'),
      netWorthModalCanvas: document.getElementById('netWorthModalChart'),
      assetsModalCanvas: document.getElementById('assetsModalChart'),
      liabilitiesModalCanvas: document.getElementById('liabilitiesModalChart'),
      openNetWorthButton: document.getElementById('openNetWorthModal'),
      openAssetsButton: document.getElementById('openAssetsModal'),
      openLiabilitiesButton: document.getElementById('openLiabilitiesModal'),
      infoButton: document.getElementById('infoButton'),
      infoModal: document.getElementById('infoModal')
    };

    const charts = {
      netWorth: null,
      assets: null,
      liabilities: null
    };

    let userId = '';
    let userEmail = '';

    const state = {
      assets: [],
      liabilities: [],
      history: [],
      goals: defaultGoals(),
      activityLogs: getActivityLogs(),
      lastSavedSnapshot: null,
      currentMetrics: null
    };

    const SAMPLE_NET_WORTH = generateSampleNetWorth();

    function defaultGoals() {
      return [
        { id: 'short', label: '12-Month Milestone', target: 25000, horizon: '12 months' },
        { id: 'mid', label: '3-Year Target', target: 80000, horizon: '36 months' },
        { id: 'long', label: 'Financial Independence', target: 250000, horizon: '5+ years' }
      ];
    }

    function generateSampleNetWorth() {
      const baseAssets = [
        { name: 'Checking Account', value: 12500 },
        { name: 'High-Yield Savings', value: 18500 },
        { name: '401(k) Retirement', value: 52000 },
        { name: 'Roth IRA', value: 14800 },
        { name: 'Brokerage Account', value: 21500 },
        { name: 'Primary Residence Equity', value: 98000 }
      ];
      const baseLiabilities = [
        { name: 'Mortgage Balance', value: 196500 },
        { name: 'Auto Loan', value: 12500 },
        { name: 'Student Loan', value: 18200 },
        { name: 'Credit Card Balance', value: 3200 }
      ];

      const history = [];
      const now = new Date();
      let netWorthBase = 35000;
      for (let i = 6; i >= 1; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const assetsGrowth = 2500 * (6 - i);
        const liabilitiesReduction = 1200 * (6 - i);
        const assets = baseAssets.reduce((sum, asset) => sum + asset.value, 0) + assetsGrowth;
        const liabilities = baseLiabilities.reduce((sum, liability) => sum + liability.value, 0) - liabilitiesReduction;
        const netWorth = assets - liabilities;
        history.push({
          date: date.toISOString(),
          netWorth,
          assets,
          liabilities
        });
        netWorthBase = netWorth;
      }

      return {
        assets: baseAssets,
        liabilities: baseLiabilities,
        history,
        goals: [
          { id: 'short', label: '12-Month Milestone', target: 45000, horizon: '12 months' },
          { id: 'mid', label: '3-Year Target', target: 95000, horizon: '36 months' },
          { id: 'long', label: 'Financial Independence', target: 300000, horizon: '5+ years' }
        ]
      };
    }

    function normalizeTimestamp(value) {
      if (!value) return null;
      if (typeof value === 'string') return value;
      if (value instanceof Date) return value.toISOString();
      if (typeof value === 'number') return new Date(value).toISOString();
      if (value.seconds) {
        // Firestore timestamp compat
        return new Date(value.seconds * 1000).toISOString();
      }
      try {
        return new Date(value).toISOString();
      } catch (error) {
        return null;
      }
    }

    function getLocalNetWorthData() {
      const embedded = (window.getLocalTestData && window.getLocalTestData('netWorth')) || window.LOCAL_TEST_DATA?.netWorth;
      if (embedded) {
        return JSON.parse(JSON.stringify(embedded));
      }
      try {
        const stored = localStorage.getItem('local_test_networth');
        return stored ? JSON.parse(stored) : null;
      } catch (error) {
        console.warn('Unable to read local net worth data:', error);
        return null;
      }
    }

    function persistLocalNetWorth(payload) {
      try {
        localStorage.setItem('local_test_networth', JSON.stringify(payload));
        localStorage.setItem('netWorth', JSON.stringify({ history: payload.history || [] }));
      } catch (error) {
        console.warn('Unable to persist local net worth data:', error);
      }
    }

    function getActivityLogs() {
      const logs = (window.getLocalTestData && window.getLocalTestData('activityLogs')) || window.LOCAL_TEST_DATA?.activityLogs;
      if (!logs) {
        try {
          const stored = localStorage.getItem('activityLogs');
          return stored ? JSON.parse(stored) : [];
        } catch (error) {
          return [];
        }
      }
      return Array.isArray(logs) ? JSON.parse(JSON.stringify(logs)) : [];
    }

    function showSaveStatus(message = 'Saved', tone = 'success') {
      if (!elements.saveStatus) return;
      elements.saveStatus.textContent = message;
      elements.saveStatus.style.color = tone === 'error' ? '#dc2626' : '#059669';
      elements.saveStatus.classList.add('show');
      setTimeout(() => elements.saveStatus.classList.remove('show'), 2600);
    }

    function formatCurrency(value) {
      const number = Number(value) || 0;
      return number.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    }

    function formatPercent(value) {
      if (value === Infinity || value === -Infinity) return '‚àû';
      return `${(value * 100).toFixed(1)}%`;
    }

    function formatMonth(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) return dateString;
      return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    }

    function sortHistory(history = []) {
      return [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function deriveEventMap() {
      const map = new Map();
      state.activityLogs.forEach(log => {
        const timestamp = normalizeTimestamp(log.timestamp);
        if (!timestamp) return;
        const month = timestamp.slice(0, 7);
        if (!map.has(month)) map.set(month, []);
        map.get(month).push(log);
      });
      return map;
    }

    function harvestTableData() {
      const assets = [];
      elements.assetsTableBody.querySelectorAll('tr').forEach(row => {
        const [nameInput, valueInput] = row.querySelectorAll('input');
        assets.push({
          name: nameInput?.value?.trim() || '',
          value: parseFloat(valueInput?.value) || 0
        });
      });
      const liabilities = [];
      elements.liabilitiesTableBody.querySelectorAll('tr').forEach(row => {
        const [nameInput, valueInput] = row.querySelectorAll('input');
        liabilities.push({
          name: nameInput?.value?.trim() || '',
          value: parseFloat(valueInput?.value) || 0
        });
      });
      state.assets = assets;
      state.liabilities = liabilities;
      return { assets, liabilities };
    }

    function calculateMetrics() {
      const { assets, liabilities } = harvestTableData();
      const totalAssets = assets.reduce((sum, item) => sum + (item.value || 0), 0);
      const totalLiabilities = liabilities.reduce((sum, item) => sum + (item.value || 0), 0);
      const netWorth = totalAssets - totalLiabilities;

      const liquidAssets = assets
        .filter(item => /cash|checking|savings|money market|mmf/i.test(item.name || ''))
        .reduce((sum, item) => sum + (item.value || 0), 0);
      const investmentAssets = assets
        .filter(item => /401|ira|roth|investment|brokerage|stock|etf|mutual/i.test(item.name || ''))
        .reduce((sum, item) => sum + (item.value || 0), 0);

      const debtToAssets = totalAssets > 0 ? totalLiabilities / totalAssets : 0;
      const liquidityCoverage = totalLiabilities > 0 ? liquidAssets / totalLiabilities : 0;
      const liquidToAssets = totalAssets > 0 ? liquidAssets / totalAssets : 0;
      const investmentShare = totalAssets > 0 ? investmentAssets / totalAssets : 0;

      const historySeries = buildHistorySeries(netWorth, totalAssets, totalLiabilities);
      const netChange = historySeries.length > 1
        ? historySeries[historySeries.length - 1].netWorth - historySeries[historySeries.length - 2].netWorth
        : 0;

      const metrics = {
        totalAssets,
        totalLiabilities,
        netWorth,
        liquidAssets,
        investmentAssets,
        debtToAssets,
        liquidityCoverage,
        liquidToAssets,
        investmentShare,
        historySeries,
        netChange
      };

      state.currentMetrics = metrics;
      elements.netWorthSummary.textContent = `Net Worth: ${formatCurrency(netWorth)}`;
      return metrics;
    }

    function buildHistorySeries(currentNetWorth, totalAssets, totalLiabilities) {
      const monthKey = new Date().toISOString().slice(0, 7);
      const baseHistory = Array.isArray(state.history) ? state.history : [];
      const filtered = baseHistory.filter(entry => entry && entry.date);
      const existingIndex = filtered.findIndex(entry => entry.date === monthKey);
      const enrichedEntry = {
        date: `${monthKey}-01`,
        netWorth: currentNetWorth,
        assets: totalAssets,
        liabilities: totalLiabilities
      };
      if (existingIndex >= 0) {
        filtered[existingIndex] = { ...filtered[existingIndex], ...enrichedEntry };
      } else {
        filtered.push(enrichedEntry);
      }
      return sortHistory(filtered);
    }

    function renderSummary(metrics) {
      const monthChangeClass = metrics.netChange >= 0 ? 'positive' : 'danger';
      const cards = [
        {
          title: 'Total Net Worth',
          value: formatCurrency(metrics.netWorth),
          meta: metrics.netChange >= 0
            ? `‚ñ≤ Up ${formatCurrency(metrics.netChange)} vs last month`
            : `‚ñº Down ${formatCurrency(Math.abs(metrics.netChange))} vs last month`,
          tone: metrics.netWorth >= 0 ? 'positive' : 'danger'
        },
        {
          title: 'Total Assets',
          value: formatCurrency(metrics.totalAssets),
          meta: `Liquid: ${formatCurrency(metrics.liquidAssets)} (${formatPercent(metrics.liquidToAssets)})`,
          tone: 'positive'
        },
        {
          title: 'Total Liabilities',
          value: formatCurrency(metrics.totalLiabilities),
          meta: `Debt-to-Assets: ${formatPercent(metrics.debtToAssets)}`,
          tone: metrics.debtToAssets > 0.6 ? 'danger' : metrics.debtToAssets > 0.45 ? 'warning' : 'positive'
        },
        {
          title: 'Monthly Movement',
          value: metrics.netChange >= 0 ? `+${formatCurrency(metrics.netChange)}` : `-${formatCurrency(Math.abs(metrics.netChange))}`,
          meta: metrics.netChange >= 0 ? 'Momentum is positive' : 'Monitor cash flow & liabilities',
          tone: monthChangeClass
        }
      ];

      elements.summaryGrid.innerHTML = cards.map(card => `
        <div class="card summary-card ${card.tone}">
          <h3>${card.title}</h3>
          <span class="value">${card.value}</span>
          <span class="meta">${card.meta}</span>
        </div>
      `).join('');
    }

    function createOrUpdateChart(chartRef, ctx, config) {
      if (!ctx) return null;
      if (chartRef) {
        chartRef.data = config.data;
        chartRef.options = config.options;
        chartRef.update('none');
        return chartRef;
      }
      return new Chart(ctx, config);
    }

    function renderCharts(metrics) {
      const labels = metrics.historySeries.map(entry => formatMonth(entry.date));
      const dataPoints = metrics.historySeries.map(entry => entry.netWorth);
      const eventMap = deriveEventMap();
      const events = metrics.historySeries
        .map((entry, idx) => {
          const monthKey = entry.date.slice(0, 7);
          const monthEvents = eventMap.get(monthKey);
          if (!monthEvents || !monthEvents.length) return null;
          return {
            x: labels[idx],
            y: entry.netWorth,
            events: monthEvents.map(ev => ev.text || ev.type || 'Event')
          };
        })
        .filter(Boolean);

      if (elements.netWorthModalCanvas) {
        const netWorthCtx = elements.netWorthModalCanvas.getContext('2d');
        charts.netWorth = createOrUpdateChart(charts.netWorth, netWorthCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Net Worth',
                data: dataPoints,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.12)',
                tension: 0.35,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              },
              {
                type: 'scatter',
                label: 'Milestones',
                data: events,
                backgroundColor: '#f97316',
                pointRadius: 5,
                pointHoverRadius: 7
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                ticks: { callback: value => formatCurrency(value) },
                grid: { color: 'rgba(148, 163, 184, 0.2)' }
              },
              x: { grid: { display: false } }
            },
            plugins: {
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: context => {
                    if (context.dataset.type === 'scatter') {
                      const events = context.raw.events || [];
                      return events.map(ev => `‚Ä¢ ${ev}`);
                    }
                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                  }
                }
              },
              legend: { display: false }
            }
          }
        });
      }

      const assetCtx = elements.assetsModalCanvas ? elements.assetsModalCanvas.getContext('2d') : null;
      const assetLabels = state.assets.filter(a => (a.value || 0) > 0).map(a => a.name || 'Unnamed Asset');
      const assetValues = state.assets.filter(a => (a.value || 0) > 0).map(a => a.value);
      if (assetCtx) {
        charts.assets = createOrUpdateChart(charts.assets, assetCtx, {
          type: 'doughnut',
          data: {
            labels: assetLabels.length ? assetLabels : ['No assets entered'],
            datasets: [{
              data: assetValues.length ? assetValues : [1],
              backgroundColor: ['#2563eb', '#22d3ee', '#38bdf8', '#9333ea', '#fb7185', '#f59e0b', '#34d399']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: context => `${context.label}: ${formatCurrency(context.parsed)}`
                }
              }
            }
          }
        });
      }

      const liabilityCtx = elements.liabilitiesModalCanvas ? elements.liabilitiesModalCanvas.getContext('2d') : null;
      const liabilityLabels = state.liabilities.filter(l => (l.value || 0) > 0).map(l => l.name || 'Unnamed Liability');
      const liabilityValues = state.liabilities.filter(l => (l.value || 0) > 0).map(l => l.value);
      if (liabilityCtx) {
        charts.liabilities = createOrUpdateChart(charts.liabilities, liabilityCtx, {
          type: 'doughnut',
          data: {
            labels: liabilityLabels.length ? liabilityLabels : ['No liabilities entered'],
            datasets: [{
              data: liabilityValues.length ? liabilityValues : [1],
              backgroundColor: ['#ef4444', '#f97316', '#facc15', '#fb7185', '#f87171', '#fbbf24', '#fcd34d']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: context => `${context.label}: ${formatCurrency(context.parsed)}`
                }
              }
            }
          }
        });
      }
    }

    function renderGoals(metrics) {
      const goalCards = state.goals.map(goal => {
        const progress = goal.target > 0 ? Math.min(metrics.netWorth / goal.target, 1) : 0;
        const status = progress >= 1 ? 'Completed' : `${(progress * 100).toFixed(1)}% to goal`;
        return `
          <div class="goal-card card">
            <div>
              <strong>${goal.label}</strong>
              <div style="font-size:0.85rem;color:#64748b;">Horizon: ${goal.horizon}</div>
            </div>
            <div class="goal-actions">
              <label for="goal-${goal.id}">Target</label>
              <input id="goal-${goal.id}" type="number" min="0" value="${goal.target}" />
            </div>
            <div class="progress-track">
              <div class="progress-fill" style="width:${progress * 100}%"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:#475569;">
              <span>Target: ${formatCurrency(goal.target)}</span>
              <span>${status}</span>
            </div>
          </div>
        `;
      }).join('');
      elements.goalsList.innerHTML = goalCards;
    }

    function renderRatios(metrics) {
      const items = [
        {
          label: 'Debt-to-Asset Ratio',
          value: formatPercent(metrics.debtToAssets),
          insight: metrics.debtToAssets <= 0.35
            ? 'Healthy leverage position'
            : metrics.debtToAssets <= 0.6
              ? 'Monitor large debts and prioritize paydowns'
              : 'High leverage ‚Äî consider aggressive debt reduction',
          tone: metrics.debtToAssets <= 0.35 ? 'positive' : metrics.debtToAssets <= 0.6 ? 'warning' : 'danger'
        },
        {
          label: 'Liquidity Coverage',
          value: formatPercent(metrics.liquidityCoverage),
          insight: metrics.liquidityCoverage >= 0.5
            ? 'Comfortable cushion for liabilities'
            : metrics.liquidityCoverage >= 0.3
              ? 'Build additional short-term reserves'
              : 'Liquidity tight ‚Äî focus on cash savings',
          tone: metrics.liquidityCoverage >= 0.5 ? 'positive' : metrics.liquidityCoverage >= 0.3 ? 'warning' : 'danger'
        },
        {
          label: 'Liquid Assets Share',
          value: formatPercent(metrics.liquidToAssets),
          insight: metrics.liquidToAssets >= 0.2
            ? 'Balanced mix of cash and growth assets'
            : 'Consider increasing your liquid reserves',
          tone: metrics.liquidToAssets >= 0.2 ? 'positive' : 'warning'
        },
        {
          label: 'Investment Allocation',
          value: formatPercent(metrics.investmentShare),
          insight: metrics.investmentShare >= 0.35
            ? 'Solid long-term wealth engine'
            : 'Deploy more into growth assets as comfort allows',
          tone: metrics.investmentShare >= 0.35 ? 'positive' : 'warning'
        }
      ];

      elements.ratioGrid.innerHTML = items.map(item => `
        <div class="ratio-card ${item.tone}">
          <strong>${item.label}</strong>
          <span style="font-size:1.3rem;font-weight:700;color:#0f172a;">${item.value}</span>
          <span>${item.insight}</span>
        </div>
      `).join('');
    }

    function renderAlerts(metrics) {
      const alerts = [];
      if (metrics.totalLiabilities > metrics.totalAssets * 0.95) {
        alerts.push({ tone: 'danger', text: 'Liabilities are approaching total assets. Tighten spending and accelerate paydowns.' });
      }
      if (metrics.netChange < 0) {
        alerts.push({ tone: 'warning', text: 'Net worth declined month-over-month. Review income, expense, and debt activity.' });
      }
      if (metrics.liquidToAssets < 0.15) {
        alerts.push({ tone: 'warning', text: 'Liquid assets make up less than 15% of total assets. Build a stronger cash buffer.' });
      }
      if (metrics.debtToAssets > 0.6) {
        alerts.push({ tone: 'danger', text: 'Debt-to-asset ratio is above 60%. High leverage can magnify financial stress.' });
      }
      const goalBehind = state.goals.filter(goal => metrics.netWorth < goal.target && (goal.target - metrics.netWorth) / goal.target > 0.3);
      goalBehind.forEach(goal => alerts.push({
        tone: 'warning',
        text: `You are ${formatCurrency(goal.target - metrics.netWorth)} away from "${goal.label}". Revisit your contributions schedule.`
      }));

      if (!alerts.length) {
        elements.alertsList.innerHTML = `<li class="warning" style="background:rgba(22,163,74,0.12);border-color:rgba(22,163,74,0.25);color:#15803d;">
          ‚úÖ All systems look stable. Keep executing your plan.
        </li>`;
        return;
      }

      elements.alertsList.innerHTML = alerts.map(alert => `
        <li class="${alert.tone === 'warning' ? 'warning' : ''}">
          <span>${alert.tone === 'danger' ? 'üö®' : '‚ö†Ô∏è'}</span>
          <div>${alert.text}</div>
        </li>
      `).join('');
    }

    function renderScenarioList() {
      const scenarios = getScenarioStore();
      if (!scenarios.length) {
        elements.scenarioList.innerHTML = `<p style="color:#64748b;">No saved scenarios yet. Configure assets & liabilities, then save a snapshot.</p>`;
        return;
      }
      elements.scenarioList.innerHTML = scenarios.map(scenario => `
        <div class="scenario-row" data-id="${scenario.id}">
          <span>${scenario.name}</span>
          <div style="font-size:0.85rem;color:#475569;">Net Worth: ${formatCurrency(scenario.netWorth)} ‚Ä¢ Updated ${new Date(scenario.timestamp).toLocaleDateString()}</div>
          <div class="scenario-actions">
            <button data-action="load" data-id="${scenario.id}">Load</button>
            <button data-action="run" data-id="${scenario.id}">Run</button>
            <button data-action="delete" data-id="${scenario.id}">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function calculateNetWorth() {
      const metrics = calculateMetrics();
      renderSummary(metrics);
      if (charts.assets || charts.liabilities || charts.netWorth) {
        renderCharts(metrics);
      }
      renderGoals(metrics);
      renderRatios(metrics);
      renderAlerts(metrics);
      return metrics;
    }

    function addRow(tableId, name = '', value = 0) {
      const tableBody = tableId === 'assetsTable' ? elements.assetsTableBody : elements.liabilitiesTableBody;
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" value="${name}" placeholder="${tableId === 'assetsTable' ? 'Asset Name' : 'Liability Name'}"></td>
        <td><input type="number" value="${value}" min="0"></td>
        <td><button title="Remove row">‚ùå</button></td>
      `;
      tableBody.appendChild(newRow);
      attachRowEventHandlers(newRow);
      calculateNetWorth();
    }

    function attachRowEventHandlers(row) {
      const [nameInput, valueInput] = row.querySelectorAll('input');
      const deleteButton = row.querySelector('button');
      nameInput.addEventListener('input', () => calculateNetWorth());
      valueInput.addEventListener('input', () => calculateNetWorth());
      valueInput.addEventListener('change', () => {
        calculateNetWorth();
        persistData();
      });
      deleteButton.addEventListener('click', () => {
        row.remove();
        calculateNetWorth();
        persistData();
      });
    }

    function renderTablesFromState() {
      elements.assetsTableBody.innerHTML = '';
      elements.liabilitiesTableBody.innerHTML = '';
      (state.assets || []).forEach(asset => addRow('assetsTable', asset.name, asset.value));
      (state.liabilities || []).forEach(liability => addRow('liabilitiesTable', liability.name, liability.value));
      calculateNetWorth();
    }

    function captureSnapshot() {
      const metrics = state.currentMetrics || calculateNetWorth();
      const monthKey = new Date().toISOString().slice(0, 7);
      const entry = {
        date: `${monthKey}-01`,
        netWorth: metrics.netWorth,
        assets: metrics.totalAssets,
        liabilities: metrics.totalLiabilities,
        timestamp: new Date().toISOString()
      };
      const existingIndex = state.history.findIndex(item => item.date === entry.date);
      if (existingIndex >= 0) {
        state.history[existingIndex] = entry;
      } else {
        state.history.push(entry);
      }
      state.history = sortHistory(state.history);
      calculateNetWorth();
      persistData({ skipHarvest: true, showStatus: false });
      showSaveStatus('Snapshot captured!');
    }

    function persistData(options = {}) {
      if (!options.skipHarvest) {
        calculateMetrics();
      }
      const payload = {
        assets: state.assets,
        liabilities: state.liabilities,
        history: state.history,
        goals: state.goals,
        timestamp: new Date().toISOString()
      };

      if (IS_LOCALHOST) {
        persistLocalNetWorth(payload);
        state.lastSavedSnapshot = payload;
        if (options.showStatus !== false) showSaveStatus('Saved locally');
        return;
      }

      const currentDb = window.db || db;
      if (!currentDb) {
        console.error('[NetWorth] DB not available');
        showSaveStatus('Save failed - DB not available', 'error');
        return;
      }
      currentDb.collection('networth').doc(userId).set(payload)
        .then(() => {
          state.lastSavedSnapshot = payload;
          if (options.showStatus !== false) showSaveStatus();
        })
        .catch(error => {
          console.error('Error saving net worth data:', error);
          showSaveStatus('Save failed', 'error');
        });
    }

    function getScenarioStore() {
      try {
        const raw = localStorage.getItem('netWorthScenarios');
        return raw ? JSON.parse(raw) : [];
      } catch (error) {
        console.warn('Unable to read scenario store:', error);
        return [];
      }
    }

    function setScenarioStore(scenarios) {
      localStorage.setItem('netWorthScenarios', JSON.stringify(scenarios));
    }

    function saveScenario() {
      const name = elements.scenarioName.value.trim() || `Scenario ${new Date().toLocaleDateString()}`;
      const metrics = state.currentMetrics || calculateNetWorth();
      const snapshot = {
        id: Date.now(),
        name,
        netWorth: metrics.netWorth,
        assets: state.assets,
        liabilities: state.liabilities,
        history: state.history,
        goals: state.goals,
        timestamp: new Date().toISOString()
      };
      const scenarios = getScenarioStore();
      scenarios.push(snapshot);
      setScenarioStore(scenarios.slice(-15));
      renderScenarioList();
      elements.scenarioName.value = '';
      showSaveStatus(`Scenario "${name}" saved`);
    }

    function applyScenario(scenario, shouldPersist = false) {
      state.assets = scenario.assets || [];
      state.liabilities = scenario.liabilities || [];
      state.history = scenario.history || state.history;
      state.goals = scenario.goals || state.goals;
      renderTablesFromState();
      renderScenarioList();
      if (shouldPersist) {
        persistData({ skipHarvest: true });
        showSaveStatus(`Scenario "${scenario.name}" applied`);
      }
    }

    function handleScenarioClick(event) {
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const { action, id } = button.dataset;
      const scenarios = getScenarioStore();
      const scenario = scenarios.find(item => item.id.toString() === id);
      if (!scenario) return;

      if (action === 'delete') {
        const updated = scenarios.filter(item => item.id.toString() !== id);
        setScenarioStore(updated);
        renderScenarioList();
        return;
      }

      if (action === 'load') {
        applyScenario(scenario, false);
        showSaveStatus(`Scenario "${scenario.name}" loaded`);
        return;
      }

      if (action === 'run') {
        applyScenario(scenario, true);
      }
    }

    function clearScenarios() {
      if (confirm('Clear all saved scenarios?')) {
        setScenarioStore([]);
        renderScenarioList();
      }
    }

    function applySampleNetWorth(shouldPersist = false) {
      const sample = generateSampleNetWorth();
      state.assets = sample.assets || [];
      state.liabilities = sample.liabilities || [];
      state.history = sample.history || [];
      state.goals = sample.goals || defaultGoals();
      renderTablesFromState();
      if (shouldPersist) {
        calculateNetWorth();
        persistData({ skipHarvest: true, showStatus: false });
        showSaveStatus('Sample data loaded');
      }
    }

    function shouldSeedSampleData() {
      if (IS_LOCALHOST) return true;
      if (!userEmail) return false;
      return ['testuser@bfh.com', 'testuser@BFH.com'].includes(userEmail.toLowerCase());
    }

    function loadData() {
      if (IS_LOCALHOST) {
        const data = getLocalNetWorthData();
        if (data) {
          state.assets = data.assets || [];
          state.liabilities = data.liabilities || [];
          state.history = data.history || [];
          state.goals = data.goals || defaultGoals();
          renderTablesFromState();
        } else {
          applySampleNetWorth(true);
        }
        renderScenarioList();
        return;
      }

      const currentDb = window.db || db;
      if (!currentDb) {
        console.error('[NetWorth] DB not available for loadData');
        return;
      }
      currentDb.collection('networth').doc(userId).get()
        .then(doc => {
          if (!doc.exists) {
            if (shouldSeedSampleData()) {
              applySampleNetWorth(true);
            } else {
              renderTablesFromState();
            }
            renderScenarioList();
            return;
          }
      const data = doc.data();
          state.assets = data.assets || [];
          state.liabilities = data.liabilities || [];
          state.history = data.history || [];
          state.goals = data.goals || defaultGoals();
          renderTablesFromState();
          renderScenarioList();
        })
        .catch(error => {
          console.error('Error loading net worth data:', error);
          showSaveStatus('Failed to load data', 'error');
        });
    }

    // Wait for auth to be available before using it
    (async () => {
      try {
        const { auth } = await waitForAuth(10000);
        window.auth = auth; // Make globally available
        
        auth.onAuthStateChanged(user => {
          if (!user && !IS_LOCALHOST) {
            // Add delay to prevent immediate redirect
            setTimeout(() => {
              window.location.href = '../../../index.html';
            }, 500);
            return;
          }
          userId = user ? user.uid : 'local-user';
          userEmail = user?.email || '';
          // Ensure db is available before loading
          if (window.db || db) {
            loadData();
          } else {
            console.warn('[NetWorth] DB not available, waiting...');
            setTimeout(() => {
              if (window.db || db) {
                loadData();
              } else {
                console.error('[NetWorth] DB not available after waiting');
              }
            }, 1000);
          }
        });
      } catch (error) {
        console.error('[NetWorth] Error waiting for auth:', error);
        // Only redirect if not localhost
        if (!IS_LOCALHOST) {
          setTimeout(() => {
            window.location.href = '../../../index.html';
          }, 1000);
        } else {
          // Use local data in localhost
          userId = 'local-user';
          userEmail = '';
          loadData();
        }
      }
    })();

    document.querySelectorAll('[data-add]').forEach(button => {
      button.addEventListener('click', () => addRow(button.dataset.add));
    });
    document.getElementById('saveButton').addEventListener('click', () => persistData());
    document.getElementById('snapshotButton').addEventListener('click', captureSnapshot);
    document.getElementById('saveGoalsBtn').addEventListener('click', () => {
      state.goals = state.goals.map(goal => {
        const input = document.getElementById(`goal-${goal.id}`);
        const value = parseFloat(input?.value) || goal.target;
        return { ...goal, target: Math.max(0, value) };
      });
      calculateNetWorth();
      persistData({ skipHarvest: true });
      showSaveStatus('Goals updated');
    });
    document.getElementById('saveScenarioBtn').addEventListener('click', saveScenario);
    document.getElementById('clearScenariosBtn').addEventListener('click', clearScenarios);
    elements.scenarioList.addEventListener('click', handleScenarioClick);

    function openModal(modal, onOpen) {
      if (!modal) return;
      modal.classList.add('show');
      modal.setAttribute('tabindex', '-1');
      modal.focus({ preventScroll: true });
      if (typeof onOpen === 'function') {
        requestAnimationFrame(onOpen);
      }
    }

    function closeModal(modal) {
      if (!modal) return;
      modal.classList.remove('show');
    }

    function setupModal(button, modal, onOpen) {
      if (!button || !modal) return;
      const closeButton = modal.querySelector('.close-modal');
      button.addEventListener('click', () => {
        openModal(modal, onOpen);
      });
      if (closeButton) {
        closeButton.addEventListener('click', () => closeModal(modal));
      }
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal(modal);
        }
      });
      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.classList.contains('show')) {
          closeModal(modal);
        }
      });
    }

    setupModal(
      elements.openNetWorthButton,
      elements.netWorthModal,
      () => renderCharts(state.currentMetrics || calculateNetWorth())
    );
    setupModal(
      elements.openAssetsButton,
      elements.assetsModal,
      () => renderCharts(state.currentMetrics || calculateNetWorth())
    );
    setupModal(
      elements.openLiabilitiesButton,
      elements.liabilitiesModal,
      () => renderCharts(state.currentMetrics || calculateNetWorth())
    );
    setupModal(
      elements.infoButton,
      elements.infoModal,
      () => {} // No special action needed, just open the modal
    );

    calculateNetWorth();
  </script>
</body>
</html>
