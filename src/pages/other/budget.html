<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>üí∞ Bradley's Budget Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Enhanced Utility Scripts -->
  <script src="../../../config.js"></script>
  <script src="../../../utils/validation.js"></script>
  <script src="../../../utils/errorHandler.js"></script>
  <script src="../../../utils/performance.js"></script>
  <script src="../../../utils/mobileOptimizer.js"></script>
  <script src="../../../utils/accessibility.js"></script>
  <script src="../../../utils/analytics.js"></script>
  <script type="module" src="../../../utils/activityLogger.js"></script>
  
  <!-- PWA Scrolling Fix -->
  <script>
    // Fix PWA scrolling issues
    function fixPWAScrolling() {
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('PWA mode detected, applying scrolling fixes');
        
        // Force enable scrolling in PWA mode
        document.body.style.overflow = 'auto';
        document.body.style.webkitOverflowScrolling = 'touch';
        document.body.style.overscrollBehavior = 'none';
        document.body.style.height = 'auto';
        document.body.style.minHeight = '100vh';
        
        document.documentElement.style.overflow = 'auto';
        document.documentElement.style.webkitOverflowScrolling = 'touch';
        document.documentElement.style.overscrollBehavior = 'none';
        document.documentElement.style.height = '100%';
        
        // Also fix the container
        const container = document.querySelector('.container');
        if (container) {
          container.style.overflow = 'visible';
          container.style.height = 'auto';
        }
        
        // Force a reflow
        document.body.offsetHeight;
        
        console.log('PWA scrolling fixes applied');
      }
    }
    
    // Apply fixes on multiple events to ensure they stick
    document.addEventListener('DOMContentLoaded', fixPWAScrolling);
    window.addEventListener('load', fixPWAScrolling);
    
    // Also apply after a short delay to override any other scripts
    setTimeout(fixPWAScrolling, 100);
    setTimeout(fixPWAScrolling, 500);
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      max-width: 1280px;
      margin: 0 auto;
    }
    
    /* PWA-specific fixes */
    @media (display-mode: standalone) {
      body {
        overflow: auto !important;
        -webkit-overflow-scrolling: touch !important;
        overscroll-behavior: none !important;
        height: auto !important;
        min-height: 100vh !important;
      }
      
      html {
        overflow: auto !important;
        -webkit-overflow-scrolling: touch !important;
        overscroll-behavior: none !important;
        height: 100% !important;
      }
      
      .container {
        overflow: visible !important;
        height: auto !important;
      }
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .header h1 {
      color: #007bff;
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .header p {
      color: #6c757d;
      font-size: 1.1rem;
      margin-bottom: 20px;
    }
    
    .month-selector {
      display: flex;
      align-items: center;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .month-selector label {
      font-weight: 600;
      color: #495057;
      font-size: 1rem;
    }
    
    .month-selector input[type="month"] {
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    .month-selector input[type="month"]:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #007bff;
      text-decoration: none;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 8px;
      background: rgba(0, 123, 255, 0.1);
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }
    
    .back-link:hover {
      background: rgba(0, 123, 255, 0.2);
      transform: translateX(-5px);
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      border-left: 4px solid;
    }
    
    .summary-card.income { border-left-color: #28a745; }
    .summary-card.budgeted { border-left-color: #ffc107; }
    .summary-card.spent { border-left-color: #dc3545; }
    .summary-card.remaining { border-left-color: #007bff; }
    
    .summary-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .summary-label {
      color: #6c757d;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      min-width: 120px;
      text-transform: uppercase;
    }
    
    .status-badge.neutral {
      background: rgba(0, 123, 255, 0.12);
      color: #0d6efd;
    }
    
    .status-badge.positive {
      background: rgba(25, 135, 84, 0.15);
      color: #198754;
    }
    
    .status-badge.negative {
      background: rgba(220, 53, 69, 0.15);
      color: #dc3545;
    }
    
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 28px 24px;
      max-width: 640px;
      width: 100%;
      box-shadow: 0 12px 40px rgba(15, 23, 42, 0.25);
      position: relative;
    }
    
    .modal-content h3 {
      margin-bottom: 18px;
      color: #0d6efd;
      text-align: center;
    }
    
    .modal-content canvas {
      width: 100% !important;
      max-height: 320px;
    }
    
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      border: none;
      background: rgba(148, 163, 184, 0.2);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: 700;
      color: #475569;
      transition: background 0.2s ease;
    }
    
    .modal-close:hover {
      background: rgba(148, 163, 184, 0.35);
    }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e9ecef;
    }
    
    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Make table action buttons smaller to fit in container */
    #expenseTable .btn {
      padding: 4px 6px;
      font-size: 0.7rem;
      gap: 2px;
      min-width: auto;
      white-space: nowrap;
    }
    
    .over-allocated {
      background: rgba(220, 53, 69, 0.08);
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      color: #007bff;
      border: 2px solid #007bff;
    }
    
    .btn-outline:hover {
      background: #007bff;
      color: white;
    }
    
    .section .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .section .controls .btn {
      flex: 1 1 220px;
      min-width: 170px;
      justify-content: center;
    }
    
    .budget-table-wrapper {
      width: 100%;
      overflow-x: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.9rem;
      min-width: 720px;
    }
    
    th, td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }
    
    /* Give more space to bill name column */
    #expenseTable th:nth-child(2),
    #expenseTable td:nth-child(2) {
      min-width: 180px;
      width: 25%;
    }
    
    /* Make category column much wider to show full names */
    #expenseTable th:nth-child(1),
    #expenseTable td:nth-child(1) {
      width: 25%;
      min-width: 180px;
    }
    
    /* Make number columns wider for dollar amounts */
    #expenseTable th:nth-child(3),
    #expenseTable td:nth-child(3),
    #expenseTable th:nth-child(4),
    #expenseTable td:nth-child(4),
    #expenseTable th:nth-child(5),
    #expenseTable td:nth-child(5) {
      width: 12%;
      min-width: 130px;
    }
    
    /* Make due date column narrower */
    #expenseTable th:nth-child(6),
    #expenseTable td:nth-child(6) {
      width: 12%;
      min-width: 120px;
    }
    
    /* Make paid from column */
    #expenseTable th:nth-child(7),
    #expenseTable td:nth-child(7) {
      width: 12%;
      min-width: 100px;
    }
    
    /* Status column */
    #expenseTable th:nth-child(8),
    #expenseTable td:nth-child(8) {
      width: 14%;
      min-width: 150px;
      text-align: center;
    }
    
    /* Make actions column narrower and ensure buttons fit */
    #expenseTable th:nth-child(9),
    #expenseTable td:nth-child(9) {
      width: 6%;
      min-width: 60px;
      text-align: center;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      background: white;
      min-height: 36px;
    }
    
    /* Make bill name input specifically larger */
    input[type="text"] {
      font-size: 1rem;
      padding: 8px 12px;
      min-height: 36px;
    }
    
    /* Make number inputs larger to fit all numbers */
    input[type="number"] {
      font-size: 0.9rem;
      padding: 8px 12px;
      min-height: 36px;
      text-align: right;
    }
    
    /* Make category select boxes bigger */
    select {
      font-size: 0.9rem;
      padding: 8px 12px;
      min-height: 36px;
      white-space: nowrap;
      overflow: visible;
      text-overflow: unset;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    input[type="number"] {
      text-align: right;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
    }
    
    .notes-section {
      margin-top: 30px;
    }
    
    .notes-section textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .success-msg {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
    
    .warning {
      color: #dc3545;
      font-weight: bold;
    }
    
    .income-row-over {
      background: rgba(255, 193, 7, 0.15);
    }
    
    .insights {
      background: rgba(13, 110, 253, 0.08);
      border-left: 4px solid #0d6efd;
      padding: 16px;
      border-radius: 10px;
      color: #0b2f6a;
      line-height: 1.6;
    }
    
    .insights strong {
      color: #0d6efd;
    }
    
    #spendingChart {
      max-width: 520px;
      width: 100%;
      margin: 0 auto;
    }
    
    .mobile-quick-actions {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 12px;
      z-index: 1000;
    }
    
    .mobile-quick-actions button {
      padding: 12px 18px;
      border-radius: 999px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      border: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .mobile-quick-actions .btn-income {
      background: #198754;
      color: #fff;
    }
    
    .mobile-quick-actions .btn-expense {
      background: #0d6efd;
      color: #fff;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0 12px;
      }
      .container {
        padding: 15px 12px;
      }
      
      .header {
        padding: 22px 18px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .month-selector {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      
      .month-selector input[type="month"] {
        min-width: 200px;
      }
      
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      
      .section {
        padding: 20px;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .section .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .section .controls .btn {
        width: 100%;
      }
      
      .budget-table-wrapper {
        margin: 0 -6px;
        padding: 0 6px;
      }
      
      table {
        font-size: 0.8rem;
        min-width: 640px;
      }
      .mobile-quick-actions {
        display: flex;
      }
      
      th, td {
        padding: 8px 6px;
      }
      
      /* Make bill name column even wider on mobile */
      #expenseTable th:nth-child(2),
      #expenseTable td:nth-child(2) {
        min-width: 180px;
        width: 35%;
      }
      
      /* Make category column wider on mobile too */
      #expenseTable th:nth-child(1),
      #expenseTable td:nth-child(1) {
        width: 30%;
        min-width: 150px;
      }
      
      /* Make text inputs compact on mobile */
      input[type="text"] {
        font-size: 0.9rem;
        padding: 6px 10px;
        min-height: 32px;
      }
      
      /* Make number inputs compact on mobile too */
      input[type="number"] {
        font-size: 0.8rem;
        padding: 6px 10px;
        min-height: 32px;
      }
      
      /* Make select boxes compact on mobile too */
      select {
        font-size: 0.8rem;
        padding: 6px 10px;
        min-height: 32px;
      }
      
      /* Adjust number column widths on mobile */
      #expenseTable th:nth-child(3),
      #expenseTable td:nth-child(3),
      #expenseTable th:nth-child(4),
      #expenseTable td:nth-child(4),
      #expenseTable th:nth-child(5),
      #expenseTable td:nth-child(5) {
        width: 18%;
        min-width: 100px;
      }
      
      /* Make paid from column on mobile */
      #expenseTable th:nth-child(7),
      #expenseTable td:nth-child(7) {
        width: 12%;
        min-width: 100px;
      }
      
      /* Make actions column even smaller on mobile */
      #expenseTable th:nth-child(8),
      #expenseTable td:nth-child(8) {
        width: 5%;
        min-width: 50px;
      }
      
      /* Make action buttons even smaller on mobile */
      #expenseTable .btn {
        padding: 3px 5px;
        font-size: 0.65rem;
        gap: 1px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .header p {
        font-size: 0.9rem;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .summary-value {
        font-size: 1.25rem;
      }
      
      .summary-label {
        font-size: 0.8rem;
      }
      
      .section {
        padding: 16px;
      }
      
      .section-title {
        font-size: 1.1rem;
      }
      
      .budget-table-wrapper {
        margin: 0 -8px;
        padding: 0 8px;
      }
      
      table {
        font-size: 0.75rem;
        min-width: 560px;
      }
      
      th, td {
        padding: 6px 4px;
      }
      
      .section .controls .btn {
        font-size: 0.85rem;
        padding: 10px 14px;
      }
      
      .btn {
        font-size: 0.75rem;
        padding: 8px 12px;
      }
      
      .month-selector input[type="month"] {
        min-width: 150px;
        font-size: 0.9rem;
      }
      
      .month-selector label {
        font-size: 0.9rem;
      }
      
      /* Ensure text doesn't overflow on very small screens */
      .summary-card {
        padding: 15px 10px;
      }
      
      .back-link {
        font-size: 0.9rem;
        padding: 10px 15px;
      }
      
      /* Make sure table headers fit */
      th {
        font-size: 0.7rem;
        padding: 4px 2px;
      }
      
      /* Optimize input fields for very small screens */
      input, select, textarea {
        font-size: 0.8rem;
        padding: 4px 8px;
        min-height: 28px;
      }
      .mobile-quick-actions {
        display: flex;
        width: calc(100% - 24px);
        max-width: 480px;
      }
    }
    
    /* Extra small screens (320px and below) */
    @media (max-width: 320px) {
      .header h1 {
        font-size: 1.25rem;
      }
      
      .summary-value {
        font-size: 1rem;
      }
      
      table {
        font-size: 0.7rem;
        min-width: 520px;
      }
      
      th, td {
        padding: 4px 2px;
      }
      
      .btn {
        font-size: 0.7rem;
        padding: 6px 8px;
      }
    }
  </style>
</head>

<body>
<div class="container">
    <a href="../../../index.html" class="back-link">
      ‚Üê Back to Dashboard
    </a>
    
    <div class="header">
      <h1>üí∞ Bradley's Budget Tracker</h1>
      <p>Take control of your finances with our zero-based budgeting system</p>
      <div class="month-selector">
        <label for="monthSelect">Select Month:</label>
        <input type="month" id="monthSelect" onchange="onMonthChange()" />
        <button class="btn btn-outline" onclick="goToCurrentMonth()">üìÖ Current Month</button>
      </div>
      </div>

    <div class="summary-cards">
      <div class="summary-card income">
        <div class="summary-value" id="tileIncome">$0</div>
        <div class="summary-label">Total Income</div>
      </div>
      <div class="summary-card budgeted">
        <div class="summary-value" id="tileBudgeted">$0</div>
        <div class="summary-label">Budgeted</div>
      </div>
      <div class="summary-card spent">
        <div class="summary-value" id="tileSpent">$0</div>
        <div class="summary-label">Spent</div>
      </div>
      <div class="summary-card remaining">
        <div class="summary-value" id="tileRemaining">$0</div>
        <div class="summary-label">Remaining</div>
      </div>
    </div>
  
  <div class="section">
    <div class="section-header">
      <h3 class="section-title">üß≠ Zero-Based Assistant</h3>
      <button class="btn btn-outline" onclick="toggleBreakdownModal(true)">üìä View Spending Breakdown</button>
    </div>
    <div id="allocationInsights" class="insights">
      Enter your income and expenses to see actionable tips here.
    </div>
  </div>
    
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">üí∞ Income</h3>
        <button class="btn btn-primary" onclick="addIncome()">+ Add Income</button>
      </div>
      <div class="budget-table-wrapper">
      <table id="incomeTable">
        <thead>
          <tr>
            <th>Source</th>
            <th>Amount ($)</th>
            <th>Remaining to Allocate</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">üí≥ Expenses</h3>
        <button class="btn btn-primary" onclick="addExpense()">+ Add Expense</button>
      </div>
      <div class="budget-table-wrapper">
      <div class="budget-table-wrapper">
      <table id="expenseTable">
        <thead>
          <tr>
            <th>Category</th>
            <th>Bill Name</th>
            <th>Budgeted</th>
            <th>Spent</th>
            <th>Remaining</th>
            <th>Due Date</th>
            <th>Paid From</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      </div>

    <div class="section">
      <div class="section-header">
        <h3 class="section-title">üìù Monthly Notes</h3>
      </div>
      <div class="notes-section">
        <textarea id="monthlyNotes" placeholder="Write your financial goals, notes, and reminders here..."></textarea>
    </div>
      </div>

    <div class="section">
      <div class="section-header">
        <h3 class="section-title">üõ†Ô∏è Actions</h3>
      </div>
      <div class="controls">
        <button class="btn btn-outline" onclick="calculateBudget()">üßÆ Recalculate</button>
        <button class="btn btn-success" onclick="saveBudget()">üíæ Save Budget</button>
        <button class="btn btn-outline" onclick="loadBudget()">üì• Load Budget</button>
        <button class="btn btn-outline" onclick="zeroBasedBudget()">‚úÖ Zero-Based Check</button>
        <button class="btn btn-outline" onclick="exportBudgetToCSV()">üìä Export CSV</button>
        <button class="btn btn-outline" onclick="exportToPDF()">üìÑ Export PDF</button>
    </div>
  </div>

    <div class="success-msg" id="zeroBasedMessage">
      üéâ Congratulations! You've created a Zero-Based Budget!
  </div>
</div>

<div class="mobile-quick-actions">
  <button class="btn-income" onclick="addIncome(); focusNewestRow('#incomeTable');">‚ûï Income</button>
  <button class="btn-expense" onclick="addExpense(); focusNewestRow('#expenseTable');">‚ûï Expense</button>
</div>

<div class="modal-overlay" id="breakdownModal">
  <div class="modal-content">
    <button class="modal-close" onclick="toggleBreakdownModal(false)">‚úñ</button>
    <h3>üìä Spending Breakdown</h3>
    <canvas id="spendingChart" height="260"></canvas>
  </div>
</div>

  <div id="loadingIndicator" class="loading" style="display: none !important;">
    <div class="spinner"></div>
  <p>Loading...</p>
</div>

<script>
    // Firebase configuration
    const firebaseConfig = window.CONFIG?.firebase || {
  apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
  authDomain: "mobile-debt-tracker.firebaseapp.com",
      projectId: "mobile-debt-tracker",
      storageBucket: "mobile-debt-tracker.appspot.com",
      messagingSenderId: "153601029964",
      appId: "1:153601029964:web:ddd1880ba21bce2e9041e9"
};
    
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let userId = "";
const IS_LOCALHOST = ['localhost', '127.0.0.1'].includes(window.location.hostname);

const formatCurrency = (value) => {
  const num = Number(value) || 0;
  const absolute = Math.abs(num).toFixed(2);
  return `${num < 0 ? '-' : ''}$${absolute}`;
};

const CHART_COLORS = [
  '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#20c997', '#fd7e14', '#343a40'
];

let spendingChartInstance = null;
let lastCategoryTotals = {};

// Initialize activity logger
window.db = db;
window.auth = auth;
    
    // Initialize utility functions
    if (window.ErrorHandler) {
      window.ErrorHandler.setupGlobalErrorHandling();
    }
    
    if (window.MobileOptimizer) {
      window.MobileOptimizer.init();
    }
    
    // AccessibilityUtils disabled to remove skip link
    // if (window.AccessibilityUtils) {
    //   window.AccessibilityUtils.init();
    // }
    
    if (window.Analytics) {
      window.Analytics.init();
      window.Analytics.trackPageView('/budget.html', 'Budget Tracker');
    }
    
    // Authentication
auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
  userId = user.uid;
      console.log('User authenticated, loading budget data...');
      
      // Set current month as default
      const currentMonth = new Date().toISOString().slice(0, 7);
      document.getElementById('monthSelect').value = currentMonth;
      
  loadBudget();
});

    // Month change handler
function onMonthChange() {
      const selectedMonth = document.getElementById('monthSelect').value;
      console.log('Month changed to:', selectedMonth);
      
      // Clear current data
  document.querySelector("#incomeTable tbody").innerHTML = "";
  document.querySelector("#expenseTable tbody").innerHTML = "";
  document.getElementById("monthlyNotes").value = "";
      
      // Load budget for selected month
  loadBudget();
}

    // Go to current month
    function goToCurrentMonth() {
      const currentMonth = new Date().toISOString().slice(0, 7);
      document.getElementById('monthSelect').value = currentMonth;
      onMonthChange();
    }
    
    // Add Income function
function addIncome(source = "", amount = 0) {
      const tbody = document.querySelector("#incomeTable tbody");
      const row = tbody.insertRow();
      
  row.innerHTML = `
        <td><input type="text" value="${source}" placeholder="Income source" onchange="calculateBudget()"></td>
        <td><input type="number" value="${amount}" placeholder="0.00" onchange="calculateBudget()"></td>
    <td class="remaining-cell">$0.00</td>
        <td><button class="btn btn-outline" onclick="this.closest('tr').remove(); calculateBudget()">üóëÔ∏è Remove</button></td>
  `;
      
      calculateBudget();
}

    // Add Expense function
    function addExpense(category = '', name = '', budgeted = 0, dueDate = '', spent = 0, paidFrom = '') {
  const tbody = document.querySelector("#expenseTable tbody");
  const row = tbody.insertRow();
  
      row.innerHTML = `
        <td>
          <select onchange="calculateBudget()">
      <option value="">Select Category</option>
            <option value="Housing" ${category === 'Housing' ? 'selected' : ''}>Housing</option>
      <option value="Transportation" ${category === 'Transportation' ? 'selected' : ''}>Transportation</option>
      <option value="Food" ${category === 'Food' ? 'selected' : ''}>Food</option>
            <option value="Utilities" ${category === 'Utilities' ? 'selected' : ''}>Utilities</option>
            <option value="Health" ${category === 'Health' ? 'selected' : ''}>Health</option>
      <option value="Personal" ${category === 'Personal' ? 'selected' : ''}>Personal</option>
      <option value="Lifestyle" ${category === 'Lifestyle' ? 'selected' : ''}>Lifestyle</option>
            <option value="Savings" ${category === 'Savings' ? 'selected' : ''}>Savings</option>
      <option value="Debt" ${category === 'Debt' ? 'selected' : ''}>Debt</option>
      <option value="Other" ${category === 'Other' ? 'selected' : ''}>Other</option>
    </select>
        </td>
        <td><input type="text" value="${name}" placeholder="Bill name" onchange="calculateBudget()"></td>
        <td><input type="number" value="${budgeted}" placeholder="0.00" onchange="calculateBudget()"></td>
        <td><input type="number" value="${spent}" placeholder="0.00" onchange="calculateBudget()"></td>
        <td><input type="number" readonly></td>
        <td><input type="date" value="${dueDate}" onchange="calculateBudget()"></td>
        <td>
          <select onchange="calculateBudget()">
            <option value="">Select Income Source</option>
            <option value="${paidFrom}" ${paidFrom ? 'selected' : ''}>${paidFrom || ''}</option>
          </select>
        </td>
        <td class="status-cell"><span class="status-badge neutral">On Track</span></td>
        <td><button class="btn btn-outline" onclick="this.closest('tr').remove(); calculateBudget()">üóëÔ∏è Remove</button></td>
      `;
  
  calculateBudget();
      
      // Log activity
      if (name && budgeted && window.activityLogger) {
        window.activityLogger.logBudgetCreated(category || 'Uncategorized', parseFloat(budgeted));
      }
}

    // Calculate Budget function
function calculateBudget() {
  let incomeTotal = 0;
  let budgetedTotal = 0;
  let spentTotal = 0;

  const incomeMap = {};
  const underBudget = [];
  const overBudget = [];
  const categoryTotals = {};

  const incomeRows = document.querySelectorAll("#incomeTable tbody tr");
  incomeRows.forEach(row => {
    const sourceInput = row.cells[0].querySelector("input");
    const amountInput = row.cells[1].querySelector("input");
    const source = sourceInput.value.trim();
    const amount = parseFloat(amountInput.value) || 0;
    incomeTotal += amount;
    if (source) {
      incomeMap[source] = { amount, allocated: 0, row };
    }
  });

  const expenseRows = document.querySelectorAll("#expenseTable tbody tr");
  expenseRows.forEach(row => {
    const categorySelect = row.cells[0].querySelector("select");
    const nameInput = row.cells[1].querySelector("input");
    const budgetedInput = row.cells[2].querySelector("input");
    const spentInput = row.cells[3].querySelector("input");
    const remainingInput = row.cells[4].querySelector("input");
    const paidFromSelect = row.cells[6].querySelector("select");
    const statusCell = row.cells[7];

    const category = categorySelect.value || 'Uncategorized';
    const name = nameInput.value || category;
    const budgeted = parseFloat(budgetedInput.value) || 0;
    const spent = parseFloat(spentInput.value) || 0;
    const remaining = budgeted - spent;
    const chartValue = spent > 0.01 ? spent : budgeted;
    const paidFrom = paidFromSelect.value;

    budgetedTotal += budgeted;
    spentTotal += spent;

    remainingInput.value = remaining.toFixed(2);


    if (chartValue > 0.01) {
      categoryTotals[category] = (categoryTotals[category] || 0) + chartValue;
    }

    if (paidFrom && incomeMap[paidFrom]) {
      incomeMap[paidFrom].allocated += budgeted;
    }

    const diff = spent - budgeted;
    let badgeClass = 'neutral';
    let badgeText = 'On Track';

    if (budgeted <= 0 && spent <= 0) {
      badgeText = 'Not Planned';
    } else if (budgeted <= 0 && spent > 0) {
      badgeClass = 'negative';
      badgeText = `Unplanned ${formatCurrency(spent)}`;
      overBudget.push({ name, over: spent, category });
    } else if (diff > 0.01) {
      badgeClass = 'negative';
      badgeText = `Over by ${formatCurrency(diff)}`;
      overBudget.push({ name, over: diff, category });
    } else if (diff < -0.01) {
      badgeClass = 'positive';
      badgeText = `Under by ${formatCurrency(Math.abs(diff))}`;
      underBudget.push({ name, remaining: Math.abs(diff), category });
    }

    statusCell.innerHTML = `<span class="status-badge ${badgeClass}">${badgeText}</span>`;
    row.classList.remove('over-allocated');
  });

  const incomeEntries = Object.entries(incomeMap);

  expenseRows.forEach(row => {
    const paidFromSelect = row.cells[6].querySelector("select");
    const currentValue = paidFromSelect.value;

    if (incomeEntries.length) {
      paidFromSelect.innerHTML = '<option value="">Select Income Source</option>' +
        incomeEntries.map(([source, info]) => {
          const remainingAlloc = info.amount - info.allocated;
          const label = remainingAlloc >= 0
            ? `${source} (${formatCurrency(remainingAlloc)} left)`
            : `${source} (Over by ${formatCurrency(Math.abs(remainingAlloc))})`;
          return `<option value="${source}" ${source === currentValue ? 'selected' : ''}>${label}</option>`;
        }).join('');
    } else {
      paidFromSelect.innerHTML = '<option value="">Select Income Source</option>';
    }

    if (currentValue && !incomeMap[currentValue]) {
      paidFromSelect.value = '';
    }

    const chosen = paidFromSelect.value;
    if (chosen && incomeMap[chosen]) {
      const remainingAlloc = incomeMap[chosen].amount - incomeMap[chosen].allocated;
      row.classList.toggle('over-allocated', remainingAlloc < -0.01);
    } else {
      row.classList.remove('over-allocated');
    }
  });

  incomeRows.forEach(row => {
    const source = row.cells[0].querySelector("input").value.trim();
    const amount = parseFloat(row.cells[1].querySelector("input").value) || 0;
    const remainingCell = row.cells[2];
    if (source && incomeMap[source]) {
      const remainingToAllocate = incomeMap[source].amount - incomeMap[source].allocated;
      remainingCell.textContent = `${formatCurrency(remainingToAllocate)}`;
      row.classList.toggle('income-row-over', remainingToAllocate < -0.01);
    } else {
      remainingCell.textContent = `${formatCurrency(amount)}`;
      row.classList.remove('income-row-over');
    }
  });

  const remaining = incomeTotal - budgetedTotal;

  document.getElementById("tileIncome").textContent = formatCurrency(incomeTotal);
  document.getElementById("tileBudgeted").textContent = formatCurrency(budgetedTotal);
  document.getElementById("tileSpent").textContent = formatCurrency(spentTotal);
  document.getElementById("tileRemaining").textContent = formatCurrency(remaining);

  const remainingElement = document.getElementById("tileRemaining");
  remainingElement.style.color = remaining < 0 ? "#dc3545" : remaining > 0 ? "#198754" : "#2c3e50";

  const zeroBasedBanner = document.getElementById("zeroBasedMessage");
  if (incomeTotal > 0 && Math.abs(remaining) < 0.01 && overBudget.length === 0) {
    zeroBasedBanner.style.display = "block";
  } else {
    zeroBasedBanner.style.display = "none";
  }

  lastCategoryTotals = categoryTotals;
  updateSpendingChart(categoryTotals);
  updateZeroBasedAssistant(remaining, underBudget, overBudget, incomeMap);
}

function updateSpendingChart(categoryTotals) {
  const canvas = document.getElementById('spendingChart');
  const modal = document.getElementById('breakdownModal');
  if (!canvas || typeof Chart === 'undefined') return;

  const entries = Object.entries(categoryTotals).filter(([, value]) => value > 0.01);
  const labels = entries.length ? entries.map(([label]) => label) : ['No Spending'];
  const data = entries.length ? entries.map(([, value]) => value) : [1];
  const backgroundColor = labels.map((_, idx) => CHART_COLORS[idx % CHART_COLORS.length]);

  if (!spendingChartInstance) {
    spendingChartInstance = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          label: 'Spending',
          data,
          backgroundColor,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '64%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 14,
              padding: 14,
              generateLabels(chart) {
                const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                return original.map(item => {
                  const value = chart.data.datasets[item.datasetIndex].data[item.index];
                  return {
                    ...item,
                    text: `${item.text}: ${formatCurrency(value)}`
                  };
                });
              }
            }
          },
          tooltip: {
            callbacks: {
              label(context) {
                const label = context.label || '';
                const value = context.parsed;
                return `${label}: ${formatCurrency(value)}`;
              }
            }
          }
        }
      }
    });
  } else {
    spendingChartInstance.data.labels = labels;
    spendingChartInstance.data.datasets[0].data = data;
    spendingChartInstance.data.datasets[0].backgroundColor = backgroundColor;
    spendingChartInstance.update();
  }

  if (modal && modal.classList.contains('active')) {
    setTimeout(() => spendingChartInstance && spendingChartInstance.resize(), 120);
  }
}

function updateZeroBasedAssistant(remaining, underBudget, overBudget, incomeMap) {
  const container = document.getElementById('allocationInsights');
  if (!container) return;

  const messages = [];

  if (Math.abs(remaining) < 0.01 && overBudget.length === 0) {
    messages.push('Everything is balanced. Great job sticking to your zero-based budget!');
  } else if (remaining > 0.01) {
    messages.push(`You still have ${formatCurrency(remaining)} that has not been assigned.`);
    if (underBudget.length) {
      const target = underBudget[0];
      messages.push(`Consider increasing <strong>${target.name}</strong> by ${formatCurrency(Math.min(target.remaining, remaining))}.`);
    } else {
      messages.push('Add a new savings goal or debt payment to give every dollar a job.');
    }
  } else if (remaining < -0.01) {
    messages.push(`You are over budget by ${formatCurrency(Math.abs(remaining))}.`);
    if (overBudget.length) {
      const target = overBudget[0];
      messages.push(`Reduce <strong>${target.name}</strong> by ${formatCurrency(Math.min(target.over, Math.abs(remaining)))} or shift money from a less important category.`);
    } else {
      messages.push('Reduce spending or increase income to cover the difference.');
    }
  }

  const overAllocatedIncome = Object.entries(incomeMap)
    .map(([source, info]) => ({ source, extra: info.amount - info.allocated }))
    .filter(entry => entry.extra < -0.01);
  if (overAllocatedIncome.length) {
    const entry = overAllocatedIncome[0];
    messages.push(`<strong>${entry.source}</strong> is over-allocated by ${formatCurrency(Math.abs(entry.extra))}. Move one of the linked expenses to a different income source.`);
  }

  if (!messages.length) {
    messages.push('Enter your income and expenses to see tailored suggestions.');
  }

  container.innerHTML = messages.map(message => `<p>${message}</p>`).join('');
}

function focusNewestRow(tableSelector) {
  setTimeout(() => {
    const table = document.querySelector(tableSelector);
    if (!table || !table.tBodies.length) return;
    const rows = table.tBodies[0].rows;
    if (!rows.length) return;
    const lastRow = rows[rows.length - 1];
    const field = lastRow.querySelector('input, select, textarea');
    if (field) {
      field.focus({ preventScroll: false });
    }
  }, 50);
}

function toggleBreakdownModal(show) {
  const modal = document.getElementById('breakdownModal');
  if (!modal) return;
  if (show) {
    modal.classList.add('active');
    updateSpendingChart(lastCategoryTotals);
  } else {
    modal.classList.remove('active');
  }
}

document.getElementById('breakdownModal')?.addEventListener('click', (event) => {
  if (event.target.id === 'breakdownModal') {
    toggleBreakdownModal(false);
  }
});

    // Save Budget function
async function saveBudget() {
  const loadingIndicator = document.getElementById("loadingIndicator");
  loadingIndicator.style.display = "block";
      
      console.log('Save Budget button clicked');
      
      try {
        // Get the selected month
        const selectedMonth = document.getElementById("monthSelect").value;
        let docId = userId;
        
        // Use month-based document ID if month is selected
        if (selectedMonth) {
          docId = userId + '_' + selectedMonth;
        }
        
    const budgetData = {
      income: Array.from(document.querySelectorAll("#incomeTable tbody tr")).map(row => ({
        source: row.cells[0].querySelector("input").value,
        amount: parseFloat(row.cells[1].querySelector("input").value) || 0
      })),
      expenses: Array.from(document.querySelectorAll("#expenseTable tbody tr")).map(row => ({
            category: row.cells[0].querySelector("select").value,
            name: row.cells[1].querySelector("input").value,
        budgeted: parseFloat(row.cells[2].querySelector("input").value) || 0,
        spent: parseFloat(row.cells[3].querySelector("input").value) || 0,
        due: row.cells[5].querySelector("input").value,
            paidFrom: row.cells[6].querySelector("select").value
      })),
      notes: document.getElementById("monthlyNotes").value,
          month: selectedMonth || new Date().toISOString().slice(0, 7) // YYYY-MM format
        };
        
        console.log('Saving budget for document ID:', docId);
        console.log('Budget data being saved:', budgetData);
        await db.collection("budgets").doc(docId).set(budgetData);
        
        // Log activity
        if (window.activityLogger) {
          const totalIncome = budgetData.income.reduce((sum, inc) => sum + inc.amount, 0);
          const totalExpenses = budgetData.expenses.reduce((sum, exp) => sum + exp.budgeted, 0);
          window.activityLogger.logActivity('budget_updated', `Updated budget for ${selectedMonth || 'current month'}: $${totalIncome.toFixed(2)} income, $${totalExpenses.toFixed(2)} expenses`, 'üìä');
        }
        
        if (window.ErrorHandler) {
          window.ErrorHandler.showSuccess(`Budget saved successfully for ${selectedMonth || 'current month'}!`);
        } else {
          alert(`Budget saved successfully for ${selectedMonth || 'current month'}!`);
        }
  } catch (error) {
        console.error('Error saving budget:', error);
        if (window.ErrorHandler) {
          window.ErrorHandler.handleFirebaseError(error);
        } else {
          alert('Error saving budget: ' + error.message);
        }
  } finally {
    loadingIndicator.style.display = "none";
  }
}

function getLocalBudgetData() {
  const local = (window.getLocalTestData && window.getLocalTestData('budget')) || window.LOCAL_TEST_DATA?.budget;
  if (local) return JSON.parse(JSON.stringify(local));
  try {
    const stored = localStorage.getItem('local_test_budget');
    return stored ? JSON.parse(stored) : null;
  } catch (err) {
    console.warn('Unable to read local budget data:', err);
    return null;
  }
}

function populateBudgetFromLocal(data) {
  if (!data) return false;
  document.querySelector("#incomeTable tbody").innerHTML = "";
  document.querySelector("#expenseTable tbody").innerHTML = "";
  document.getElementById("monthlyNotes").value = data.notes || '';

  if (Array.isArray(data.income)) {
    data.income.forEach(inc => addIncome(inc.source || '', inc.amount || 0));
  }

  if (Array.isArray(data.expenses)) {
    data.expenses.forEach(exp => addExpense(exp.category || 'Other', exp.name || '', exp.budgeted || 0, exp.due || '', exp.spent || 0, exp.paidFrom || ''));
  }

  if (data.month) {
    document.getElementById("monthSelect").value = data.month;
  }

  calculateBudget();
  if (window.ErrorHandler) {
    window.ErrorHandler.showSuccess('Loaded local sample budget data.');
  }
  return true;
}

    // Load Budget function
async function loadBudget() {
  const loadingIndicator = document.getElementById("loadingIndicator");
  loadingIndicator.style.display = "block";
      
      console.log('Load Budget button clicked');
      
      if (IS_LOCALHOST) {
        const local = getLocalBudgetData();
        populateBudgetFromLocal(local);
        loadingIndicator.style.display = "none";
        return;
      }
      
      try {
        // Get the selected month
        const selectedMonth = document.getElementById("monthSelect").value;
        let docId = userId;
        
        // Use month-based document ID if month is selected
        if (selectedMonth) {
          docId = userId + '_' + selectedMonth;
        }
        
        console.log('Loading budget for document ID:', docId);
        const doc = await db.collection("budgets").doc(docId).get();
        
        // Always clear existing data first
      document.querySelector("#incomeTable tbody").innerHTML = "";
      document.querySelector("#expenseTable tbody").innerHTML = "";
        document.getElementById("monthlyNotes").value = "";
        
        if (doc.exists) {
          const data = doc.data();
          
          // Load income data
          if (data.income && Array.isArray(data.income)) {
            data.income.forEach(inc => {
              if (inc.source && inc.amount) {
                addIncome(inc.source, inc.amount);
              }
            });
          }
          
          // Load expense data
          if (data.expenses && Array.isArray(data.expenses)) {
            console.log('Loading expenses for month:', selectedMonth);
            console.log('Expense data:', data.expenses);
            data.expenses.forEach(exp => {
              if (exp.category && exp.name) {
                console.log('Loading expense:', exp.name, 'Spent:', exp.spent);
                addExpense(exp.category, exp.name, exp.budgeted || 0, exp.due || '', exp.spent || 0, exp.paidFrom || '');
              }
            });
          }
          
          // Load notes
          if (data.notes) {
            document.getElementById("monthlyNotes").value = data.notes;
          }
          
  calculateBudget();
          
          if (window.ErrorHandler) {
            window.ErrorHandler.showSuccess(`Budget loaded successfully for ${selectedMonth || 'current month'}!`);
          }
        } else if (IS_LOCALHOST && populateBudgetFromLocal(getLocalBudgetData())) {
          console.log('Loaded local sample budget for offline testing.');
        } else {
          console.log('No data found for month:', selectedMonth);
          // Recalculate budget with empty data
          calculateBudget();
          if (window.ErrorHandler) {
            window.ErrorHandler.showWarning('No budget data found. Start by adding income and expenses.');
          }
        }
      } catch (error) {
        console.error('Error loading budget:', error);
        if (window.ErrorHandler) {
          if (!(IS_LOCALHOST && populateBudgetFromLocal(getLocalBudgetData()))) {
            window.ErrorHandler.handleFirebaseError(error);
          }
        } else {
          if (!(IS_LOCALHOST && populateBudgetFromLocal(getLocalBudgetData()))) {
            alert('Error loading budget: ' + error.message);
          }
        }
      } finally {
        loadingIndicator.style.display = "none";
      }
    }
    
    
    // Zero-Based Budget Check function
function zeroBasedBudget() {
  calculateBudget();
      const incomeTotal = parseFloat(document.getElementById("tileIncome").textContent.replace(/[^0-9.-]+/g, ""));
      const budgetedTotal = parseFloat(document.getElementById("tileBudgeted").textContent.replace(/[^0-9.-]+/g, ""));
  const remaining = incomeTotal - budgetedTotal;

  if (incomeTotal === 0) {
    alert("‚ö†Ô∏è Please add some income first!");
    return;
  }

      if (Math.abs(remaining) < 0.01) {
        alert("‚úÖ Perfect! Your budget is zero-based!");
    return;
  }

  if (remaining > 0) {
    alert(`You have $${remaining.toFixed(2)} remaining to allocate to your budget.`);
  } else {
    alert(`You are over budget by $${Math.abs(remaining).toFixed(2)}.`);
  }
}

    // Export to CSV function
function exportBudgetToCSV() {
  const incomeRows = document.querySelectorAll("#incomeTable tbody tr");
  const expenseRows = document.querySelectorAll("#expenseTable tbody tr");
  let csvContent = "data:text/csv;charset=utf-8,";
      
  csvContent += "Income Source,Amount\n";
  incomeRows.forEach(row => {
    const source = row.cells[0].querySelector("input").value;
    const amount = row.cells[1].querySelector("input").value;
    csvContent += `${source},${amount}\n`;
  });
      
      csvContent += "\nExpense Category,Bill Name,Budgeted,Spent,Due Date\n";
  expenseRows.forEach(row => {
        const category = row.cells[0].querySelector("select").value;
        const name = row.cells[1].querySelector("input").value;
    const budgeted = row.cells[2].querySelector("input").value;
    const spent = row.cells[3].querySelector("input").value;
    const due = row.cells[5].querySelector("input").value;
        csvContent += `${category},${name},${budgeted},${spent},${due}\n`;
  });
      
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "budget_data.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

    // Export to PDF function
    function exportToPDF() {
      // Get current budget data
      const incomeTotal = document.getElementById("tileIncome").textContent;
      const budgetedTotal = document.getElementById("tileBudgeted").textContent;
      const spentTotal = document.getElementById("tileSpent").textContent;
      const remainingTotal = document.getElementById("tileRemaining").textContent;
      const selectedMonth = document.getElementById("monthSelect").value || new Date().toISOString().slice(0, 7);
      
      // Create a new window for printing
      const printWindow = window.open('', '_blank');
      
      // Get income data
      const incomeRows = Array.from(document.querySelectorAll("#incomeTable tbody tr")).map(row => ({
      source: row.cells[0].querySelector("input").value,
        amount: row.cells[1].querySelector("input").value
      })).filter(inc => inc.source && inc.amount);
      
      // Get expense data
      const expenseRows = Array.from(document.querySelectorAll("#expenseTable tbody tr")).map(row => ({
        category: row.cells[0].querySelector("select").value,
      name: row.cells[1].querySelector("input").value,
        budgeted: row.cells[2].querySelector("input").value,
        spent: row.cells[3].querySelector("input").value,
        remaining: row.cells[4].querySelector("input").value,
        dueDate: row.cells[5].querySelector("input").value,
        paidFrom: row.cells[6].querySelector("select").value
      })).filter(exp => exp.name);
      
      // Get notes
      const notes = document.getElementById("monthlyNotes").value;
      
      // Create HTML content for PDF
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Budget Report - ${selectedMonth}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .summary { display: flex; justify-content: space-around; margin-bottom: 30px; }
            .summary-item { text-align: center; padding: 10px; border: 1px solid #ccc; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
            th { background-color: #f5f5f5; }
            .section { margin-bottom: 30px; }
            .notes { margin-top: 20px; }
            @media print { body { margin: 0; } }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>üí∞ Bradley's Budget Tracker</h1>
            <h2>Budget Report - ${selectedMonth}</h2>
          </div>
          
          <div class="summary">
            <div class="summary-item">
              <h3>Total Income</h3>
              <p>${incomeTotal}</p>
            </div>
            <div class="summary-item">
              <h3>Budgeted</h3>
              <p>${budgetedTotal}</p>
            </div>
            <div class="summary-item">
              <h3>Spent</h3>
              <p>${spentTotal}</p>
            </div>
            <div class="summary-item">
              <h3>Remaining</h3>
              <p>${remainingTotal}</p>
            </div>
          </div>
          
          <div class="section">
            <h3>üí∞ Income Sources</h3>
            <table>
              <thead>
                <tr>
                  <th>Source</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                ${incomeRows.map(inc => `
                  <tr>
                    <td>${inc.source}</td>
                    <td>$${parseFloat(inc.amount || 0).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div class="section">
            <h3>üí≥ Expenses</h3>
            <table>
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Bill Name</th>
                  <th>Budgeted</th>
                  <th>Spent</th>
                  <th>Remaining</th>
                  <th>Due Date</th>
                  <th>Paid From</th>
                </tr>
              </thead>
              <tbody>
                ${expenseRows.map(exp => `
                  <tr>
                    <td>${exp.category}</td>
                    <td>${exp.name}</td>
                    <td>$${parseFloat(exp.budgeted || 0).toFixed(2)}</td>
                    <td>$${parseFloat(exp.spent || 0).toFixed(2)}</td>
                    <td>$${parseFloat(exp.remaining || 0).toFixed(2)}</td>
                    <td>${exp.dueDate || ''}</td>
                    <td>${exp.paidFrom || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          ${notes ? `
          <div class="notes">
            <h3>üìù Notes</h3>
            <p>${notes}</p>
          </div>
          ` : ''}
          
          <div style="margin-top: 30px; text-align: center; color: #666;">
            <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
          </div>
        </body>
        </html>
      `;
      
      // Write content to new window
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      // Wait for content to load, then print
      printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
      };
      
      if (window.ErrorHandler) {
        window.ErrorHandler.showSuccess('Budget exported to PDF successfully!');
  } else {
        alert('Budget exported to PDF successfully!');
      }
    }
    
    // Initialize page
document.addEventListener('DOMContentLoaded', function() {
      calculateBudget();
});
</script>

<footer style="text-align: center; margin-top: 40px; padding: 20px; font-weight: bold; font-size: 14px; color: #555; border-top: 1px solid #e5e7eb;">
  This is a product of Bradley Virtual Solutions, LLC
</footer>
</body>
</html>
