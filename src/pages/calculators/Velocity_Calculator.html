<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>Debt Crusher ‚Äì Velocity Banking Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- PWA Scrolling Fix -->
<script>
  // Fix PWA scrolling issues
  if (window.matchMedia('(display-mode: standalone)').matches) {
    document.addEventListener('DOMContentLoaded', function() {
      // Force enable scrolling in PWA mode
      document.body.style.overflow = 'auto';
      document.body.style.webkitOverflowScrolling = 'touch';
      document.documentElement.style.overflow = 'auto';
      document.documentElement.style.webkitOverflowScrolling = 'touch';
      
      // Prevent overscroll bounce
      document.body.style.overscrollBehavior = 'none';
      document.documentElement.style.overscrollBehavior = 'none';
      
      // Ensure proper height
      document.body.style.minHeight = '100vh';
      document.documentElement.style.height = '100%';
    });
  }
</script>

<style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            text-align: center;
        }
        form {
            margin-bottom: 20px;
        }
        input, button, select {
            width: calc(100% - 22px);
            margin: 10px 0;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007BFF;
            color: #fff;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .feedback {
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .high {
            background-color: #ffcccc;
            color: #cc0000;
        }
        .normal {
            background-color: #ccffcc;
            color: #006600;
        }
        .strategy {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
    
@media print {
  #user-name-display {
    display: block !important;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #000;
  }
}
</style>
<style media="print">
form, button { display: none !important; }
.strategy { page-break-after: always; }
table { page-break-inside: avoid; }
body { color-adjust: exact !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
</style><style>
#recommended-strategy {
  background: #e8f5e9;
  border: 2px solid #4caf50;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 0 10px rgba(76, 175, 80, 0.2);
}
#recommended-strategy h2 {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.recommendation-badge {
  background: #4CAF50;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-weight: bold;
  font-size: 14px;
}

/* Header and Navigation Styles */
.header {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  text-align: center;
  position: relative;
}

.back-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  color: #007bff;
  text-decoration: none;
  font-weight: 600;
  padding: 10px 16px;
  border-radius: 8px;
  background: rgba(0, 123, 255, 0.1);
  transition: all 0.3s ease;
  margin-bottom: 15px;
}

.back-link:hover {
  background: rgba(0, 123, 255, 0.2);
  transform: translateX(-5px);
}

.header h1 {
  color: #007bff;
  font-size: 2.2rem;
  margin: 10px 0;
  font-weight: 700;
}

/* Dark Mode Support */
body.dark-mode {
  background-color: #1a1a1a;
  color: #e0e0e0;
}

body.dark-mode .container {
  background: #2d2d2d;
  color: #e0e0e0;
}

body.dark-mode .header {
  background: #2d2d2d;
  color: #e0e0e0;
}

body.dark-mode .header h1 {
  color: #4a9eff;
}

body.dark-mode .back-link {
  color: #4a9eff;
  background: rgba(74, 158, 255, 0.1);
}

body.dark-mode .back-link:hover {
  background: rgba(74, 158, 255, 0.2);
}

body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
  background-color: #3d3d3d;
  color: #e0e0e0;
  border-color: #555;
}

body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus {
  border-color: #4a9eff;
  box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

body.dark-mode button {
  background-color: #4a9eff;
  color: white;
}

body.dark-mode button:hover {
  background-color: #357abd;
}

body.dark-mode table {
  background-color: #2d2d2d;
  color: #e0e0e0;
}

body.dark-mode th {
  background-color: #3d3d3d;
  color: #e0e0e0;
}

body.dark-mode tr:hover {
  background-color: #3d3d3d;
}

body.dark-mode .feedback.high {
  background-color: #4a1a1a;
  color: #ff6b6b;
}

body.dark-mode .feedback.normal {
  background-color: #1a4a1a;
  color: #6bff6b;
}

body.dark-mode #recommended-strategy {
  background: #1a2d1a;
  border-color: #4CAF50;
}

body.dark-mode .recommendation-badge {
  background: #4CAF50;
  color: white;
}

/* Help Section Styles */
.help-section {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

/* Modal Styles */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  overflow-y: auto;
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  position: absolute;
  top: 15px;
  right: 20px;
}

.close:hover {
  color: #000;
}

.help-section h3 {
  color: #007bff;
  margin-top: 20px;
  margin-bottom: 10px;
}

.help-section ul, .help-section ol {
  margin-left: 20px;
  margin-bottom: 15px;
}

.help-section li {
  margin-bottom: 5px;
}

/* Examples Grid */
.examples-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.example-card {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.example-card:hover {
  border-color: #007bff;
  background: #e3f2fd;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.example-card h3 {
  color: #007bff;
  margin-bottom: 15px;
}

.example-card p {
  margin: 8px 0;
  font-size: 0.9rem;
  color: #666;
}

/* Dark Mode Modal Styles */
body.dark-mode .modal-content {
  background-color: #2d2d2d;
  color: #e0e0e0;
}

body.dark-mode .close {
  color: #aaa;
}

body.dark-mode .close:hover {
  color: #fff;
}

body.dark-mode .example-card {
  background: #3d3d3d;
  border-color: #555;
  color: #e0e0e0;
}

body.dark-mode .example-card:hover {
  border-color: #4a9eff;
  background: #1a2d3d;
}

body.dark-mode .example-card h3 {
  color: #4a9eff;
}

body.dark-mode .example-card p {
  color: #ccc;
}

/* Warning Box Styles */
.warning-box {
  background: #fff3cd;
  border: 2px solid #ffc107;
  border-radius: 8px;
  padding: 15px;
  margin: 20px 0;
}

.warning-box h4 {
  color: #856404;
  margin-bottom: 10px;
}

.warning-box p {
  color: #856404;
  margin: 0;
  font-size: 0.9rem;
}

/* Dark Mode Warning Box */
body.dark-mode .warning-box {
  background: #3d2f00;
  border-color: #ffc107;
}

body.dark-mode .warning-box h4 {
  color: #ffc107;
}

body.dark-mode .warning-box p {
  color: #ffc107;
}

/* Help Section Improvements */
.help-section h3 {
  color: #007bff;
  margin-top: 25px;
  margin-bottom: 15px;
  padding-bottom: 5px;
  border-bottom: 2px solid #e9ecef;
}

.help-section h3:first-child {
  margin-top: 0;
}

.help-section ul, .help-section ol {
  margin-left: 20px;
  margin-bottom: 20px;
}

.help-section li {
  margin-bottom: 8px;
  line-height: 1.5;
}

.help-section strong {
  color: #495057;
  font-weight: 600;
}

/* Dark Mode Help Section */
body.dark-mode .help-section h3 {
  color: #4a9eff;
  border-bottom-color: #555;
}

body.dark-mode .help-section strong {
  color: #e0e0e0;
}

/* Suggestion Box Styles */
.suggestion-box {
  background: #e3f2fd;
  border: 2px solid #2196f3;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
}

.suggestion-box h4 {
  color: #1976d2;
  margin-bottom: 10px;
}

.suggestion-box p {
  margin: 5px 0;
  color: #333;
}

/* Dark Mode Suggestion Box */
body.dark-mode .suggestion-box {
  background: #1a2d3d;
  border-color: #4a9eff;
}

body.dark-mode .suggestion-box h4 {
  color: #4a9eff;
}

body.dark-mode .suggestion-box p {
  color: #e0e0e0;
}

.summary-dashboard {
  display: grid;
  gap: 16px;
  margin-top: 24px;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

.summary-card {
  background: linear-gradient(135deg, rgba(0, 123, 255, 0.08), rgba(0, 123, 255, 0));
  border: 1px solid rgba(0, 123, 255, 0.18);
  border-radius: 14px;
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  position: relative;
  overflow: hidden;
}

.summary-card h3 {
  font-size: 1rem;
  margin: 0;
  color: #0f172a;
}

.summary-card .summary-value {
  font-size: 1.6rem;
  font-weight: 700;
  color: #0f172a;
}

.summary-card .summary-subtext {
  font-size: 0.85rem;
  color: #475569;
}

.summary-card::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
  opacity: 0.6;
  pointer-events: none;
}

body.dark-mode .summary-card {
  background: linear-gradient(135deg, rgba(74, 158, 255, 0.12), rgba(15, 23, 42, 0.6));
  border-color: rgba(148, 163, 184, 0.25);
}

body.dark-mode .summary-card h3,
body.dark-mode .summary-card .summary-value {
  color: #e2e8f0;
}

body.dark-mode .summary-card .summary-subtext {
  color: #94a3b8;
}

.cashflow-section {
  margin-top: 32px;
  background: #fff;
  border-radius: 14px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  padding: 20px;
  box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
}

.cashflow-section h3 {
  margin-top: 0;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
}

body.dark-mode .cashflow-section {
  background: rgba(15, 23, 42, 0.85);
  border-color: rgba(148, 163, 184, 0.25);
  box-shadow: none;
}

.scenario-manager {
  margin-top: 24px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-radius: 12px;
  padding: 18px;
  background: rgba(15, 23, 42, 0.02);
}

.scenario-manager h3 {
  margin-top: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.scenario-list {
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.scenario-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 10px;
  padding: 10px 12px;
  border: 1px solid rgba(15, 23, 42, 0.08);
}

.scenario-row span {
  font-weight: 600;
  color: #0f172a;
}

.scenario-actions {
  display: flex;
  gap: 8px;
}

.scenario-actions button {
  width: auto;
  padding: 6px 10px;
  margin: 0;
  font-size: 0.85rem;
}

body.dark-mode .scenario-manager {
  background: rgba(15, 23, 42, 0.6);
  border-color: rgba(148, 163, 184, 0.25);
}

body.dark-mode .scenario-row {
  background: rgba(30, 41, 59, 0.65);
  border-color: rgba(148, 163, 184, 0.18);
}

body.dark-mode .scenario-row span {
  color: #e2e8f0;
}

.risk-assessment {
  margin-top: 24px;
  border-radius: 12px;
  border: 1px solid rgba(248, 113, 113, 0.25);
  background: rgba(248, 113, 113, 0.08);
  padding: 18px;
}

.risk-assessment h3 {
  margin-top: 0;
  color: #b91c1c;
}

.risk-list {
  list-style: none;
  padding: 0;
  margin: 12px 0 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.risk-list li {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 10px;
  padding: 8px 12px;
  border: 1px solid rgba(248, 113, 113, 0.2);
  color: #b91c1c;
}

body.dark-mode .risk-assessment {
  background: rgba(248, 113, 113, 0.18);
  border-color: rgba(248, 113, 113, 0.35);
}

body.dark-mode .risk-list li {
  background: rgba(30, 41, 59, 0.65);
  border-color: rgba(248, 113, 113, 0.35);
  color: #fecaca;
}

.action-plan {
  margin-top: 24px;
  border-radius: 12px;
  border: 1px solid rgba(34, 197, 94, 0.22);
  background: rgba(34, 197, 94, 0.08);
  padding: 18px;
}

.action-plan h3 {
  margin-top: 0;
  color: #166534;
}

.action-list {
  margin: 12px 0 0;
  padding-left: 18px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

body.dark-mode .action-plan {
  background: rgba(22, 101, 52, 0.35);
  border-color: rgba(34, 197, 94, 0.35);
}

body.dark-mode .action-plan h3 {
  color: #bbf7d0;
}

body.dark-mode .action-list li {
  color: #dcfce7;
}

.mini-card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-top: 18px;
}

.mini-card {
  background: rgba(15, 23, 42, 0.03);
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-radius: 12px;
  padding: 12px 14px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.mini-card strong {
  font-size: 0.9rem;
}

body.dark-mode .mini-card {
  background: rgba(15, 23, 42, 0.65);
  border-color: rgba(148, 163, 184, 0.2);
  color: #e2e8f0;
}

.chart-container {
  position: relative;
  height: 260px;
  margin-top: 16px;
}

.btn-inline {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: #0f172a;
  color: #f8fafc;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn-inline:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(15, 23, 42, 0.2);
}

body.dark-mode .btn-inline {
  background: #4a9eff;
  color: #0f172a;
}

</style></head>
<body>
<div class="container">
    <div class="header">
        <a href="/index.html" class="back-link">
            ‚Üê Back to Dashboard
        </a>
<h1>Debt Crusher ‚Äì Velocity Banking Tool</h1>
        <div class="help-section">
            <button id="helpToggle" class="btn btn-outline" onclick="toggleHelp()">‚ùì Help & Tutorial</button>
            <button id="examplesToggle" class="btn btn-outline" onclick="toggleExamples()">üìã Examples</button>
        </div>
    </div>
<form id="calculator-form">
<label for="userName">Your Name (optional):</label>
<input id="userName" name="userName" placeholder="Enter your name" type="text"/>
<label for="income">Monthly Income ($)</label>
<input id="income" required="" step="0.01" type="number" title="Enter your monthly income"/>
<label for="extraIncome">Yearly Extra Income ($)</label>
<input id="extraIncome" required="" step="0.01" type="number" title="Enter any additional yearly income"/>
<label for="expenses">Monthly Expenses ($)</label>
<input id="expenses" required="" step="0.01" type="number" title="Enter your monthly expenses"/>
<label for="debtBalance">Total Debt Balance ($)</label>
<input id="debtBalance" required="" step="0.01" type="number" title="Enter your total debt balance"/>
<label for="interestRate">Average Interest Rate (%)</label>
<input id="interestRate" required="" step="0.01" type="number" title="Enter the average interest rate on your debts"/>
<label for="minimumPayment">Minimum Monthly Payment ($)</label>
<input id="minimumPayment" required="" step="0.01" type="number" title="Enter your minimum monthly payment"/>
<label for="extraPayment">Extra Payment ($)</label>
<input id="extraPayment" step="0.01" type="number" title="Enter any extra payment you can make monthly"/>
<label for="lineOfCredit">Select Velocity Banking Line of Credit:</label>
<select id="lineOfCredit" required="" title="Select the type of line of credit you are using">
<option value="creditCard">Credit Card</option>
<option value="HELOC">HELOC</option>
<option value="personalLoan">Personal Loan</option>
<option value="businessLoan">Business Loan</option>
<option value="ploc">PLOC (e.g., NetCredit)</option>
</select>
<label for="lineOfCreditLimit">Line of Credit Limit ($)</label>
<input id="lineOfCreditLimit" step="0.01" type="number" placeholder="Optional ‚Äì helps assess utilization"/>
<label for="locDrawFee">Draw Fee (% of chunk amount)</label>
<input id="locDrawFee" step="0.01" type="number" placeholder="e.g., 3 for 3%"/>
<label for="locAnnualFee">Annual LOC Fee ($)</label>
<input id="locAnnualFee" step="0.01" type="number" placeholder="Enter 0 if none"/>
<label for="teaserRate">Intro/Teaser Rate (%)</label>
<input id="teaserRate" step="0.01" type="number" placeholder="Optional introductory APR"/>
<label for="teaserMonths">Months at Intro Rate</label>
<input id="teaserMonths" type="number" min="0" step="1" placeholder="Number of months the teaser rate lasts"/>
<label for="emergencyFund">Emergency Fund Balance ($)</label>
<input id="emergencyFund" step="0.01" type="number" placeholder="Optional ‚Äì used for readiness checks"/>
<label for="chunkPayment">Velocity Banking Chunk Payment ($)</label>
<input id="chunkPayment" required="" step="0.01" type="number" title="Enter the chunk payment amount for velocity banking"/>
<label for="chunkMonths">Months for Chunk Payments (comma-separated, e.g., 3,6,12)</label>
<input id="chunkMonths" placeholder="e.g., 3,6,12" type="text" title="Enter the months for chunk payments, separated by commas"/>
<button type="submit">Calculate</button>
<button id="saveInputs" type="button">Save Inputs</button>
<button id="loadInputs" type="button">Load Inputs</button>
<button id="exportPdf" type="button">Export Strategy as PDF</button>
<button id="exportCsv" type="button">üìä Export to CSV</button>
<label><input id="limitMonthsToggle" style="width:auto; margin-right:10px;" type="checkbox"/> Limit table to first 60 months</label>
</form>
<div class="scenario-manager">
  <h3>üìÇ Scenario Manager</h3>
  <div style="display:flex; flex-wrap: wrap; gap:12px; align-items:flex-end;">
    <div style="flex:1 1 220px;">
      <label for="scenarioName">Scenario Name</label>
      <input id="scenarioName" placeholder="e.g., Aggressive plan Q1" type="text"/>
    </div>
    <button id="saveScenarioBtn" class="btn-inline" type="button">üíæ Save Scenario</button>
    <button id="clearScenariosBtn" class="btn-inline" type="button" style="background:#c026d3;">üóëÔ∏è Clear All</button>
  </div>
  <div id="scenarioList" class="scenario-list"></div>
</div>
<div id="feedback"></div>
<div id="user-name-display" style="font-size: 18px; font-weight: bold; margin-top: 20px;"></div>
<div id="summaryDashboard" class="summary-dashboard" style="display:none;"></div>
<div id="results"></div>
<section id="cashflowSection" class="cashflow-section" style="display:none;">
  <h3>üìà Cash Flow Timeline</h3>
  <p style="margin:0;">Tracks monthly debt payments against available cash flow so you can spot tight months before they arrive.</p>
  <div class="chart-container">
    <canvas id="cashflowChart"></canvas>
  </div>
</section>
<section id="riskAssessment" class="risk-assessment" style="display:none;">
  <h3>‚ö†Ô∏è Risk Guardrails</h3>
  <ul class="risk-list" id="riskList"></ul>
</section>
<section id="actionPlan" class="action-plan" style="display:none;">
  <h3>üó∫Ô∏è 90-Day Action Plan</h3>
  <ol class="action-list" id="actionList"></ol>
</section>
<div id="recommended-strategy" style="margin-top: 30px;">
<h2>Recommended Strategy<span class="recommendation-badge">RECOMMENDED</span></h2>
<div id="recommended-strategy-details"></div>
</div>
<div id="loadingIndicator" style="display: none; text-align: center; margin: 20px 0;">
  <p>Loading...</p>
</div>
<div id="pdfLoadingIndicator" style="display: none; text-align: center; margin: 20px 0;">
  <p>Generating PDF...</p>
</div>
<footer style="text-align: center; margin-top: 40px; font-weight: bold; font-size: 14px; color: #555;">This is a product of Bradley Virtual Solutions, LLC</footer></div>

<!-- Help Modal -->
<div id="helpModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="toggleHelp()">&times;</span>
        <h2>üöÄ Velocity Banking Tutorial</h2>
        
        <div class="help-section">
            <h3>What is Velocity Banking?</h3>
            <p>Velocity Banking is a debt payoff strategy that uses a line of credit to accelerate debt elimination. Instead of making small monthly payments, you make large "chunk" payments at strategic intervals.</p>
            
            <h3>How It Works:</h3>
            <ol>
                <li><strong>Get a Line of Credit:</strong> Credit card, HELOC, or personal line of credit (PLOC)</li>
                <li><strong>Make Chunk Payments:</strong> Use the line of credit to make large payments</li>
                <li><strong>Pay Off Line of Credit:</strong> Use your regular income to pay off the line of credit</li>
                <li><strong>Repeat:</strong> Continue until debt is eliminated</li>
            </ol>
            
            <h3>Key Benefits:</h3>
            <ul>
                <li>‚úÖ Faster debt elimination</li>
                <li>‚úÖ Reduced total interest paid</li>
                <li>‚úÖ Psychological momentum</li>
                <li>‚úÖ Flexible payment timing</li>
            </ul>
            
            <h3>‚ö†Ô∏è Important Risk Warnings:</h3>
            <ul>
                <li><strong>Credit Score Impact:</strong> High credit utilization can lower your score temporarily</li>
                <li><strong>Interest Rate Risks:</strong> Variable rates on lines of credit can increase</li>
                <li><strong>Discipline Required:</strong> Must maintain strict payment schedule or risk financial disaster</li>
                <li><strong>Emergency Fund:</strong> Never use emergency savings for chunk payments</li>
                <li><strong>Job Security:</strong> Requires stable, reliable income source</li>
            </ul>
            
            <h3>‚úÖ Prerequisites & Requirements:</h3>
            <ul>
                <li><strong>Credit Score:</strong> Minimum 680+ for best rates (720+ preferred)</li>
                <li><strong>Income Stability:</strong> Consistent, verifiable income for 2+ years</li>
                <li><strong>Debt-to-Income:</strong> Maximum 43% DTI ratio for approval</li>
                <li><strong>Emergency Fund:</strong> 3-6 months expenses saved first</li>
                <li><strong>Documentation:</strong> Tax returns, pay stubs, bank statements</li>
            </ul>
            
            <h3>üìã Pre-Velocity Checklist:</h3>
            <ol>
                <li>‚úÖ Build emergency fund (3-6 months expenses)</li>
                <li>‚úÖ Improve credit score to 680+</li>
                <li>‚úÖ Calculate all monthly obligations</li>
                <li>‚úÖ Get pre-approved for line of credit</li>
                <li>‚úÖ Create detailed budget and stick to it</li>
                <li>‚úÖ Have backup plan if income changes</li>
            </ol>
            
            <h3>üìÖ Monthly Implementation Workflow:</h3>
            <ol>
                <li><strong>Week 1:</strong> Make minimum payment on debt</li>
                <li><strong>Week 2:</strong> Save money for chunk payment</li>
                <li><strong>Week 3:</strong> Continue saving, monitor progress</li>
                <li><strong>Week 4:</strong> Make chunk payment (if scheduled month)</li>
                <li><strong>Ongoing:</strong> Pay off line of credit monthly</li>
            </ol>

            <h3>üìÇ Scenario Manager</h3>
            <p>Use the Scenario Manager (above the calculator) to save different plans and compare them later.</p>
            <ul>
                <li><strong>Save Scenario:</strong> Enter a descriptive name (e.g., ‚ÄúAggressive Q2 Plan‚Äù) and click <em>Save Scenario</em>.</li>
                <li><strong>Load:</strong> Prefills the form with the stored inputs so you can review or tweak them.</li>
                <li><strong>Run:</strong> Loads the inputs and immediately recalculates so you can compare dashboards back-to-back.</li>
                <li><strong>Delete:</strong> Removes that entry from the list.</li>
                <li><strong>Clear All:</strong> Wipes the library if you want to start fresh (data is stored in your browser only).</li>
            </ul>
            
            <h3>‚ùå Common Mistakes to Avoid:</h3>
            <ul>
                <li><strong>Overextending Credit:</strong> Don't max out your line of credit</li>
                <li><strong>Missing Payments:</strong> Late payments can destroy your credit</li>
                <li><strong>Poor Timing:</strong> Don't start during job uncertainty or major expenses</li>
                <li><strong>Ignoring Fees:</strong> Watch for annual fees, balance transfer fees</li>
                <li><strong>Not Tracking:</strong> Monitor progress monthly and adjust as needed</li>
                <li><strong>Emotional Decisions:</strong> Stick to the plan, don't deviate</li>
            </ul>
            
            <h3>üéØ Advanced Strategies:</h3>
            <ul>
                <li><strong>Debt Prioritization:</strong> Target highest interest debts first</li>
                <li><strong>Seasonal Bonuses:</strong> Use tax refunds, bonuses for extra chunks</li>
                <li><strong>Scaling Up:</strong> Increase chunk amounts as debt decreases</li>
                <li><strong>Multiple Debts:</strong> Focus on one debt at a time for maximum impact</li>
                <li><strong>Goal Setting:</strong> Set realistic 12-24 month payoff targets</li>
            </ul>
            
            <h3>üì± Recommended Tools & Resources:</h3>
            <ul>
                <li><strong>Budgeting Apps:</strong> YNAB, Mint, or EveryDollar</li>
                <li><strong>Credit Monitoring:</strong> Credit Karma, Experian</li>
                <li><strong>Debt Tracking:</strong> Undebt.it, Debt Payoff Planner</li>
                <li><strong>Education:</strong> Dave Ramsey, The Money Guy Show</li>
                <li><strong>Community:</strong> Reddit r/personalfinance, Facebook groups</li>
            </ul>
            
            <h3>Input Guidelines:</h3>
            <ul>
                <li><strong>Minimum Payment:</strong> Must be at least equal to monthly interest</li>
                <li><strong>Chunk Payment:</strong> Should be 2-3x your monthly payment</li>
                <li><strong>Chunk Months:</strong> Space payments 3-6 months apart</li>
                <li><strong>Line of Credit:</strong> Choose based on your credit profile</li>
            </ul>

            <h3>üìä Reading the Dashboard</h3>
            <ul>
                <li><strong>Summary Cards:</strong> Highlight total interest/fee savings, months removed, and the fee load of the recommended plan.</li>
                <li><strong>Cash Flow Timeline:</strong> The blue line is debt service; the green line is the cushion that‚Äôs left. Watch for months where the lines cross.</li>
                <li><strong>Risk Guardrails:</strong> Flags high DTI, tight cash flow, small emergency funds, and chunk amounts that exceed your LOC limit.</li>
                <li><strong>90-Day Action Plan:</strong> Converts the recommendation into a checklist (chunk schedule, automation, savings goals).</li>
                <li><strong>Strategy Tables:</strong> Compare total cost, months, and cash cushion across each payoff approach.</li>
            </ul>
            
            <h3>Example Scenario:</h3>
            <p>Debt: $50,000 at 15% APR<br>
            Monthly Payment: $1,500<br>
            Chunk Payment: $3,000 every 3 months<br>
            Result: Pay off 2-3 years faster!</p>
            
            <div class="warning-box">
                <h4>‚ö†Ô∏è Legal Disclaimer:</h4>
                <p>This calculator is for educational purposes only. Always consult with a qualified financial advisor before making major financial decisions. Results are estimates and actual outcomes may vary based on individual circumstances.</p>
            </div>
        </div>
    </div>
</div>

<!-- Examples Modal -->
<div id="examplesModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="toggleExamples()">&times;</span>
        <h2>üìã Example Scenarios</h2>
        
        <div class="examples-grid">
            <div class="example-card" onclick="loadExample('credit-card')">
                <h3>üí≥ Credit Card Debt</h3>
                <p>Debt: $25,000 at 24% APR</p>
                <p>Income: $5,000/month</p>
                <p>Expenses: $3,500/month</p>
                <p>Min Payment: $750</p>
                <p>Chunk: $1,500 every 3 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('student-loan')">
                <h3>üéì Student Loan</h3>
                <p>Debt: $80,000 at 6.8% APR</p>
                <p>Income: $6,000/month</p>
                <p>Expenses: $4,000/month</p>
                <p>Min Payment: $1,200</p>
                <p>Chunk: $2,500 every 4 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('car-loan')">
                <h3>üöó Car Loan</h3>
                <p>Debt: $35,000 at 5.9% APR</p>
                <p>Income: $4,500/month</p>
                <p>Expenses: $3,200/month</p>
                <p>Min Payment: $650</p>
                <p>Chunk: $1,300 every 2 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('personal-loan')">
                <h3>üè¶ Personal Loan</h3>
                <p>Debt: $15,000 at 12% APR</p>
                <p>Income: $3,500/month</p>
                <p>Expenses: $2,800/month</p>
                <p>Min Payment: $400</p>
                <p>Chunk: $800 every 3 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('mortgage')">
                <h3>üè† Mortgage</h3>
                <p>Debt: $300,000 at 7.5% APR</p>
                <p>Income: $8,000/month</p>
                <p>Expenses: $5,500/month</p>
                <p>Min Payment: $2,100</p>
                <p>Chunk: $4,200 every 6 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('business-debt')">
                <h3>üíº Business Debt</h3>
                <p>Debt: $75,000 at 18% APR</p>
                <p>Income: $12,000/month</p>
                <p>Expenses: $8,500/month</p>
                <p>Min Payment: $1,500</p>
                <p>Chunk: $3,000 every 2 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('medical-debt')">
                <h3>üè• Medical Debt</h3>
                <p>Debt: $45,000 at 0% APR</p>
                <p>Income: $4,200/month</p>
                <p>Expenses: $3,100/month</p>
                <p>Min Payment: $500</p>
                <p>Chunk: $1,200 every 4 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('home-equity')">
                <h3>üè° Home Equity Loan</h3>
                <p>Debt: $120,000 at 8.2% APR</p>
                <p>Income: $9,500/month</p>
                <p>Expenses: $6,800/month</p>
                <p>Min Payment: $1,800</p>
                <p>Chunk: $3,600 every 3 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('consolidation')">
                <h3>üîÑ Debt Consolidation</h3>
                <p>Debt: $60,000 at 14% APR</p>
                <p>Income: $6,500/month</p>
                <p>Expenses: $4,200/month</p>
                <p>Min Payment: $1,200</p>
                <p>Chunk: $2,400 every 3 months</p>
            </div>
            
            <div class="example-card" onclick="loadExample('high-income')">
                <h3>üí∞ High Income Scenario</h3>
                <p>Debt: $200,000 at 6% APR</p>
                <p>Income: $25,000/month</p>
                <p>Expenses: $15,000/month</p>
                <p>Min Payment: $2,500</p>
                <p>Chunk: $8,000 every 2 months</p>
            </div>
        </div>
    </div>
</div>
<script>
        // Check for global dark mode setting and apply it
        function applyDarkMode() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // Format currency with proper comma separators
        function formatCurrency(amount) {
            return `$${parseFloat(amount).toLocaleString('en-US', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            })}`;
        }

        // Modal functions
        function toggleHelp() {
            const modal = document.getElementById('helpModal');
            modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
        }

        function toggleExamples() {
            const modal = document.getElementById('examplesModal');
            modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
        }

        window.toggleHelp = toggleHelp;
        window.toggleExamples = toggleExamples;

        // Close modals when clicking outside
        window.onclick = function(event) {
            const helpModal = document.getElementById('helpModal');
            const examplesModal = document.getElementById('examplesModal');
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
            if (event.target === examplesModal) {
                examplesModal.style.display = 'none';
            }
        }

        // Example scenarios data
        const examples = {
            'credit-card': {
                income: 5000,
                extraIncome: 0,
                expenses: 3500,
                debtBalance: 25000,
                interestRate: 24,
                minimumPayment: 750,
                extraPayment: 0,
                lineOfCredit: 'creditCard',
                chunkPayment: 1500,
                chunkMonths: '3,6,9,12'
            },
            'student-loan': {
                income: 6000,
                extraIncome: 0,
                expenses: 4000,
                debtBalance: 80000,
                interestRate: 6.8,
                minimumPayment: 1200,
                extraPayment: 0,
                lineOfCredit: 'personalLoan',
                chunkPayment: 2500,
                chunkMonths: '4,8,12,16'
            },
            'car-loan': {
                income: 4500,
                extraIncome: 0,
                expenses: 3200,
                debtBalance: 35000,
                interestRate: 5.9,
                minimumPayment: 650,
                extraPayment: 0,
                lineOfCredit: 'personalLoan',
                chunkPayment: 1300,
                chunkMonths: '2,4,6,8'
            },
            'personal-loan': {
                income: 3500,
                extraIncome: 0,
                expenses: 2800,
                debtBalance: 15000,
                interestRate: 12,
                minimumPayment: 400,
                extraPayment: 0,
                lineOfCredit: 'creditCard',
                chunkPayment: 800,
                chunkMonths: '3,6,9'
            },
            'mortgage': {
                income: 8000,
                extraIncome: 0,
                expenses: 5500,
                debtBalance: 300000,
                interestRate: 7.5,
                minimumPayment: 2100,
                extraPayment: 0,
                lineOfCredit: 'HELOC',
                chunkPayment: 4200,
                chunkMonths: '6,12,18,24'
            },
            'business-debt': {
                income: 12000,
                extraIncome: 0,
                expenses: 8500,
                debtBalance: 75000,
                interestRate: 18,
                minimumPayment: 1500,
                extraPayment: 0,
                lineOfCredit: 'businessLoan',
                chunkPayment: 3000,
                chunkMonths: '2,4,6,8,10'
            },
            'medical-debt': {
                income: 4200,
                extraIncome: 0,
                expenses: 3100,
                debtBalance: 45000,
                interestRate: 0,
                minimumPayment: 500,
                extraPayment: 0,
                lineOfCredit: 'personalLoan',
                chunkPayment: 1200,
                chunkMonths: '4,8,12,16,20'
            },
            'home-equity': {
                income: 9500,
                extraIncome: 0,
                expenses: 6800,
                debtBalance: 120000,
                interestRate: 8.2,
                minimumPayment: 1800,
                extraPayment: 0,
                lineOfCredit: 'HELOC',
                chunkPayment: 3600,
                chunkMonths: '3,6,9,12,15'
            },
            'consolidation': {
                income: 6500,
                extraIncome: 0,
                expenses: 4200,
                debtBalance: 60000,
                interestRate: 14,
                minimumPayment: 1200,
                extraPayment: 0,
                lineOfCredit: 'personalLoan',
                chunkPayment: 2400,
                chunkMonths: '3,6,9,12,15'
            },
            'high-income': {
                income: 25000,
                extraIncome: 0,
                expenses: 15000,
                debtBalance: 200000,
                interestRate: 6,
                minimumPayment: 2500,
                extraPayment: 0,
                lineOfCredit: 'HELOC',
                chunkPayment: 8000,
                chunkMonths: '2,4,6,8,10,12'
            }
        };

        // Load example scenario
        function loadExample(exampleType) {
            const example = examples[exampleType];
            if (!example) return;

            // Populate form fields
            document.getElementById('income').value = example.income;
            document.getElementById('extraIncome').value = example.extraIncome;
            document.getElementById('expenses').value = example.expenses;
            document.getElementById('debtBalance').value = example.debtBalance;
            document.getElementById('interestRate').value = example.interestRate;
            document.getElementById('minimumPayment').value = example.minimumPayment;
            document.getElementById('extraPayment').value = example.extraPayment;
            document.getElementById('lineOfCredit').value = example.lineOfCredit;
            document.getElementById('chunkPayment').value = example.chunkPayment;
            document.getElementById('chunkMonths').value = example.chunkMonths;

            // Close modal
            toggleExamples();

            // Show success message
            if (window.ErrorHandler) {
                window.ErrorHandler.showSuccess(`Loaded ${exampleType.replace('-', ' ')} example! Click Calculate to see results.`);
            } else {
                alert(`Loaded ${exampleType.replace('-', ' ')} example! Click Calculate to see results.`);
            }
        }

        // Input suggestions based on debt amount
        function provideInputSuggestions() {
            const debtBalance = parseFloat(document.getElementById('debtBalance').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            
            if (debtBalance > 0 && interestRate > 0) {
                const monthlyInterest = debtBalance * (interestRate / 100 / 12);
                const suggestedMinPayment = Math.ceil(monthlyInterest + 100);
                const suggestedChunkPayment = Math.ceil(suggestedMinPayment * 2);
                
                // Update placeholders with suggestions
                document.getElementById('minimumPayment').placeholder = `Suggested: $${suggestedMinPayment.toLocaleString()}`;
                document.getElementById('chunkPayment').placeholder = `Suggested: $${suggestedChunkPayment.toLocaleString()}`;
                
                // Show suggestions in feedback
                const feedback = document.getElementById('feedback');
                if (feedback) {
                    feedback.innerHTML = `
                        <div class="suggestion-box">
                            <h4>üí° Input Suggestions for $${debtBalance.toLocaleString()} debt at ${interestRate}% APR:</h4>
                            <p><strong>Minimum Payment:</strong> At least $${suggestedMinPayment.toLocaleString()} (covers $${monthlyInterest.toFixed(2)} interest + $100 principal)</p>
                            <p><strong>Chunk Payment:</strong> $${suggestedChunkPayment.toLocaleString()} (2x minimum payment)</p>
                            <p><strong>Chunk Months:</strong> 3,6,9,12 (every 3 months)</p>
                            <p><strong>Line of Credit:</strong> Credit Card (if available) or Personal Loan</p>
                        </div>
                    `;
                }
            }
        }

        // Add event listeners for input suggestions
        document.addEventListener('DOMContentLoaded', function() {
            const debtInput = document.getElementById('debtBalance');
            const interestInput = document.getElementById('interestRate');
            
            if (debtInput) {
                debtInput.addEventListener('input', provideInputSuggestions);
            }
            if (interestInput) {
                interestInput.addEventListener('input', provideInputSuggestions);
            }
        });

// Apply dark mode on page load
document.addEventListener('DOMContentLoaded', applyDarkMode);

// Listen for dark mode changes from other pages
window.addEventListener('storage', function(e) {
    if (e.key === 'darkMode') {
        applyDarkMode();
    }
});

window.onload = function () {
    function getLineOfCreditBehavior(type) {
        switch(type) {
            case 'creditCard':
                return { rateMultiplier: 1.05, description: 'Credit Card (daily compound)', defaultDrawFee: 3, defaultAnnualFee: 95, defaultLimit: 15000 };
            case 'HELOC':
                return { rateMultiplier: 1.0, description: 'HELOC (simple interest)', defaultDrawFee: 0, defaultAnnualFee: 0, defaultLimit: 50000 };
            case 'personalLoan':
                return { rateMultiplier: 0.95, description: 'Personal Loan (amortized)', defaultDrawFee: 0, defaultAnnualFee: 0, defaultLimit: 20000 };
            case 'businessLoan':
                return { rateMultiplier: 1.1, description: 'Business Loan (interest-only 3 months)', defaultDrawFee: 1.5, defaultAnnualFee: 149, defaultLimit: 40000 };
            case 'ploc':
                return { rateMultiplier: 1.0, description: 'PLOC (simple interest, fee included)', defaultDrawFee: 10, defaultAnnualFee: 0, defaultLimit: 10000 };
            default:
                return { rateMultiplier: 1.0, description: 'Standard', defaultDrawFee: 0, defaultAnnualFee: 0, defaultLimit: 15000 };
        }
    }

    function hydrateLocHints(type) {
        const behavior = getLineOfCreditBehavior(type);
        const drawInput = document.getElementById('locDrawFee');
        const annualInput = document.getElementById('locAnnualFee');
        const limitInput = document.getElementById('lineOfCreditLimit');
        if (drawInput) {
            drawInput.placeholder = behavior.defaultDrawFee ? `Suggested: ${behavior.defaultDrawFee}%` : 'Enter 0 if none';
            if (!drawInput.value && behavior.defaultDrawFee) {
                drawInput.value = behavior.defaultDrawFee;
            }
        }
        if (annualInput) {
            annualInput.placeholder = behavior.defaultAnnualFee ? `Suggested: $${behavior.defaultAnnualFee}` : 'Enter 0 if none';
            if (!annualInput.value && behavior.defaultAnnualFee) {
                annualInput.value = behavior.defaultAnnualFee;
            }
        }
        if (limitInput) {
            limitInput.placeholder = behavior.defaultLimit ? `Suggested: $${behavior.defaultLimit.toLocaleString()}` : limitInput.placeholder;
            if (!limitInput.value && behavior.defaultLimit) {
                limitInput.value = behavior.defaultLimit;
            }
        }
    }

    const locSelect = document.getElementById('lineOfCredit');
    hydrateLocHints(locSelect.value);
    locSelect.addEventListener('change', (event) => hydrateLocHints(event.target.value));

    const summaryDashboardEl = document.getElementById('summaryDashboard');
    const cashflowSectionEl = document.getElementById('cashflowSection');
    const riskSectionEl = document.getElementById('riskAssessment');
    const riskListEl = document.getElementById('riskList');
    const actionSectionEl = document.getElementById('actionPlan');
    const actionListEl = document.getElementById('actionList');
    const scenarioListEl = document.getElementById('scenarioList');
    let cashflowChartInstance = null;
    let lastComputedSnapshot = null;

    document.getElementById('saveInputs').addEventListener('click', function () {
        const loadingIndicator = document.getElementById("loadingIndicator");
        loadingIndicator.style.display = "block";
        try {
            const inputs = {
                income: document.getElementById('income').value,
                extraIncome: document.getElementById('extraIncome').value,
                expenses: document.getElementById('expenses').value,
                debtBalance: document.getElementById('debtBalance').value,
                interestRate: document.getElementById('interestRate').value,
                minimumPayment: document.getElementById('minimumPayment').value,
                extraPayment: document.getElementById('extraPayment').value,
                lineOfCredit: document.getElementById('lineOfCredit').value,
                lineOfCreditLimit: document.getElementById('lineOfCreditLimit').value,
                locDrawFee: document.getElementById('locDrawFee').value,
                locAnnualFee: document.getElementById('locAnnualFee').value,
                teaserRate: document.getElementById('teaserRate').value,
                teaserMonths: document.getElementById('teaserMonths').value,
                emergencyFund: document.getElementById('emergencyFund').value,
                chunkPayment: document.getElementById('chunkPayment').value,
                chunkMonths: document.getElementById('chunkMonths').value
            };
            localStorage.setItem('debtStrategyInputs', JSON.stringify(inputs));
            alert('Inputs saved successfully!');
        } catch (error) {
            alert("Error saving inputs: " + error.message);
        } finally {
            loadingIndicator.style.display = "none";
        }
    });

    document.getElementById('loadInputs').addEventListener('click', function () {
        const loadingIndicator = document.getElementById("loadingIndicator");
        loadingIndicator.style.display = "block";
        try {
            const savedInputs = localStorage.getItem('debtStrategyInputs');
            if (savedInputs) {
                const inputs = JSON.parse(savedInputs);
                document.getElementById('income').value = inputs.income;
                document.getElementById('extraIncome').value = inputs.extraIncome;
                document.getElementById('expenses').value = inputs.expenses;
                document.getElementById('debtBalance').value = inputs.debtBalance;
                document.getElementById('interestRate').value = inputs.interestRate;
                document.getElementById('minimumPayment').value = inputs.minimumPayment;
                document.getElementById('extraPayment').value = inputs.extraPayment;
                document.getElementById('lineOfCredit').value = inputs.lineOfCredit;
                document.getElementById('lineOfCreditLimit').value = inputs.lineOfCreditLimit || '';
                document.getElementById('locDrawFee').value = inputs.locDrawFee || '';
                document.getElementById('locAnnualFee').value = inputs.locAnnualFee || '';
                document.getElementById('teaserRate').value = inputs.teaserRate || '';
                document.getElementById('teaserMonths').value = inputs.teaserMonths || '';
                document.getElementById('emergencyFund').value = inputs.emergencyFund || '';
                document.getElementById('chunkPayment').value = inputs.chunkPayment;
                document.getElementById('chunkMonths').value = inputs.chunkMonths;
                hydrateLocHints(inputs.lineOfCredit);
                alert('Inputs loaded successfully!');
            } else {
                alert('No saved inputs found.');
            }
        } catch (error) {
            alert("Error loading inputs: " + error.message);
        } finally {
            loadingIndicator.style.display = "none";
        }
    });

    document.getElementById('exportCsv').addEventListener('click', function () {
        exportStrategyToCSV();
    });

    function collectInputState() {
        return {
            userName: document.getElementById('userName').value,
            income: document.getElementById('income').value,
            extraIncome: document.getElementById('extraIncome').value,
            expenses: document.getElementById('expenses').value,
            debtBalance: document.getElementById('debtBalance').value,
            interestRate: document.getElementById('interestRate').value,
            minimumPayment: document.getElementById('minimumPayment').value,
            extraPayment: document.getElementById('extraPayment').value,
            lineOfCredit: document.getElementById('lineOfCredit').value,
            lineOfCreditLimit: document.getElementById('lineOfCreditLimit').value,
            locDrawFee: document.getElementById('locDrawFee').value,
            locAnnualFee: document.getElementById('locAnnualFee').value,
            teaserRate: document.getElementById('teaserRate').value,
            teaserMonths: document.getElementById('teaserMonths').value,
            emergencyFund: document.getElementById('emergencyFund').value,
            chunkPayment: document.getElementById('chunkPayment').value,
            chunkMonths: document.getElementById('chunkMonths').value
        };
    }

    function applyInputState(state) {
        Object.entries(state).forEach(([key, value]) => {
            const element = document.getElementById(key);
            if (element !== null && element !== undefined) {
                element.value = value ?? '';
            }
        });
        if (state.lineOfCredit) {
            hydrateLocHints(state.lineOfCredit);
        }
    }

    function parseChunkMonths(value) {
        return (value || '')
            .split(',')
            .map(v => parseInt(v.trim(), 10))
            .filter(n => !isNaN(n) && n > 0);
    }

    function resetDynamicSections() {
        summaryDashboardEl.style.display = 'none';
        summaryDashboardEl.innerHTML = '';
        if (cashflowChartInstance) {
            cashflowChartInstance.destroy();
            cashflowChartInstance = null;
        }
        cashflowSectionEl.style.display = 'none';
        riskSectionEl.style.display = 'none';
        riskListEl.innerHTML = '';
        actionSectionEl.style.display = 'none';
        actionListEl.innerHTML = '';
    }

    function renderSummaryCards(cards) {
        if (!cards.length) {
            summaryDashboardEl.style.display = 'none';
            summaryDashboardEl.innerHTML = '';
            return;
        }

        summaryDashboardEl.style.display = 'grid';
        summaryDashboardEl.innerHTML = cards.map(card => `
            <div class="summary-card">
                <h3>${card.title}</h3>
                <span class="summary-value">${card.value}</span>
                <span class="summary-subtext">${card.subtext}</span>
            </div>
        `).join('');
    }

    function renderCashflowChart(labels, debtPayments, remainingCash) {
        if (!labels.length) {
            cashflowSectionEl.style.display = 'none';
            if (cashflowChartInstance) {
                cashflowChartInstance.destroy();
                cashflowChartInstance = null;
            }
            return;
        }

        cashflowSectionEl.style.display = 'block';
        const ctx = document.getElementById('cashflowChart').getContext('2d');
        if (cashflowChartInstance) {
            cashflowChartInstance.destroy();
        }

        cashflowChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Debt Service',
                        data: debtPayments,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.18)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Remaining Cash Flow',
                        data: remainingCash,
                        borderColor: '#16a34a',
                        backgroundColor: 'rgba(22, 163, 74, 0.18)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: context => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: {
                        ticks: {
                            callback: value => formatCurrency(value)
                        }
                    }
                }
            }
        });
    }

    function evaluateRisks(metrics) {
        const risks = [];
        if (metrics.dtiRatio > 43) {
            risks.push(`Debt-to-income ratio is ${metrics.dtiRatio.toFixed(1)}%. Lenders typically want this below 43%; consider lowering expenses or debt before proceeding.`);
        }
        if (metrics.cashFlow <= 0) {
            risks.push('Monthly cash flow is negative after expenses. Velocity banking requires positive cash flow to work safely.');
        }
        if (metrics.chunkPayment > 0 && metrics.lineOfCreditLimit > 0 && metrics.chunkPayment > metrics.lineOfCreditLimit) {
            risks.push(`Chunk payment ($${metrics.chunkPayment.toLocaleString()}) exceeds the available line-of-credit limit (${formatCurrency(metrics.lineOfCreditLimit)}). Reduce the chunk or request a higher limit.`);
        }
        if (metrics.emergencyFund > 0 && metrics.emergencyFund < metrics.expenses * 3) {
            const months = metrics.emergencyFund / metrics.expenses;
            risks.push(`Emergency fund covers ${months.toFixed(1)} month(s) of expenses. Aim for 3-6 months before launching this strategy.`);
        }
        if (metrics.velocityStrategy && metrics.velocityStrategy.totalFees > 0) {
            const feeShare = (metrics.velocityStrategy.totalFees / (metrics.velocityStrategy.totalInterest || 1)) * 100;
            if (feeShare > 25) {
                risks.push(`Draw and annual fees consume ${feeShare.toFixed(1)}% of the interest saved. Revisit chunk size or a lower-cost line of credit.`);
            }
        }
        if (metrics.teaserRate > 0) {
            risks.push(`Introductory rate of ${metrics.teaserRate.toFixed(2)}% ends after ${metrics.teaserMonths || 0} month(s). Ensure your budget can absorb the revert rate that follows.`);
        }
        if (!metrics.velocityStrategy) {
            risks.push('Chunk schedule is empty, so the velocity banking scenario was skipped. Add chunk months to evaluate the accelerated payoff.');
        }
        return risks;
    }

    function renderRiskList(risks) {
        if (!risks.length) {
            riskSectionEl.style.display = 'none';
            riskListEl.innerHTML = '';
            return;
        }
        riskSectionEl.style.display = 'block';
        riskListEl.innerHTML = risks.map(risk => `<li>${risk}</li>`).join('');
    }

    function renderActionPlan(items) {
        if (!items.length) {
            actionSectionEl.style.display = 'none';
            actionListEl.innerHTML = '';
            return;
        }
        actionSectionEl.style.display = 'block';
        actionListEl.innerHTML = items.map(item => `<li>${item}</li>`).join('');
    }

    function calculateStrategy({ name, debtBalance, getRate, baselinePayment, chunkPayment = 0, chunkMonths = [], cashFlow, drawFeePercent = 0, annualFee = 0 }) {
        const payments = [];
        const chunkSet = new Set(chunkMonths);
        let balance = debtBalance;
        let months = 0;
        let totalInterest = 0;
        let totalFees = 0;
        let totalPrincipalPaid = 0;

        while (balance > 0.01 && months < 1500) {
            const rate = getRate(months);
            const interest = balance * rate;
            totalInterest += interest;
            let actualPayment = baselinePayment;
            let chunkApplied = false;

            if (chunkSet.has(months + 1)) {
                actualPayment += chunkPayment;
                chunkApplied = true;
                if (drawFeePercent > 0) {
                    totalFees += chunkPayment * (drawFeePercent / 100);
                }
            }

            const minRequired = interest + 1;
            if (actualPayment < minRequired) {
                actualPayment = minRequired;
            }

            const paymentCeiling = balance + interest;
            if (actualPayment > paymentCeiling) {
                actualPayment = paymentCeiling;
            }

            balance = balance + interest - actualPayment;
            if (balance < 0) balance = 0;

            const principalPaid = actualPayment - interest;
            totalPrincipalPaid += principalPaid;

            if (annualFee > 0 && months > 0 && months % 12 === 0) {
                totalFees += annualFee;
            }

            const cashCommitment = chunkApplied ? baselinePayment : Math.min(baselinePayment, actualPayment);
            const remainingCash = cashFlow - cashCommitment;

            payments.push({
                monthIndex: months + 1,
                payment: actualPayment.toFixed(2),
                interest: interest.toFixed(2),
                balance: balance.toFixed(2),
                principalPaid: principalPaid.toFixed(2),
                chunkApplied,
                remainingCash: remainingCash.toFixed(2),
                cashCommitment: cashCommitment.toFixed(2)
            });

            months++;
        }

        const debtFreeDate = new Date();
        debtFreeDate.setMonth(debtFreeDate.getMonth() + months);

        return {
            strategyName: name,
            totalInterest,
            totalFees,
            months,
            debtFreeDate,
            yearsToPayoff: (months / 12).toFixed(2),
            totalPrincipalPaid,
            payments,
            chunkPayment,
            chunkMonths,
            baselinePayment
        };
    }

    function renderStrategy(strategy, savings, comparisonLabel) {
        const limited = strategy.months > 120 || document.getElementById('limitMonthsToggle').checked;
        const maxRows = limited ? 60 : strategy.payments.length;
        const notice = limited ? '<p><em>Only first 60 months shown. Full data is included in totals.</em></p>' : '';
        const totalCost = strategy.totalPrincipalPaid + strategy.totalInterest + (strategy.totalFees || 0);
        const savingsRow = typeof savings === 'number' ? `<p>Interest saved vs ${comparisonLabel}: ${formatCurrency(savings)}</p>` : '';
        const chunkRow = strategy.chunkPayment > 0 ? `<p>Chunk Plan: ${formatCurrency(strategy.chunkPayment)} in months ${strategy.chunkMonths.join(', ')}</p>` : '';

        return `
            <div class="strategy" style="border-top: 4px solid #4CAF50;">
                <h2>${strategy.strategyName
                    .replace('Minimum Payment', 'üí∞ Minimum Payment Strategy')
                    .replace('Velocity Banking', 'üöÄ Velocity Banking Strategy')
                    .replace('Minimum Payments with Extra Payment', 'üßÆ Extra Payment Strategy')}</h2>
                ${notice}
                <div class="mini-card-grid">
                    <div class="mini-card"><strong>Total Interest</strong><span>${formatCurrency(strategy.totalInterest)}</span></div>
                    <div class="mini-card"><strong>Total Fees</strong><span>${formatCurrency(strategy.totalFees || 0)}</span></div>
                    <div class="mini-card"><strong>Months to Payoff</strong><span>${strategy.months} (${strategy.yearsToPayoff} yrs)</span></div>
                    <div class="mini-card"><strong>Debt-Free Date</strong><span>${strategy.debtFreeDate.toLocaleDateString()}</span></div>
                </div>
                ${savingsRow}
                ${chunkRow}
                <p>Total amount paid (principal + interest + fees): ${formatCurrency(totalCost)}</p>
                <table>
                    <tr>
                        <th>Month</th>
                        <th>Payment ($)</th>
                        <th>Principal Paid ($)</th>
                        <th>Interest ($)</th>
                        <th>Balance ($)</th>
                        <th>Cash Cushion ($)</th>
                    </tr>
                    ${strategy.payments.slice(0, maxRows).map(p => `
                        <tr>
                            <td>${p.monthIndex}</td>
                            <td>${formatCurrency(p.payment)}</td>
                            <td>${formatCurrency(p.principalPaid)}</td>
                            <td>${formatCurrency(p.interest)}</td>
                            <td>${formatCurrency(p.balance)}</td>
                            <td>${formatCurrency(p.remainingCash)}</td>
                        </tr>
                    `).join('')}
                </table>
            </div>
        `;
    }

    function totalInterestCost(strategy) {
        return (strategy?.totalInterest || 0) + (strategy?.totalFees || 0);
    }

    function runCalculation(triggeredByScenario = false) {
        resetDynamicSections();
        const rawState = collectInputState();
        const feedback = document.getElementById('feedback');
        feedback.innerHTML = '';

        const parsed = {
            userName: rawState.userName?.trim() || '',
            income: parseFloat(rawState.income),
            extraIncome: parseFloat(rawState.extraIncome) || 0,
            expenses: parseFloat(rawState.expenses),
            debtBalance: parseFloat(rawState.debtBalance),
            interestRate: parseFloat(rawState.interestRate),
            minimumPayment: parseFloat(rawState.minimumPayment),
            extraPayment: parseFloat(rawState.extraPayment) || 0,
            lineOfCredit: rawState.lineOfCredit,
            lineOfCreditLimit: parseFloat(rawState.lineOfCreditLimit) || 0,
            locDrawFee: parseFloat(rawState.locDrawFee) || 0,
            locAnnualFee: parseFloat(rawState.locAnnualFee) || 0,
            teaserRate: parseFloat(rawState.teaserRate) || 0,
            teaserMonths: parseInt(rawState.teaserMonths || '0', 10) || 0,
            emergencyFund: parseFloat(rawState.emergencyFund) || 0,
            chunkPayment: parseFloat(rawState.chunkPayment) || 0,
            chunkMonths: parseChunkMonths(rawState.chunkMonths)
        };

        if (isNaN(parsed.income) || parsed.income <= 0) {
            feedback.innerHTML = `<p class="feedback high">Please enter a valid monthly income.</p>`;
            return null;
        }
        if (isNaN(parsed.expenses) || parsed.expenses < 0) {
            feedback.innerHTML = `<p class="feedback high">Please enter valid monthly expenses.</p>`;
            return null;
        }
        if (isNaN(parsed.debtBalance) || parsed.debtBalance <= 0) {
            feedback.innerHTML = `<p class="feedback high">Please enter a valid total debt balance.</p>`;
            return null;
        }
        if (isNaN(parsed.interestRate) || parsed.interestRate <= 0) {
            feedback.innerHTML = `<p class="feedback high">Please provide the average interest rate for your debt.</p>`;
            return null;
        }
        if (isNaN(parsed.minimumPayment) || parsed.minimumPayment <= 0) {
            feedback.innerHTML = `<p class="feedback high">Minimum payment must be greater than $0.</p>`;
            return null;
        }

        const baseMonthlyRate = parsed.interestRate / 100 / 12;
        const monthlyInterest = parsed.debtBalance * baseMonthlyRate;
        const minimumRequiredPayment = monthlyInterest + 1;

        if (parsed.minimumPayment < monthlyInterest) {
            feedback.innerHTML = `<p class="feedback high">Your minimum payment (${formatCurrency(parsed.minimumPayment)}) is less than the monthly interest (${formatCurrency(monthlyInterest)}). Increase the payment to at least ${formatCurrency(minimumRequiredPayment)}.</p>`;
            return null;
        }

        if (parsed.chunkPayment > 0 && parsed.chunkMonths.length === 0) {
            feedback.innerHTML = `<p class="feedback high">Add the months you plan to deploy velocity banking chunks (e.g., 3,6,12).</p>`;
            return null;
        }

        if (parsed.chunkPayment <= 0 && parsed.chunkMonths.length > 0) {
            feedback.innerHTML = `<p class="feedback high">Enter the chunk amount you plan to deploy or clear the months field.</p>`;
            return null;
        }

        if (parsed.minimumPayment < parsed.debtBalance * 0.01) {
            const suggestedMinPayment = Math.max(parsed.debtBalance * 0.02, minimumRequiredPayment);
            feedback.innerHTML += `<p class="feedback high">Consider increasing your minimum payment to at least ${formatCurrency(suggestedMinPayment)} for meaningful progress.</p>`;
        }

        const cashFlow = parsed.income - parsed.expenses;
        if (cashFlow <= 0) {
            feedback.innerHTML += `<p class="feedback high">Cash flow is negative after expenses. Velocity banking requires a positive monthly surplus.</p>`;
            return null;
        }

        const locBehavior = getLineOfCreditBehavior(parsed.lineOfCredit);
        const effectiveMonthlyRate = baseMonthlyRate * locBehavior.rateMultiplier;
        const teaserMonthlyRate = parsed.teaserRate > 0 ? parsed.teaserRate / 100 / 12 : null;
        const totalYearlyIncome = (parsed.income * 12) + parsed.extraIncome;
        const dtiRatio = (parsed.debtBalance / totalYearlyIncome) * 100;

        feedback.innerHTML += `
            <p>Yearly Income (with Extra): ${formatCurrency(totalYearlyIncome)}</p>
            <p>Available Cash Flow: ${formatCurrency(cashFlow)}</p>
            <p>Selected Line of Credit: ${locBehavior.description}</p>
            <p>Combined Monthly Commitment (Min + Extra): ${formatCurrency(parsed.minimumPayment + parsed.extraPayment)}</p>
            <p>Intro Rate Applied: ${teaserMonthlyRate ? `${parsed.teaserRate.toFixed(2)}% for ${parsed.teaserMonths} month(s)` : 'Using committed rate throughout'}</p>
        `;

        if (parsed.lineOfCredit === 'ploc') {
            feedback.innerHTML += `<p><em>Note: PLOC selected ‚Äî ensure provider fees (e.g., 10% draw fee) are reflected in chunk inputs.</em></p>`;
        }

        if (dtiRatio > 43) {
            feedback.innerHTML += `<p class="feedback high">‚ö†Ô∏è Debt-to-Income Ratio: ${dtiRatio.toFixed(2)}% (above lending comfort zone).</p>`;
        } else {
            feedback.innerHTML += `<p class="feedback normal">‚úÖ Debt-to-Income Ratio: ${dtiRatio.toFixed(2)}% (within normal limits).</p>`;
        }

        const minimumStrategy = calculateStrategy({
            name: 'Minimum Payment',
            debtBalance: parsed.debtBalance,
            getRate: () => baseMonthlyRate,
            baselinePayment: parsed.minimumPayment,
            cashFlow
        });

        const extraStrategy = calculateStrategy({
            name: 'Minimum Payments with Extra Payment',
            debtBalance: parsed.debtBalance,
            getRate: () => baseMonthlyRate,
            baselinePayment: parsed.minimumPayment + parsed.extraPayment,
            cashFlow
        });

        let velocityStrategy = null;
        if (parsed.chunkPayment > 0 && parsed.chunkMonths.length > 0) {
            const rateSchedule = (month) => {
                if (teaserMonthlyRate && month < parsed.teaserMonths) {
                    return teaserMonthlyRate;
                }
                return effectiveMonthlyRate;
            };
            velocityStrategy = calculateStrategy({
                name: 'Velocity Banking',
                debtBalance: parsed.debtBalance,
                getRate: rateSchedule,
                baselinePayment: cashFlow,
                chunkPayment: parsed.chunkPayment,
                chunkMonths: parsed.chunkMonths,
                cashFlow,
                drawFeePercent: parsed.locDrawFee,
                annualFee: parsed.locAnnualFee
            });
        }

        const interestSavedByExtra = totalInterestCost(minimumStrategy) - totalInterestCost(extraStrategy);
        const interestSavedByVelocity = velocityStrategy ? totalInterestCost(minimumStrategy) - totalInterestCost(velocityStrategy) : 0;

        const candidateStrategies = [minimumStrategy, extraStrategy];
        if (velocityStrategy) {
            candidateStrategies.push(velocityStrategy);
        }

        const bestStrategy = candidateStrategies.reduce((best, current) =>
            totalInterestCost(current) < totalInterestCost(best) ? current : best, minimumStrategy
        );

        const avgMonthlySavings = bestStrategy.months > 0
            ? (totalInterestCost(minimumStrategy) - totalInterestCost(bestStrategy)) / bestStrategy.months
            : 0;

        const monthsSaved = minimumStrategy.months - bestStrategy.months;

        const summaryCards = [
            {
                title: 'Interest + Fees Saved',
                value: formatCurrency(totalInterestCost(minimumStrategy) - totalInterestCost(bestStrategy)),
                subtext: 'Compared to staying with minimum payments'
            },
            {
                title: 'Months Saved',
                value: monthsSaved > 0 ? `${monthsSaved} mo` : '‚Äî',
                subtext: `Debt-free by ${bestStrategy.debtFreeDate.toLocaleDateString()}`
            },
            {
                title: 'Avg Monthly Savings',
                value: formatCurrency(avgMonthlySavings),
                subtext: 'Interest savings spread across payoff timeline'
            },
            {
                title: 'Total Fees (Recommended)',
                value: formatCurrency(bestStrategy.totalFees || 0),
                subtext: 'Draw + annual fees included in projection'
            }
        ];

        if (velocityStrategy) {
            summaryCards.push({
                title: 'Velocity Impact',
                value: formatCurrency(interestSavedByVelocity),
                subtext: 'Additional savings from chunk strategy'
            });
        }

        renderSummaryCards(summaryCards);

        const bestPayments = bestStrategy.payments.slice(0, 24);
        renderCashflowChart(
            bestPayments.map(p => `Month ${p.monthIndex}`),
            bestPayments.map(p => parseFloat(p.payment)),
            bestPayments.map(p => parseFloat(p.remainingCash))
        );

        const metrics = {
            dtiRatio,
            cashFlow,
            chunkPayment: parsed.chunkPayment,
            lineOfCreditLimit: parsed.lineOfCreditLimit,
            emergencyFund: parsed.emergencyFund,
            expenses: parsed.expenses,
            velocityStrategy,
            teaserRate: parsed.teaserRate,
            teaserMonths: parsed.teaserMonths
        };

        const riskItems = evaluateRisks(metrics);
        renderRiskList(riskItems);

        const actionItems = [
            `Automate a monthly transfer of ${formatCurrency(bestStrategy.baselinePayment)} toward debt payments.`,
            `Review cash flow each month to maintain at least ${formatCurrency(Math.max(0, cashFlow - bestStrategy.baselinePayment))} in cushion.`,
            `Track line-of-credit balance closely to stay within your limit${parsed.lineOfCreditLimit ? ` (${formatCurrency(parsed.lineOfCreditLimit)} max)` : ''}.`
        ];

        if (bestStrategy.chunkPayment > 0) {
            const estimatedFee = parsed.locDrawFee > 0 ? formatCurrency(bestStrategy.chunkPayment * (parsed.locDrawFee / 100)) : formatCurrency(0);
            actionItems.unshift(`Schedule ${formatCurrency(bestStrategy.chunkPayment)} chunk payments in months ${bestStrategy.chunkMonths.join(', ')} and reserve about ${estimatedFee} for draw fees each time.`);
        }
        if (parsed.emergencyFund < parsed.expenses * 3) {
            actionItems.push('Build emergency savings to at least 3 months of expenses before leaning on velocity banking.');
        }

        renderActionPlan(actionItems);

        let resultsHTML = '';
        if (velocityStrategy) {
            resultsHTML += renderStrategy(velocityStrategy, interestSavedByVelocity, 'Minimum Payments');
        } else {
            resultsHTML += `
                <div class="strategy" style="border-top: 4px solid #6c757d;">
                    <h3>üöÄ Velocity Banking Strategy</h3>
                    <p><em>No chunk schedule provided. Add chunk months to evaluate the accelerated payoff.</em></p>
                </div>
            `;
        }
        resultsHTML += renderStrategy(minimumStrategy, 0, 'Minimum Payments');
        resultsHTML += renderStrategy(extraStrategy, interestSavedByExtra, 'Minimum Payments');
        document.getElementById('results').innerHTML = resultsHTML;

        const cushion = cashFlow - bestStrategy.baselinePayment;
        let confidenceLevel;
        if (cushion >= cashFlow * 0.25) {
            confidenceLevel = 'üöÄ High Confidence ‚Äì Strong cash cushion';
        } else if (cushion >= cashFlow * 0.1) {
            confidenceLevel = '‚úÖ Moderate Confidence ‚Äì Monitor cash flow monthly';
        } else {
            confidenceLevel = '‚ö†Ô∏è Low Confidence ‚Äì Cushion is tight, keep extra reserves.';
        }

        const recommendedHtml = `
            <p><em>‚úÖ Recommended because it delivers the best payoff while respecting your cash flow.</em></p>
            <p><strong>Recommended Strategy:</strong> ${bestStrategy.strategyName}</p>
            <p>Total Interest: ${formatCurrency(bestStrategy.totalInterest)}</p>
            <p>Total Fees: ${formatCurrency(bestStrategy.totalFees || 0)}</p>
            <p>Months to Payoff: ${bestStrategy.months} (${bestStrategy.yearsToPayoff} years)</p>
            <p>Debt-Free Date: ${bestStrategy.debtFreeDate.toLocaleDateString()}</p>
            <p>Interest & Fees Saved vs Minimum: ${formatCurrency(totalInterestCost(minimumStrategy) - totalInterestCost(bestStrategy))}</p>
            <p>üí∞ Avg. Monthly Savings vs Minimum: ${formatCurrency(avgMonthlySavings)}</p>
            <p>üìä Payoff Confidence: <strong>${confidenceLevel}</strong></p>
        `;

        if (parsed.userName) {
            document.getElementById('user-name-display').innerHTML = `üìÑ Strategy Report for <strong>${parsed.userName}</strong>`;
        } else {
            document.getElementById('user-name-display').innerHTML = '';
        }
        document.getElementById('recommended-strategy-details').innerHTML = recommendedHtml;

        lastComputedSnapshot = {
            inputs: rawState,
            parsed,
            minimumStrategy,
            extraStrategy,
            velocityStrategy,
            bestStrategy,
            metrics: {
                dtiRatio,
                cashFlow,
                interestSaved: totalInterestCost(minimumStrategy) - totalInterestCost(bestStrategy),
                monthsSaved,
                avgMonthlySavings,
                interestSavedByVelocity,
                interestSavedByExtra
            }
        };

        if (!triggeredByScenario) {
            feedback.insertAdjacentHTML('afterbegin', `<p class="feedback normal">‚úîÔ∏è Calculation refreshed ${new Date().toLocaleTimeString()}.</p>`);
        }

        return lastComputedSnapshot;
    }

    document.getElementById('calculator-form').addEventListener('submit', function(event) {
        event.preventDefault();
        runCalculation();
    });

    function getScenarioStore() {
        return JSON.parse(localStorage.getItem('velocityScenarioLibrary') || '[]');
    }

    function setScenarioStore(list) {
        localStorage.setItem('velocityScenarioLibrary', JSON.stringify(list));
    }

    function renderScenarioList() {
        const scenarios = getScenarioStore();
        if (!scenarios.length) {
            scenarioListEl.innerHTML = `<p style="margin:8px 0;color:#64748b;">No saved scenarios yet. Run a calculation and click ‚ÄúSave Scenario‚Äù.</p>`;
            return;
        }

        scenarioListEl.innerHTML = scenarios.map(scenario => `
            <div class="scenario-row" data-id="${scenario.id}">
                <span>${scenario.name}</span>
                <div class="scenario-actions">
                    <button type="button" data-action="load" data-id="${scenario.id}">Load</button>
                    <button type="button" data-action="run" data-id="${scenario.id}">Run</button>
                    <button type="button" data-action="delete" data-id="${scenario.id}">Delete</button>
                </div>
            </div>
        `).join('');
    }

    document.getElementById('saveScenarioBtn').addEventListener('click', () => {
        const scenarios = getScenarioStore();
        const nameInput = document.getElementById('scenarioName');
        const scenarioName = nameInput.value.trim() || `Scenario ${new Date().toLocaleDateString()}`;

        scenarios.push({
            id: Date.now(),
            name: scenarioName,
            state: collectInputState()
        });
        setScenarioStore(scenarios.slice(-12)); // keep last 12 scenarios
        renderScenarioList();
        nameInput.value = '';
        document.getElementById('feedback').insertAdjacentHTML('afterbegin', `<p class="feedback normal">Scenario ‚Äú${scenarioName}‚Äù saved.</p>`);
    });

    document.getElementById('clearScenariosBtn').addEventListener('click', () => {
        if (confirm('Clear all saved scenarios?')) {
            setScenarioStore([]);
            renderScenarioList();
        }
    });

    scenarioListEl.addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (!button) return;
        const { action, id } = button.dataset;
        const scenarios = getScenarioStore();
        const scenario = scenarios.find(item => item.id.toString() === id);
        if (!scenario) return;

        if (action === 'delete') {
            setScenarioStore(scenarios.filter(item => item.id.toString() !== id));
            renderScenarioList();
            return;
        }

        applyInputState(scenario.state);

        if (action === 'run') {
            runCalculation(true);
        }
    });

    renderScenarioList();

    document.getElementById('exportPdf').addEventListener('click', async function () {
        const loadingIndicator = document.getElementById("pdfLoadingIndicator");
        loadingIndicator.style.display = "block";

        try {
            if (typeof window.jspdf === 'undefined') {
                throw new Error('PDF library not loaded. Please refresh and try again.');
            }
            if (!lastComputedSnapshot) {
                throw new Error('Run the calculator first to generate a strategy.');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const snapshot = lastComputedSnapshot;
            const { inputs, parsed, bestStrategy, minimumStrategy, extraStrategy, velocityStrategy, metrics } = snapshot;

            const userName = (inputs.userName || 'User').trim() || 'User';

            doc.setFontSize(20);
            doc.text("Velocity Banking Strategy Report", 14, 15);
            doc.setFontSize(12);
            doc.text(`Prepared for: ${userName}`, 14, 25);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 34);

            doc.setFontSize(14);
            doc.text("Input Summary", 14, 48);
            doc.autoTable({
                startY: 52,
                head: [["Field", "Value"]],
                body: [
                    ["Monthly Income", formatCurrency(parsed.income)],
                    ["Yearly Extra Income", formatCurrency(parsed.extraIncome)],
                    ["Monthly Expenses", formatCurrency(parsed.expenses)],
                    ["Total Debt Balance", formatCurrency(parsed.debtBalance)],
                    ["Interest Rate", `${parsed.interestRate}%`],
                    ["Minimum Payment", formatCurrency(parsed.minimumPayment)],
                    ["Extra Payment", formatCurrency(parsed.extraPayment)],
                    ["Line of Credit Type", parsed.lineOfCredit],
                    ["Line of Credit Limit", parsed.lineOfCreditLimit ? formatCurrency(parsed.lineOfCreditLimit) : "Not provided"],
                    ["Draw Fee (%)", `${parsed.locDrawFee || 0}%`],
                    ["Annual LOC Fee", formatCurrency(parsed.locAnnualFee)],
                    ["Teaser Rate / Months", parsed.teaserRate ? `${parsed.teaserRate}% for ${parsed.teaserMonths} month(s)` : "None"],
                    ["Emergency Fund", formatCurrency(parsed.emergencyFund)],
                    ["Chunk Payment", formatCurrency(parsed.chunkPayment)],
                    ["Chunk Months", parsed.chunkMonths.join(', ') || "‚Äî"]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [0, 123, 255] }
            });

            doc.setFontSize(14);
            doc.text("Strategy Comparison", 14, doc.lastAutoTable.finalY + 10);
            const comparisonRows = [
                ["Minimum Payments", formatCurrency(minimumStrategy.totalInterest), formatCurrency(minimumStrategy.totalFees || 0), minimumStrategy.months, formatCurrency(totalInterestCost(minimumStrategy))],
                ["Extra Payments", formatCurrency(extraStrategy.totalInterest), formatCurrency(extraStrategy.totalFees || 0), extraStrategy.months, formatCurrency(totalInterestCost(extraStrategy))]
            ];
            if (velocityStrategy) {
                comparisonRows.push(["Velocity Banking", formatCurrency(velocityStrategy.totalInterest), formatCurrency(velocityStrategy.totalFees || 0), velocityStrategy.months, formatCurrency(totalInterestCost(velocityStrategy))]);
            }
            comparisonRows.push(["Recommended", formatCurrency(bestStrategy.totalInterest), formatCurrency(bestStrategy.totalFees || 0), bestStrategy.months, formatCurrency(totalInterestCost(bestStrategy))]);

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 14,
                head: [["Strategy", "Interest", "Fees", "Months", "Total Interest + Fees"]],
                body: comparisonRows,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [34, 197, 94] }
            });

            doc.setFontSize(14);
            doc.text("Executive Summary", 14, doc.lastAutoTable.finalY + 14);
            const summaryLines = [
                `‚Ä¢ Recommended Strategy: ${bestStrategy.strategyName}`,
                `‚Ä¢ Debt-free date: ${bestStrategy.debtFreeDate.toLocaleDateString()} (${bestStrategy.months} months)`,
                `‚Ä¢ Interest & fees saved vs minimum payments: ${formatCurrency(metrics.interestSaved)}`,
                `‚Ä¢ Average monthly savings vs minimum payments: ${formatCurrency(metrics.avgMonthlySavings)}`,
                `‚Ä¢ Months saved vs minimum payments: ${metrics.monthsSaved > 0 ? metrics.monthsSaved : 0}`,
                `‚Ä¢ Estimated payoff confidence: ${metrics.interestSaved > 0 ? 'Moderate to High' : 'Baseline'}`,
                metrics.interestSavedByVelocity ? `‚Ä¢ Velocity banking adds ${formatCurrency(metrics.interestSavedByVelocity)} in savings.` : '‚Ä¢ Velocity banking not enabled (no chunk schedule).'
            ];
            doc.setFontSize(11);
            doc.text(summaryLines, 18, doc.lastAutoTable.finalY + 22, { maxWidth: 175, lineHeightFactor: 1.4 });

            doc.setFontSize(8);
            doc.text("Generated by Bradley's Financial Tools - Bradley Virtual Solutions, LLC", 14, 285);

            const fileName = `velocity-banking-${userName.replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(fileName);

        } catch (error) {
            console.error('PDF Export Error:', error);
            alert("Error generating PDF: " + error.message);
        } finally {
            loadingIndicator.style.display = "none";
        }
    });

    function exportStrategyToCSV() {
        if (!lastComputedSnapshot) {
            alert('Run the calculator first to export your data.');
            return;
        }

        const { inputs, parsed, bestStrategy, minimumStrategy, extraStrategy, velocityStrategy, metrics } = lastComputedSnapshot;
        const rows = [
            ["Field", "Value"],
            ["User Name", inputs.userName || ""],
            ["Monthly Income", parsed.income],
            ["Yearly Extra Income", parsed.extraIncome],
            ["Monthly Expenses", parsed.expenses],
            ["Debt Balance", parsed.debtBalance],
            ["Interest Rate (%)", parsed.interestRate],
            ["Minimum Payment", parsed.minimumPayment],
            ["Extra Payment", parsed.extraPayment],
            ["Line of Credit", parsed.lineOfCredit],
            ["LOC Limit", parsed.lineOfCreditLimit],
            ["Draw Fee (%)", parsed.locDrawFee],
            ["Annual LOC Fee", parsed.locAnnualFee],
            ["Teaser Rate (%)", parsed.teaserRate],
            ["Teaser Months", parsed.teaserMonths],
            ["Emergency Fund", parsed.emergencyFund],
            ["Chunk Payment", parsed.chunkPayment],
            ["Chunk Months", parsed.chunkMonths.join('|')],
            ["Recommended Strategy", bestStrategy.strategyName],
            ["Recommended Total Interest", bestStrategy.totalInterest.toFixed(2)],
            ["Recommended Total Fees", (bestStrategy.totalFees || 0).toFixed(2)],
            ["Recommended Months", bestStrategy.months],
            ["Interest Saved vs Minimum", metrics.interestSaved.toFixed(2)],
            ["Months Saved vs Minimum", metrics.monthsSaved],
            ["Avg Monthly Savings vs Minimum", metrics.avgMonthlySavings.toFixed(2)],
            ["Velocity Interest Saved", metrics.interestSavedByVelocity.toFixed(2)],
            ["Extra Payment Interest Saved", metrics.interestSavedByExtra.toFixed(2)],
            ["Minimum Strategy Total Interest", minimumStrategy.totalInterest.toFixed(2)],
            ["Extra Strategy Total Interest", extraStrategy.totalInterest.toFixed(2)],
            ["Velocity Strategy Total Interest", velocityStrategy ? velocityStrategy.totalInterest.toFixed(2) : 'N/A']
        ];

        const csvContent = rows.map(row => row.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "velocity-banking-summary.csv";
        link.click();
    }

    // Input validation for numeric inputs
    function validateInput(input) {
        const value = parseFloat(input.value);
        if (isNaN(value) || value < 0) {
            input.value = 0;
            alert("Please enter a valid positive number.");
        }
    }

    document.querySelectorAll("input[type='number']").forEach(input => {
        input.addEventListener("blur", () => validateInput(input));
    });

    if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
    }
};
</script></body>
</html>
