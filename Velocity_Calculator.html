<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Debt Crusher ‚Äì Velocity Banking Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            text-align: center;
        }
        form {
            margin-bottom: 20px;
        }
        input, button, select {
            width: calc(100% - 22px);
            margin: 10px 0;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007BFF;
            color: #fff;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .feedback {
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .high {
            background-color: #ffcccc;
            color: #cc0000;
        }
        .normal {
            background-color: #ccffcc;
            color: #006600;
        }
        .strategy {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
    
@media print {
  #user-name-display {
    display: block !important;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #000;
  }
}
</style>
<style media="print">
form, button { display: none !important; }
.strategy { page-break-after: always; }
table { page-break-inside: avoid; }
body { color-adjust: exact !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
</style><style>
#recommended-strategy {
  background: #e8f5e9;
  border: 2px solid #4caf50;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 0 10px rgba(76, 175, 80, 0.2);
}
#recommended-strategy h2 {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.recommendation-badge {
  background: #4CAF50;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-weight: bold;
  font-size: 14px;
}

/* Header and Navigation Styles */
.header {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  text-align: center;
  position: relative;
}

.back-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  color: #007bff;
  text-decoration: none;
  font-weight: 600;
  padding: 10px 16px;
  border-radius: 8px;
  background: rgba(0, 123, 255, 0.1);
  transition: all 0.3s ease;
  margin-bottom: 15px;
}

.back-link:hover {
  background: rgba(0, 123, 255, 0.2);
  transform: translateX(-5px);
}

.header h1 {
  color: #007bff;
  font-size: 2.2rem;
  margin: 10px 0;
  font-weight: 700;
}

/* Dark Mode Support */
body.dark-mode {
  background-color: #1a1a1a;
  color: #e0e0e0;
}

body.dark-mode .container {
  background: #2d2d2d;
  color: #e0e0e0;
}

body.dark-mode .header {
  background: #2d2d2d;
  color: #e0e0e0;
}

body.dark-mode .header h1 {
  color: #4a9eff;
}

body.dark-mode .back-link {
  color: #4a9eff;
  background: rgba(74, 158, 255, 0.1);
}

body.dark-mode .back-link:hover {
  background: rgba(74, 158, 255, 0.2);
}

body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
  background-color: #3d3d3d;
  color: #e0e0e0;
  border-color: #555;
}

body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus {
  border-color: #4a9eff;
  box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

body.dark-mode button {
  background-color: #4a9eff;
  color: white;
}

body.dark-mode button:hover {
  background-color: #357abd;
}

body.dark-mode table {
  background-color: #2d2d2d;
  color: #e0e0e0;
}

body.dark-mode th {
  background-color: #3d3d3d;
  color: #e0e0e0;
}

body.dark-mode tr:hover {
  background-color: #3d3d3d;
}

body.dark-mode .feedback.high {
  background-color: #4a1a1a;
  color: #ff6b6b;
}

body.dark-mode .feedback.normal {
  background-color: #1a4a1a;
  color: #6bff6b;
}

body.dark-mode #recommended-strategy {
  background: #1a2d1a;
  border-color: #4CAF50;
}

body.dark-mode .recommendation-badge {
  background: #4CAF50;
  color: white;
}

</style></head>
<body>
<div class="container">
    <div class="header">
        <a href="index.html" class="back-link">
            ‚Üê Back to Dashboard
        </a>
        <h1>Debt Crusher ‚Äì Velocity Banking Tool</h1>
    </div>
<form id="calculator-form">
<label for="userName">Your Name (optional):</label>
<input id="userName" name="userName" placeholder="Enter your name" type="text"/>
<label for="income">Monthly Income ($)</label>
<input id="income" required="" step="0.01" type="number" title="Enter your monthly income"/>
<label for="extraIncome">Yearly Extra Income ($)</label>
<input id="extraIncome" required="" step="0.01" type="number" title="Enter any additional yearly income"/>
<label for="expenses">Monthly Expenses ($)</label>
<input id="expenses" required="" step="0.01" type="number" title="Enter your monthly expenses"/>
<label for="debtBalance">Total Debt Balance ($)</label>
<input id="debtBalance" required="" step="0.01" type="number" title="Enter your total debt balance"/>
<label for="interestRate">Average Interest Rate (%)</label>
<input id="interestRate" required="" step="0.01" type="number" title="Enter the average interest rate on your debts"/>
<label for="minimumPayment">Minimum Monthly Payment ($)</label>
<input id="minimumPayment" required="" step="0.01" type="number" title="Enter your minimum monthly payment"/>
<label for="extraPayment">Extra Payment ($)</label>
<input id="extraPayment" step="0.01" type="number" title="Enter any extra payment you can make monthly"/>
<label for="lineOfCredit">Select Velocity Banking Line of Credit:</label>
<select id="lineOfCredit" required="" title="Select the type of line of credit you are using">
<option value="creditCard">Credit Card</option>
<option value="HELOC">HELOC</option>
<option value="personalLoan">Personal Loan</option>
<option value="businessLoan">Business Loan</option>
<option value="ploc">PLOC (e.g., NetCredit)</option>
</select>
<label for="chunkPayment">Velocity Banking Chunk Payment ($)</label>
<input id="chunkPayment" required="" step="0.01" type="number" title="Enter the chunk payment amount for velocity banking"/>
<label for="chunkMonths">Months for Chunk Payments (comma-separated, e.g., 3,6,12)</label>
<input id="chunkMonths" placeholder="e.g., 3,6,12" type="text" title="Enter the months for chunk payments, separated by commas"/>
<button type="submit">Calculate</button>
<button id="saveInputs" type="button">Save Inputs</button>
<button id="loadInputs" type="button">Load Inputs</button>
<button id="exportPdf" type="button">Export Strategy as PDF</button>
<button id="exportCsv" type="button">üìä Export to CSV</button>
<label><input id="limitMonthsToggle" style="width:auto; margin-right:10px;" type="checkbox"/> Limit table to first 60 months</label>
</form>
<div id="feedback"></div>
<div id="user-name-display" style="font-size: 18px; font-weight: bold; margin-top: 20px;"></div><div id="results"></div>
<div id="recommended-strategy" style="margin-top: 30px;">
<h2>Recommended Strategy<span class="recommendation-badge">RECOMMENDED</span></h2>
<div id="recommended-strategy-details"></div>
</div>
<div id="loadingIndicator" style="display: none; text-align: center; margin: 20px 0;">
  <p>Loading...</p>
</div>
<div id="pdfLoadingIndicator" style="display: none; text-align: center; margin: 20px 0;">
  <p>Generating PDF...</p>
</div>
<footer style="text-align: center; margin-top: 40px; font-weight: bold; font-size: 14px; color: #555;">Created by Ronell Bradley</footer></div>
<script>
// Check for global dark mode setting and apply it
function applyDarkMode() {
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
}

// Apply dark mode on page load
document.addEventListener('DOMContentLoaded', applyDarkMode);

// Listen for dark mode changes from other pages
window.addEventListener('storage', function(e) {
    if (e.key === 'darkMode') {
        applyDarkMode();
    }
});

window.onload = function () {
    function getLineOfCreditBehavior(type) {
        switch(type) {
            case 'creditCard':
                return { rateMultiplier: 1.05, description: 'Credit Card (daily compound)', fee: 0 };
            case 'HELOC':
                return { rateMultiplier: 1.0, description: 'HELOC (simple interest)', fee: 0 };
            case 'personalLoan':
                return { rateMultiplier: 0.95, description: 'Personal Loan (amortized)', fee: 0 };
            case 'businessLoan':
                return { rateMultiplier: 1.1, description: 'Business Loan (interest-only 3 months)', fee: 0 };
            case 'ploc':
                return { rateMultiplier: 1.0, description: 'PLOC (simple interest, fee included)', fee: 0 };
            default:
                return { rateMultiplier: 1.0, description: 'Standard', fee: 0 };
        }
    }

    document.getElementById('saveInputs').addEventListener('click', function () {
        const loadingIndicator = document.getElementById("loadingIndicator");
        loadingIndicator.style.display = "block";
        try {
            const inputs = {
                income: document.getElementById('income').value,
                extraIncome: document.getElementById('extraIncome').value,
                expenses: document.getElementById('expenses').value,
                debtBalance: document.getElementById('debtBalance').value,
                interestRate: document.getElementById('interestRate').value,
                minimumPayment: document.getElementById('minimumPayment').value,
                extraPayment: document.getElementById('extraPayment').value,
                lineOfCredit: document.getElementById('lineOfCredit').value,
                chunkPayment: document.getElementById('chunkPayment').value,
                chunkMonths: document.getElementById('chunkMonths').value
            };
            localStorage.setItem('debtStrategyInputs', JSON.stringify(inputs));
            alert('Inputs saved successfully!');
        } catch (error) {
            alert("Error saving inputs: " + error.message);
        } finally {
            loadingIndicator.style.display = "none";
        }
    });

    document.getElementById('loadInputs').addEventListener('click', function () {
        const loadingIndicator = document.getElementById("loadingIndicator");
        loadingIndicator.style.display = "block";
        try {
            const savedInputs = localStorage.getItem('debtStrategyInputs');
            if (savedInputs) {
                const inputs = JSON.parse(savedInputs);
                document.getElementById('income').value = inputs.income;
                document.getElementById('extraIncome').value = inputs.extraIncome;
                document.getElementById('expenses').value = inputs.expenses;
                document.getElementById('debtBalance').value = inputs.debtBalance;
                document.getElementById('interestRate').value = inputs.interestRate;
                document.getElementById('minimumPayment').value = inputs.minimumPayment;
                document.getElementById('extraPayment').value = inputs.extraPayment;
                document.getElementById('lineOfCredit').value = inputs.lineOfCredit;
                document.getElementById('chunkPayment').value = inputs.chunkPayment;
                document.getElementById('chunkMonths').value = inputs.chunkMonths;
                alert('Inputs loaded successfully!');
            } else {
                alert('No saved inputs found.');
            }
        } catch (error) {
            alert("Error loading inputs: " + error.message);
        } finally {
            loadingIndicator.style.display = "none";
        }
    });

    document.getElementById('exportCsv').addEventListener('click', function () {
        exportStrategyToCSV();
    });

    document.getElementById('exportPdf').addEventListener('click', async function () {
        const loadingIndicator = document.getElementById("pdfLoadingIndicator");
        loadingIndicator.style.display = "block";
        
        try {
            // Check if jsPDF is loaded
            if (typeof window.jspdf === 'undefined') {
                throw new Error('PDF library not loaded. Please refresh the page and try again.');
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get form data
            const userName = document.getElementById('userName').value || 'User';
            const income = document.getElementById('income').value;
            const extraIncome = document.getElementById('extraIncome').value;
            const expenses = document.getElementById('expenses').value;
            const debtBalance = document.getElementById('debtBalance').value;
            const interestRate = document.getElementById('interestRate').value;
            const minimumPayment = document.getElementById('minimumPayment').value;
            const extraPayment = document.getElementById('extraPayment').value;
            const lineOfCredit = document.getElementById('lineOfCredit').value;
            const chunkPayment = document.getElementById('chunkPayment').value;
            const chunkMonths = document.getElementById('chunkMonths').value;
            
            // Header
            doc.setFontSize(20);
            doc.text("Velocity Banking Strategy Report", 14, 15);
            doc.setFontSize(12);
            doc.text(`Prepared for: ${userName}`, 14, 25);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 35);
            
            // Input Summary Table
            doc.setFontSize(14);
            doc.text("Input Summary", 14, 50);
            
            doc.autoTable({
                startY: 55,
                head: [["Field", "Value"]],
                body: [
                    ["Monthly Income", `$${parseFloat(income || 0).toLocaleString()}`],
                    ["Yearly Extra Income", `$${parseFloat(extraIncome || 0).toLocaleString()}`],
                    ["Monthly Expenses", `$${parseFloat(expenses || 0).toLocaleString()}`],
                    ["Total Debt Balance", `$${parseFloat(debtBalance || 0).toLocaleString()}`],
                    ["Interest Rate", `${interestRate}%`],
                    ["Minimum Payment", `$${parseFloat(minimumPayment || 0).toLocaleString()}`],
                    ["Extra Payment", `$${parseFloat(extraPayment || 0).toLocaleString()}`],
                    ["Line of Credit", lineOfCredit],
                    ["Chunk Payment", `$${parseFloat(chunkPayment || 0).toLocaleString()}`],
                    ["Chunk Months", chunkMonths]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [0, 123, 255] }
            });
            
            // Results Summary (if available)
            const resultsDiv = document.getElementById('results');
            if (resultsDiv && resultsDiv.innerHTML.trim() !== '') {
                doc.setFontSize(14);
                doc.text("Strategy Results", 14, doc.lastAutoTable.finalY + 20);
                
                // Extract key results
                const resultsText = resultsDiv.innerText;
                const lines = resultsText.split('\n').filter(line => line.trim() !== '');
                
                let yPosition = doc.lastAutoTable.finalY + 35;
                lines.forEach(line => {
                    if (yPosition > 280) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.setFontSize(10);
                    doc.text(line.substring(0, 80), 14, yPosition);
                    yPosition += 10;
                });
            } else {
                doc.setFontSize(12);
                doc.text("Please run the calculation first to see detailed results.", 14, doc.lastAutoTable.finalY + 20);
            }
            
            // Footer
            doc.setFontSize(8);
            doc.text("Generated by Bradley's Financial Tools - Velocity Banking Calculator", 14, 285);
            
            // Save the PDF
            const fileName = `velocity-banking-strategy-${userName.replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(fileName);
            
        } catch (error) {
            console.error('PDF Export Error:', error);
            alert("Error generating PDF: " + error.message + "\n\nPlease make sure to run the calculation first, then try exporting again.");
        } finally {
            loadingIndicator.style.display = "none";
        }
    });

    document.getElementById('calculator-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const income = parseFloat(document.getElementById('income').value);
        const expenses = parseFloat(document.getElementById('expenses').value);
        const debtBalance = parseFloat(document.getElementById('debtBalance').value);
        const baseInterestRate = parseFloat(document.getElementById('interestRate').value) / 100 / 12;
        const minimumPayment = parseFloat(document.getElementById('minimumPayment').value);
        const extraPayment = parseFloat(document.getElementById('extraPayment').value) || 0;
        const chunkPayment = parseFloat(document.getElementById('chunkPayment').value) || 0;
        const chunkMonths = document.getElementById('chunkMonths').value.split(',').map(Number).filter(n => !isNaN(n) && n > 0);
        const lineOfCredit = document.getElementById('lineOfCredit').value;
        const locBehavior = getLineOfCreditBehavior(lineOfCredit);
        const interestRate = baseInterestRate * locBehavior.rateMultiplier;
        const extraIncome = parseFloat(document.getElementById('extraIncome').value) || 0;
        
        // Get feedback element first
        const feedback = document.getElementById('feedback');
        
        // Input validation
        if (minimumPayment <= 0) {
            feedback.innerHTML = `<p class="feedback high">Error: Minimum monthly payment must be greater than $0. Please enter a valid minimum payment amount.</p>`;
            return;
        }
        
        // Only validate chunk payment and months if user wants to use velocity banking
        if (chunkPayment > 0 && chunkMonths.length === 0) {
            feedback.innerHTML = `<p class="feedback high">Warning: You entered a chunk payment but no months. Please enter valid months for chunk payments (e.g., 3,6,12) or set chunk payment to $0.</p>`;
            return;
        }
        
        if (chunkPayment <= 0 && chunkMonths.length > 0) {
            feedback.innerHTML = `<p class="feedback high">Warning: You entered chunk months but no chunk payment. Please enter a chunk payment amount or clear the months field.</p>`;
            return;
        }
        
        // Calculate suggested minimum payment if not provided
        if (minimumPayment < debtBalance * 0.01) {
            const suggestedMinPayment = Math.max(debtBalance * 0.02, 100);
            feedback.innerHTML = `<p class="feedback high">Warning: Your minimum payment seems low. For a $${debtBalance.toLocaleString()} debt at ${(baseInterestRate * 12 * 100).toFixed(1)}% interest, consider a minimum payment of at least $${suggestedMinPayment.toFixed(0)} to make meaningful progress.</p>`;
        }

        const yearlyIncome = income * 12;
        const totalYearlyIncome = yearlyIncome + extraIncome;
        const dtiRatio = (debtBalance / totalYearlyIncome) * 100;
        const cashFlow = income - expenses;
        feedback.innerHTML = `
            <p>Yearly Income (with Extra): $${totalYearlyIncome.toFixed(2)}</p>
            <p>Available Cash Flow: $${cashFlow.toFixed(2)}</p>
            <p>Selected Line of Credit: ${locBehavior.description}</p>
        `;

        if (lineOfCredit === 'ploc') {
            feedback.innerHTML += `<p><em>Note: PLOC selected ‚Äî make sure any one-time fees (e.g., NetCredit's 10%) are already included in your total debt balance or chunk payments.</em></p>`;
        }

        if (dtiRatio > 43) {
            feedback.innerHTML += `<p class="feedback high">‚ö†Ô∏è Debt-to-Income Ratio: ${dtiRatio.toFixed(2)}% (Too High)</p>`;
        } else {
            feedback.innerHTML += `<p class="feedback normal">‚úÖ Debt-to-Income Ratio: ${dtiRatio.toFixed(2)}% (Within Normal Limits)</p>`;
        }

        if (cashFlow <= 0) {
            feedback.innerHTML += `<p class="feedback high">Insufficient cash flow. Adjust your income or expenses.</p>`;
            return;
        }

        function calculateStrategy(debtBalance, interestRate, payment, strategyName, chunkMonths) {
            let balance = debtBalance, months = 0, totalInterest = 0, payments = [], totalPrincipalPaid = 0;
            
            console.log(`Debug - ${strategyName}: Starting with balance=${balance}, interestRate=${interestRate}, payment=${payment}`);

            while (balance > 0 && months < 1500) {
                const interest = balance * interestRate;
                totalInterest += interest;
                let actualPayment = payment;

                const chunkPaymentApplied = chunkMonths.includes(months + 1);
                if (chunkPaymentApplied) {
                    actualPayment += chunkPayment;
                }

                actualPayment = Math.min(actualPayment, balance + interest);
                balance = balance + interest - actualPayment;

                const principalPaid = actualPayment - interest;
                totalPrincipalPaid += principalPaid;

                payments.push({
                    payment: actualPayment.toFixed(2),
                    interest: interest.toFixed(2),
                    balance: balance.toFixed(2),
                    principalPaid: principalPaid.toFixed(2)
                });
                
                // Debug first few iterations
                if (months < 3) {
                    console.log(`Debug - ${strategyName} Month ${months + 1}: balance=${balance.toFixed(2)}, interest=${interest.toFixed(2)}, payment=${actualPayment.toFixed(2)}, totalInterest=${totalInterest.toFixed(2)}`);
                }

                months++;
            }

            const debtFreeDate = new Date();
            debtFreeDate.setMonth(debtFreeDate.getMonth() + months);
            const yearsToPayoff = (months / 12).toFixed(2);

            return { strategyName, totalInterest, months, debtFreeDate, yearsToPayoff, totalPrincipalPaid, payments };
        }

        const minimumStrategy = calculateStrategy(debtBalance, baseInterestRate, minimumPayment, "Minimum Payment", []);
        
        // Only calculate velocity strategy if chunk payment is provided
        let velocityStrategy = null;
        if (chunkPayment > 0 && chunkMonths.length > 0) {
            velocityStrategy = calculateStrategy(debtBalance, interestRate, cashFlow, "Velocity Banking", chunkMonths);
        }
        
        const extraStrategy = calculateStrategy(debtBalance, baseInterestRate, minimumPayment + extraPayment, "Minimum Payments with Extra Payment", []);

        function calculateSavings(baseStrategy, otherStrategy) {
            return baseStrategy.totalInterest - otherStrategy.totalInterest;
        }

        // Calculate savings only for strategies that exist
        let velocitySavings = 0;
        if (velocityStrategy) {
            velocitySavings = calculateSavings(minimumStrategy, velocityStrategy);
        }
        
        const extraSavings = calculateSavings(minimumStrategy, extraStrategy);
        
        // Debug logging
        console.log('Debug - Interest Calculations:');
        console.log('Minimum Strategy Total Interest:', minimumStrategy.totalInterest);
        if (velocityStrategy) {
            console.log('Velocity Strategy Total Interest:', velocityStrategy.totalInterest);
            console.log('Velocity Savings:', velocitySavings);
        } else {
            console.log('Velocity Strategy: Not calculated (no chunk payment)');
        }
        console.log('Extra Strategy Total Interest:', extraStrategy.totalInterest);
        console.log('Extra Savings:', extraSavings);

        // Build strategies array, excluding null velocity strategy
        const strategies = [extraStrategy];
        if (velocityStrategy) {
            strategies.unshift(velocityStrategy); // Add velocity strategy first if it exists
        }
        const bestStrategy = strategies.reduce((best, current) => current.totalInterest < best.totalInterest ? current : best, minimumStrategy);

        const avgMonthlySavings = (minimumStrategy.totalInterest - bestStrategy.totalInterest) / bestStrategy.months;
        let confidenceLevel = '';
        if (cashFlow >= chunkPayment * 1.5) {
            confidenceLevel = 'üöÄ High Confidence ‚Äì Strong Cash Flow';
        } else if (cashFlow >= chunkPayment) {
            confidenceLevel = '‚úÖ Moderate Confidence ‚Äì Cash Flow Sufficient';
        } else {
            confidenceLevel = '‚ö†Ô∏è Low Confidence ‚Äì Tight Cash Flow';
        }

        function renderStrategy(strategy, savings) {
            const limited = strategy.months > 120;
            const limitRows = limited || document.getElementById('limitMonthsToggle').checked;
            const maxRows = limitRows ? 60 : strategy.payments.length;
            const notice = limited ? '<p><em>Only first 60 months shown. Full data is included in totals.</em></p>' : '';

            return `
                <div class="strategy" style="border-top: 4px solid #4CAF50;">
                    <h2>${strategy.strategyName.replace('Minimum Payments with Extra Payment', 'üßÆ Minimum Payments with Extra Payment')}</h2>
                    ${notice}
                    <p>Total Interest Paid: $${strategy.totalInterest.toFixed(2)}</p>
                    <p>Months to Payoff: ${strategy.months} (${strategy.yearsToPayoff} years)</p>
                    <p>Debt-Free Date: ${strategy.debtFreeDate.toLocaleDateString()}</p>
                    <p>Interest Saved Compared to Minimum Payments: $${savings.toFixed(2)}</p>
                    <p>Total Principal Paid: $${strategy.totalPrincipalPaid.toFixed(2)}</p>
                    <p>Total Amount Paid: $${(strategy.totalPrincipalPaid + strategy.totalInterest).toFixed(2)}</p>
                    <table>
                        <tr>
                            <th>Month</th>
                            <th>Payment ($)</th>
                            <th>Principal Paid ($)</th>
                            <th>Interest ($)</th>
                            <th>Balance ($)</th>
                        </tr>
                        ${strategy.payments.slice(0, maxRows).map((p, i) => {
                            return `<tr>
                                <td>${i + 1}</td>
                                <td>${p.payment}</td>
                                <td>${p.principalPaid}</td>
                                <td>${p.interest}</td>
                                <td>${p.balance}</td>
                            </tr>`;
                        }).join('')}
                    </table>
                </div>
            `;
        }

        // Render strategies
        let resultsHTML = renderStrategy(minimumStrategy, 0);
        
        if (velocityStrategy) {
            resultsHTML += renderStrategy(velocityStrategy, velocitySavings);
        } else {
            resultsHTML += `
                <div class="strategy" style="border-top: 4px solid #6c757d;">
                    <h3>Velocity Banking Strategy</h3>
                    <p><em>Not calculated - No chunk payment provided. Enter a chunk payment amount and months to see velocity banking results.</em></p>
                </div>
            `;
        }
        
        resultsHTML += renderStrategy(extraStrategy, extraSavings);
        
        document.getElementById('results').innerHTML = resultsHTML;

        const recommendedHtml = `
            <p><em>‚úÖ Recommended because it saves the most interest while maintaining a fast payoff timeline.</em></p>
            <p><strong>Recommended Strategy:</strong> ${bestStrategy.strategyName}</p>
            <p>Total Interest: $${bestStrategy.totalInterest.toFixed(2)}</p>
            <p>Months to Payoff: ${bestStrategy.months} months (${bestStrategy.yearsToPayoff} years)</p>
            <p>Debt-Free Date: ${bestStrategy.debtFreeDate.toLocaleDateString()}</p>
            <p>üí∞ Est. Avg. Monthly Savings vs. Minimum: $${avgMonthlySavings.toFixed(2)}</p>
            <p>üìä Payoff Confidence: <strong>${confidenceLevel}</strong></p>
        `;
        
        const userName = document.getElementById('userName').value.trim();
        if (userName) {
            document.getElementById('user-name-display').innerHTML = `üìÑ Strategy Report for <strong>${userName}</strong>`;
        } else {
            document.getElementById('user-name-display').innerHTML = '';
        }

        document.getElementById('recommended-strategy-details').innerHTML = recommendedHtml;
    });

    // Input validation for numeric inputs
    function validateInput(input) {
        const value = parseFloat(input.value);
        if (isNaN(value) || value < 0) {
            input.value = 0;
            alert("Please enter a valid positive number.");
        }
    }

    // Add validation to numeric inputs
    document.querySelectorAll("input[type='number']").forEach(input => {
        input.addEventListener("blur", () => validateInput(input));
    });

    function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        const isDarkMode = document.body.classList.contains("dark-mode");
        localStorage.setItem("darkMode", isDarkMode);
    }

    // Load dark mode preference
    if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
    }

    // Export strategy data to CSV
    function exportStrategyToCSV() {
        const inputs = {
            income: document.getElementById('income').value,
            extraIncome: document.getElementById('extraIncome').value,
            expenses: document.getElementById('expenses').value,
            debtBalance: document.getElementById('debtBalance').value,
            interestRate: document.getElementById('interestRate').value,
            minimumPayment: document.getElementById('minimumPayment').value,
            extraPayment: document.getElementById('extraPayment').value,
            lineOfCredit: document.getElementById('lineOfCredit').value,
            chunkPayment: document.getElementById('chunkPayment').value,
            chunkMonths: document.getElementById('chunkMonths').value
        };
        const csvContent = [
            ["Field", "Value"],
            ["Income", inputs.income],
            ["Extra Income", inputs.extraIncome],
            ["Expenses", inputs.expenses],
            ["Debt Balance", inputs.debtBalance],
            ["Interest Rate", inputs.interestRate],
            ["Minimum Payment", inputs.minimumPayment],
            ["Extra Payment", inputs.extraPayment],
            ["Line of Credit", inputs.lineOfCredit],
            ["Chunk Payment", inputs.chunkPayment],
            ["Chunk Months", inputs.chunkMonths]
        ].map(row => row.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "strategy_data.csv";
        link.click();
    }
};
</script></body>
</html>
