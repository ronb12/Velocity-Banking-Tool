<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Velocity Banking Tool</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 50px auto;
      padding: 2rem;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
  </style>
</head>
<body>

  <!-- ✅ Friendly Success Banner -->
  <div id="migrationBanner" style="
    display: none;
    background-color: #d4edda;
    color: #155724;
    padding: 15px 20px;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    margin: 20px auto;
    width: 90%;
    max-width: 600px;
    text-align: center;
    font-size: 16px;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    position: relative;
    opacity: 0;
    transition: opacity 1s ease-in-out;
    z-index: 999;
  ">
    <span style="font-size: 18px; margin-right: 8px;">✅</span>
    Your financial data has been securely updated to work with the newest features.
    <span id="closeBannerBtn" style="
      position: absolute;
      top: 8px;
      right: 12px;
      cursor: pointer;
      font-weight: bold;
      color: #155724;
      font-size: 18px;
    " title="Close">&times;</span>
  </div>

  <div class="container">
    <h1>Welcome to Velocity Banking</h1>
    <!-- Your dashboard content here -->
  </div>

  <!-- ✅ Firebase Config (Your Project) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC--9xnMW4s8UPOJUnQbKjMpXgJvoh6ITw",
      authDomain: "bradley-health.firebaseapp.com",
      projectId: "bradley-health",
      storageBucket: "bradley-health.appspot.com",
      messagingSenderId: "294249919277",
      appId: "1:294249919277:web:exampleappid"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ✅ Secure Migration + Banner Logic -->
  <script>
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) return;

      const uid = user.uid;
      const db = firebase.firestore();
      const userDocRef = db.collection('users').doc(uid);
      const banner = document.getElementById('migrationBanner');
      const closeBtn = document.getElementById('closeBannerBtn');

      try {
        const userDoc = await userDocRef.get();
        const userData = userDoc.data();

        if (userData?.migrated) return;

        async function migrateArrayToSubcollection(array, subcollectionName) {
          if (Array.isArray(array) && array.length > 0) {
            for (const item of array) {
              await userDocRef.collection(subcollectionName).add({
                ...item,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
            console.log(`✅ Migrated ${subcollectionName} for ${uid}`);
          }
        }

        await migrateArrayToSubcollection(userData?.debts, "debts");
        await migrateArrayToSubcollection(userData?.income, "income");
        await migrateArrayToSubcollection(userData?.chunks, "chunks");

        await userDocRef.update({
          debts: firebase.firestore.FieldValue.delete(),
          income: firebase.firestore.FieldValue.delete(),
          chunks: firebase.firestore.FieldValue.delete(),
          migrated: true
        });

        // Show success banner
        if (banner) {
          banner.style.display = "block";
          setTimeout(() => {
            banner.style.opacity = "1";
          }, 100);

          setTimeout(() => {
            banner.style.opacity = "0";
            setTimeout(() => banner.style.display = "none", 1000);
          }, 5000);
        }

        // Manual close option
        if (closeBtn) {
          closeBtn.onclick = () => {
            banner.style.opacity = "0";
            setTimeout(() => banner.style.display = "none", 500);
          };
        }

      } catch (err) {
        console.error("❌ Migration failed:", err.message);
      }
    });
  </script>

</body>
</html>
