<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bradley's Velocity Banking Toolkit</title>
  <link rel="apple-touch-icon" href="icon-192.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; margin: 0; padding: 0; text-align: center; }
    header { background: #007bff; color: white; padding: 1em; position: relative; }
    button.logout, button.profile-btn {
      position: absolute; top: 15px; padding: 8px 12px; border-radius: 4px; border: none; color: white; cursor: pointer;
    }
    .logout { right: 20px; background: #dc3545; }
    .profile-btn { left: 20px; background: #28a745; }
    .tool-link {
      display: block; margin: 10px auto; padding: 12px; background: #007bff;
      color: white; width: 300px; border-radius: 8px; text-decoration: none;
    }
    .dashboard-tile {
      display: inline-block; margin: 10px; padding: 15px; background: white;
      border-left: 5px solid #007bff; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); min-width: 180px; font-weight: bold;
    }
    .alert, #migrationBanner {
      margin: 20px auto; padding: 10px; font-weight: 500;
      max-width: 600px; border-radius: 8px; display: none;
    }
    .alert { background: #ffc107; color: #000; }
    #migrationBanner { background: #d4edda; color: #155724; }
    #profileBox {
      display: none; background: #fff; border: 1px solid #ccc;
      margin: 10px auto; padding: 15px; border-radius: 8px;
      max-width: 400px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<header>
  🚀 Bradley's Dashboard
  <button class="profile-btn" onclick="toggleProfile()">👤 My Profile</button>
  <button class="logout" onclick="logout()">🔒 Logout</button>
</header>

<div id="notification" class="alert"></div>
<div id="migrationBanner">✅ Your financial data has been securely updated to work with the newest features.</div>

<div id="profileBox">
  <h3>👤 Your Profile</h3>
  <p id="profileEmail">Email: ...</p>
  <p id="profileJoinDate">Joined: ...</p>
</div>

<div class="dashboard" id="dashboardTiles">
  <div class="dashboard-tile" id="netWorthTile">🧮 Total Net Worth: $0.00</div>
  <div class="dashboard-tile" id="monthlyBudgetTile">💰 Monthly Budget: $0.00</div>
  <div class="dashboard-tile" id="remainingToBudgetTile">📉 Remaining to Budget: $0.00</div>
  <div class="dashboard-tile" id="topDebtsTile">🔥 Top 3 Debts: Loading...</div>
  <div class="dashboard-tile" id="creditUtilizationTile">💳 Credit Utilization: 0%</div>
</div>

<div class="tools">
  <p>Welcome to your personal finance hub. Choose a tool:</p>
  <a class="tool-link" href="budget.html">💰 Budget Tracker</a>
  <a class="tool-link" href="Velocity_Calculator.html">📊 Velocity Calculator</a>
  <a class="tool-link" href="Debt_Tracker.html">📋 Debt Tracker</a>
  <a class="tool-link" href="1099_calculator.html">🧾 1099 Tax Calculator</a>
  <a class="tool-link" href="net_worth_tracker.html">🧮 Net Worth Tracker</a>
  <a class="tool-link" href="savings_goal_tracker.html">🏦 Savings Goals</a>
  <a class="tool-link" href="challenge_library.html">📚 Challenge Library</a>
  <a class="tool-link" href="activity_feed.html">🧾 Master Activity Feed</a>
  <a class="tool-link" href="notifications.html">📥 Notifications Center</a>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
  authDomain: "mobile-debt-tracker.firebaseapp.com",
  projectId: "mobile-debt-tracker"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function logout() {
  auth.signOut().then(() => window.location.href = "login.html");
}
function toggleProfile() {
  const box = document.getElementById("profileBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
}

// 🔧 Patch missing debt "type" field to ensure credit utilization works
async function patchMissingDebtTypes(uid) {
  const debtRef = db.collection("users").doc(uid).collection("debts");
  const snapshot = await debtRef.get();
  for (const doc of snapshot.docs) {
    const data = doc.data();
    const currentType = data.type;
    if (!currentType) {
      await doc.ref.update({ type: "credit" });
      console.log(`✅ Patched missing type for: ${data.name}`);
    } else if (typeof currentType === "string" && currentType !== currentType.toLowerCase()) {
      await doc.ref.update({ type: currentType.toLowerCase() });
      console.log(`🔡 Normalized type for: ${data.name}`);
    }
  }
}

auth.onAuthStateChanged(async user => {
  if (!user) return window.location.href = "login.html";
  const uid = user.uid;

  await patchMissingDebtTypes(uid); // ✅ Sync before continuing

  const userRef = db.collection("users").doc(uid);
  const userDoc = await userRef.get();
  if (!userDoc.exists) await userRef.set({ email: user.email, joined: new Date().toISOString() });

  const userData = userDoc.data();
  document.getElementById("profileEmail").innerText = `Email: ${userData.email}`;
  document.getElementById("profileJoinDate").innerText = `Joined: ${new Date(userData.joined).toLocaleDateString()}`;
  document.getElementById("notification").innerText = `🔔 Welcome back, ${userData.email}`;
  document.getElementById("notification").style.display = "block";

  if (!userData?.migrated && Array.isArray(userData?.debts)) {
    for (const debt of userData.debts) await userRef.collection("debts").add(debt);
    await userRef.update({ debts: firebase.firestore.FieldValue.delete(), migrated: true });
    document.getElementById("migrationBanner").style.display = "block";
    setTimeout(() => document.getElementById("migrationBanner").style.display = "none", 5000);
  }

  const netWorthDoc = await db.collection("networth").doc(uid).get();
  if (netWorthDoc.exists) {
    const { assets = [], liabilities = [] } = netWorthDoc.data();
    const netWorth = assets.reduce((sum, a) => sum + a.value, 0) - liabilities.reduce((sum, l) => sum + l.value, 0);
    document.getElementById("netWorthTile").innerText = `🧮 Total Net Worth: $${netWorth.toFixed(2)}`;
  }

  const monthId = new Date().toISOString().slice(0, 7);
  const budgetDoc = await db.collection("budgets").doc(uid + "_" + monthId).get();
  if (budgetDoc.exists) {
    const { incomes = [], expenses = [] } = budgetDoc.data();
    const totalIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
    const totalExpenses = expenses.reduce((sum, e) => sum + e.budgeted, 0);
    document.getElementById("monthlyBudgetTile").innerText = `💰 Monthly Budget: $${totalIncome.toFixed(2)}`;
    document.getElementById("remainingToBudgetTile").innerText = `📉 Remaining to Budget: $${(totalIncome - totalExpenses).toFixed(2)}`;
  }

  const debtSnap = await userRef.collection("debts").get();
  const allDebts = debtSnap.docs.map(doc => doc.data());
  const topDebts = allDebts
    .sort((a, b) => (b.interest || 0) - (a.interest || 0))
    .slice(0, 3)
    .map(d => d.name).join(", ");
  document.getElementById("topDebtsTile").innerText = `🔥 Top 3 Debts: ${topDebts || "N/A"}`;

  const creditDebts = allDebts.filter(d => (d.type || '').toLowerCase() === 'credit');
  const totalUsed = creditDebts.reduce((sum, d) => sum + parseFloat(d.balance || 0), 0);
  const totalLimit = creditDebts.reduce((sum, d) => sum + parseFloat(d.limit || 0), 0);
  const utilization = totalLimit > 0 ? ((totalUsed / totalLimit) * 100).toFixed(2) : "0.00";

  const utilTile = document.getElementById("creditUtilizationTile");
  let badge = "", color = "#007bff";
  if (utilization < 30) { color = "#28a745"; badge = "(Good ✅)"; }
  else if (utilization < 50) { color = "#ffc107"; badge = "(Warning ⚠️)"; }
  else { color = "#dc3545"; badge = "(Danger ❌)"; }
  utilTile.style.borderLeft = `5px solid ${color}`;
  utilTile.innerText = `💳 Credit Utilization: ${utilization}% ${badge}`;
});
</script>
</body>
</html>
