<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bradley's Velocity Banking Toolkit</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; margin: 0; padding: 0; text-align: center; }
    header { background: #007bff; color: white; padding: 1em; position: relative; }
    .logout, .profile-btn {
      position: absolute; top: 15px; padding: 8px 12px; border-radius: 4px; border: none; color: white; cursor: pointer;
    }
    .logout { right: 20px; background: #dc3545; }
    .profile-btn { left: 20px; background: #28a745; }
    .tool-link {
      display: block; margin: 10px auto; padding: 12px;
      background: #007bff; color: white; width: 300px;
      border-radius: 8px; text-decoration: none;
    }
    .dashboard-tile {
      display: inline-block; margin: 10px; padding: 15px; background: white;
      border-left: 5px solid #007bff; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); min-width: 180px; font-weight: bold;
    }
    .alert, #migrationBanner {
      margin: 20px auto; padding: 10px; font-weight: 500;
      max-width: 600px; border-radius: 8px; display: none;
    }
    .alert { background: #ffc107; color: #000; }
    #migrationBanner { background: #d4edda; color: #155724; }
    #profileBox {
      display: none; background: #fff; border: 1px solid #ccc;
      margin: 10px auto; padding: 15px; border-radius: 8px;
      max-width: 400px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<header>
  ğŸš€ Bradley's Dashboard
  <button class="profile-btn" onclick="toggleProfile()">ğŸ‘¤ My Profile</button>
  <button class="logout" onclick="logout()">ğŸ” Logout</button>
</header>

<div id="notification" class="alert"></div>
<div id="migrationBanner">âœ… Your financial data has been securely updated to work with the newest features.</div>

<div id="profileBox">
  <h3>ğŸ‘¤ Your Profile</h3>
  <p id="profileEmail">Email: ...</p>
  <p id="profileJoinDate">Joined: ...</p>
</div>

<div class="dashboard" id="dashboardTiles">
  <div class="dashboard-tile" id="netWorthTile">ğŸ§° Total Net Worth: Loading...</div>
  <div class="dashboard-tile" id="monthlyBudgetTile">ğŸ’° Monthly Budget: Loading...</div>
  <div class="dashboard-tile" id="remainingToBudgetTile">ğŸ“‰ Remaining to Budget: Loading...</div>
  <div class="dashboard-tile" id="topDebtsTile">ğŸ”¥ Top 3 Debts: Loading...</div>
  <div class="dashboard-tile" id="creditUtilizationTile">ğŸ’³ Credit Utilization: Loading...</div>
</div>

<div class="tools">
  <p>Welcome to your personal finance hub. Choose a tool:</p>
  <a class="tool-link" href="budget.html">ğŸ’° Budget Tracker</a>
  <a class="tool-link" href="Velocity_Calculator.html">ğŸ“Š Velocity Calculator</a>
  <a class="tool-link" href="Debt_Tracker.html">ğŸ“‹ Debt Tracker</a>
  <a class="tool-link" href="1099_calculator.html">ğŸ“Ÿ 1099 Tax Calculator</a>
  <a class="tool-link" href="net_worth_tracker.html">ğŸ§° Net Worth Tracker</a>
  <a class="tool-link" href="savings_goal_tracker.html">ğŸ¦ Savings Goals</a>
  <a class="tool-link" href="challenge_library.html">ğŸ“š Challenge Library</a>
  <a class="tool-link" href="activity_feed.html">ğŸ§¾ Master Activity Feed</a>
  <a class="tool-link" href="notifications.html">ğŸ“¥ Notifications Center</a>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
  authDomain: "mobile-debt-tracker.firebaseapp.com",
  projectId: "mobile-debt-tracker"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// âœ… New cache settings (no deprecation warning)
db.settings({ cache: { cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED } });
db.enablePersistence({ synchronizeTabs: true }).catch(err => {
  console.warn("Offline persistence error:", err.code);
});

function logout() {
  auth.signOut().then(() => window.location.href = "login.html");
}

function toggleProfile() {
  const box = document.getElementById("profileBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
}

// âœ… Load localStorage as fallback
window.addEventListener("DOMContentLoaded", () => {
  const profile = JSON.parse(localStorage.getItem("profile") || "{}");
  if (profile.email) document.getElementById("profileEmail").innerText = `Email: ${profile.email}`;
  if (profile.joined) document.getElementById("profileJoinDate").innerText = `Joined: ${new Date(profile.joined).toLocaleDateString()}`;
  if (localStorage.getItem("netWorth")) document.getElementById("netWorthTile").innerText = `ğŸ§° Total Net Worth: $${localStorage.getItem("netWorth")}`;
  if (localStorage.getItem("monthlyBudget")) {
    const b = JSON.parse(localStorage.getItem("monthlyBudget"));
    document.getElementById("monthlyBudgetTile").innerText = `ğŸ’° Monthly Budget: $${b.income.toFixed(2)}`;
    document.getElementById("remainingToBudgetTile").innerText = `ğŸ“‰ Remaining to Budget: $${b.remaining.toFixed(2)}`;
  }
  if (localStorage.getItem("topDebts")) document.getElementById("topDebtsTile").innerText = `ğŸ”¥ Top 3 Debts: ${localStorage.getItem("topDebts")}`;
  if (localStorage.getItem("creditUtilization")) {
    const u = parseFloat(localStorage.getItem("creditUtilization"));
    let color = "#007bff", badge = "";
    if (u < 30) { color = "#28a745"; badge = "(Good âœ…)"; }
    else if (u < 50) { color = "#ffc107"; badge = "(Warning âš ï¸)"; }
    else { color = "#dc3545"; badge = "(Danger âŒ)"; }
    const utilTile = document.getElementById("creditUtilizationTile");
    utilTile.style.borderLeft = `5px solid ${color}`;
    utilTile.innerText = `ğŸ’³ Credit Utilization: ${u.toFixed(2)}% ${badge}`;
  }
});

auth.onAuthStateChanged(user => {
  if (!user) return location.href = "login.html";
  const uid = user.uid;
  const userRef = db.collection("users").doc(uid);

  userRef.onSnapshot(doc => {
    const profile = doc.data();
    localStorage.setItem("profile", JSON.stringify(profile));
    document.getElementById("profileEmail").innerText = `Email: ${profile.email || 'N/A'}`;
    document.getElementById("profileJoinDate").innerText = `Joined: ${profile.joined ? new Date(profile.joined).toLocaleDateString() : 'N/A'}`;
  });

  db.collection("networth").doc(uid).onSnapshot(doc => {
    const data = doc.data();
    const assets = data.assets || [];
    const liabilities = data.liabilities || [];
    const netWorth = assets.reduce((sum, a) => sum + (a.value || 0), 0) - liabilities.reduce((sum, l) => sum + (l.value || 0), 0);
    document.getElementById("netWorthTile").innerText = `ğŸ§° Total Net Worth: $${netWorth.toFixed(2)}`;
    localStorage.setItem("netWorth", netWorth.toFixed(2));
  });

  const monthId = new Date().toISOString().slice(0, 7);
  db.collection("budgets").doc(`${uid}_${monthId}`).onSnapshot(doc => {
    const budget = doc.data();
    const income = (budget.incomes || []).reduce((sum, i) => sum + (i.amount || 0), 0);
    const expenses = (budget.expenses || []).reduce((sum, e) => sum + (e.budgeted || 0), 0);
    document.getElementById("monthlyBudgetTile").innerText = `ğŸ’° Monthly Budget: $${income.toFixed(2)}`;
    document.getElementById("remainingToBudgetTile").innerText = `ğŸ“‰ Remaining to Budget: $${(income - expenses).toFixed(2)}`;
    localStorage.setItem("monthlyBudget", JSON.stringify({ income, remaining: income - expenses }));
  });

  db.collection("users").doc(uid).collection("debts").onSnapshot(snapshot => {
    const allDebts = snapshot.docs.map(doc => doc.data());
    const topDebts = allDebts
      .sort((a, b) => (b.interest || 0) - (a.interest || 0))
      .slice(0, 3)
      .map(d => d.name || "Unnamed")
      .join(", ");
    document.getElementById("topDebtsTile").innerText = `ğŸ”¥ Top 3 Debts: ${topDebts}`;
    localStorage.setItem("topDebts", topDebts);

    const creditDebts = allDebts.filter(d => (d.type || '').toLowerCase() === 'credit' && parseFloat(d.limit || 0) > 0);
    const totalUsed = creditDebts.reduce((sum, d) => sum + parseFloat(d.balance || 0), 0);
    const totalLimit = creditDebts.reduce((sum, d) => sum + parseFloat(d.limit || 0), 0);
    const utilization = totalLimit > 0 ? (totalUsed / totalLimit) * 100 : 0;

    let color = "#007bff", badge = "";
    if (utilization < 30) { color = "#28a745"; badge = "(Good âœ…)"; }
    else if (utilization < 50) { color = "#ffc107"; badge = "(Warning âš ï¸)"; }
    else { color = "#dc3545"; badge = "(Danger âŒ)"; }

    const utilTile = document.getElementById("creditUtilizationTile");
    utilTile.style.borderLeft = `5px solid ${color}`;
    utilTile.innerText = `ğŸ’³ Credit Utilization: ${utilization.toFixed(2)}% ${badge}`;
    localStorage.setItem("creditUtilization", utilization.toFixed(2));
  });
});
</script>
</body>
</html>
