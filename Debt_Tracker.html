<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debt Tracker ‚Äì Advanced</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #333; color: white; }
    .summary { margin-top: 20px; font-size: 16px; }
    .alert { padding: 10px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; margin: 10px 0; color: #856404; }
    .tools { margin: 10px 0; text-align: center; }
    .tools button, select { margin: 0 5px; padding: 8px 12px; }
    .note-input { width: 100%; height: 50px; font-size: 14px; }
    .priority-urgent { background: #ffe5e5; }
    .priority-medium { background: #fff9cc; }
    .priority-low { background: #e2f7e2; }
  </style>
</head>
<body>
<h1>üìä Debt Tracker ‚Äì Advanced</h1>
<div class="tools">
  <select id="strategySelect">
    <option value="snowball">Snowball (Lowest Balance First)</option>
    <option value="avalanche">Avalanche (Highest Interest First)</option>
  </select>
  <button onclick="simulateStrategy()">Simulate Strategy</button>
  <button onclick="whatIfCalculator()">"What If?" Calculator</button>
  <button onclick="recommendPayment()">AI Payment Advisor</button>
  <button onclick="exportPDF()">üìÑ Export PDF</button>
</div>
<table id="debtTable">
  <thead>
    <tr>
      <th>Name</th><th>Limit</th><th>Balance</th><th>Rate %</th><th>Payment</th>
      <th>Months</th><th>CFI</th><th>Interest</th><th>Priority</th><th>Note</th><th>‚ùå</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div class="summary" id="summary"></div>
<div id="alertBox"></div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
  authDomain: "mobile-debt-tracker.firebaseapp.com",
  projectId: "mobile-debt-tracker"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const table = document.querySelector("#debtTable tbody");
const summary = document.getElementById("summary");
const alertBox = document.getElementById("alertBox");

function addDebtRow(data = {}) {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input value="${data.name || ''}" /></td>
    <td><input type="number" value="${data.limit || 0}" /></td>
    <td><input type="number" value="${data.balance || 0}" /></td>
    <td><input type="number" value="${data.rate || 0}" /></td>
    <td><input type="number" value="${data.payment || 0}" /></td>
    <td class="months">-</td>
    <td class="cfi">-</td>
    <td class="interest">-</td>
    <td class="priority">-</td>
    <td><textarea class="note-input">${data.note || ''}</textarea></td>
    <td><button onclick="this.closest('tr').remove(); calculate()">‚ùå</button></td>
  `;
  table.appendChild(row);
}

function calculate() {
  let totalBalance = 0, totalLimit = 0, totalPayment = 0, totalInterest = 0, maxMonths = 0;
  let creditBalance = 0, creditLimit = 0;
  alertBox.innerHTML = "";

  table.querySelectorAll("tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    const balance = parseFloat(inputs[2].value) || 0;
    const rate = parseFloat(inputs[3].value) || 0;
    const payment = parseFloat(inputs[4].value) || 0;
    const limit = parseFloat(inputs[1].value) || 0;
    const monthsEl = row.querySelector(".months");
    const cfiEl = row.querySelector(".cfi");
    const interestEl = row.querySelector(".interest");
    const priorityEl = row.querySelector(".priority");

    totalBalance += balance;
    totalPayment += payment;
    totalLimit += limit;
    if (limit > 0) { creditBalance += balance; creditLimit += limit; }

    let months = calcMonths(balance, rate, payment);
    let cfi = (balance / payment).toFixed(2);
    let interest = calcInterest(balance, rate, payment);

    monthsEl.innerText = months === Infinity ? '‚àû' : months;
    cfiEl.innerText = cfi;
    interestEl.innerText = "$" + interest.toFixed(2);

    const priority = getPriority(cfi);
    row.className = priority.class;
    priorityEl.innerText = priority.tag;

    totalInterest += interest;
    if (months !== Infinity && months > maxMonths) maxMonths = months;

    if (payment <= balance * (rate / 100 / 12)) {
      alertBox.innerHTML += `<div class='alert'>‚ùå ${inputs[0].value}: Payment too low to cover interest!</div>`;
    }
  });

  let util = creditLimit ? (creditBalance / creditLimit) * 100 : 0;
  if (util > 50) alertBox.innerHTML += `<div class='alert'>‚ö†Ô∏è Credit Utilization above 50% (${util.toFixed(2)}%)</div>`;

  summary.innerText = `Total Debt: $${totalBalance.toFixed(2)} | Payments: $${totalPayment.toFixed(2)} | Interest: $${totalInterest.toFixed(2)} | Utilization: ${util.toFixed(2)}% | Est. Payoff: ${maxMonths} months`;
}

function calcMonths(balance, rate, payment) {
  let r = rate / 100 / 12, m = 0;
  while (balance > 0 && m < 1000) {
    let interest = balance * r;
    let principal = payment - interest;
    if (principal <= 0) return Infinity;
    balance -= principal; m++;
  }
  return m;
}

function calcInterest(balance, rate, payment) {
  let r = rate / 100 / 12, t = 0, m = 0;
  while (balance > 0 && m < 1000) {
    let i = balance * r;
    let p = payment - i;
    if (p <= 0) break;
    balance -= p;
    t += i;
    m++;
  }
  return t;
}

function getPriority(cfi) {
  if (cfi < 20) return { tag: "üî• Urgent", class: "priority-urgent" };
  if (cfi < 50) return { tag: "‚ö†Ô∏è Medium", class: "priority-medium" };
  return { tag: "‚úÖ Low", class: "priority-low" };
}

function simulateStrategy() {
  const strategy = document.getElementById("strategySelect").value;
  const rows = [...table.querySelectorAll("tr")];
  const data = rows.map(r => {
    const i = r.querySelectorAll("input");
    return {
      name: i[0].value,
      limit: parseFloat(i[1].value),
      balance: parseFloat(i[2].value),
      rate: parseFloat(i[3].value),
      payment: parseFloat(i[4].value),
      row: r
    };
  });

  data.sort((a, b) => strategy === 'snowball' ? a.balance - b.balance : b.rate - a.rate);
  data.forEach(d => table.appendChild(d.row));
}

function recommendPayment() {
  let bestSave = 0, bestName = "", msg = "";
  table.querySelectorAll("tr").forEach(row => {
    const i = row.querySelectorAll("input");
    let balance = parseFloat(i[2].value), rate = parseFloat(i[3].value), pay = parseFloat(i[4].value);
    if (!balance || !rate || !pay) return;
    let base = calcInterest(balance, rate, pay);
    let plus = calcInterest(balance, rate, pay + 50);
    let saved = base - plus;
    if (saved > bestSave) { bestSave = saved; bestName = i[0].value; }
  });
  if (bestSave > 0) alertBox.innerHTML += `<div class='alert'>üí° Add $50 to ${bestName} to save $${bestSave.toFixed(2)} in interest.</div>`;
}

function whatIfCalculator() {
  const extra = parseFloat(prompt("Extra monthly payment to apply to ALL debts?")) || 0;
  let totalSaved = 0;
  table.querySelectorAll("tr").forEach(row => {
    const i = row.querySelectorAll("input");
    let balance = parseFloat(i[2].value), rate = parseFloat(i[3].value), pay = parseFloat(i[4].value);
    let base = calcInterest(balance, rate, pay);
    let plus = calcInterest(balance, rate, pay + extra);
    totalSaved += base - plus;
  });
  alertBox.innerHTML += `<div class='alert'>üìà What If: Adding $${extra} monthly saves ~$${totalSaved.toFixed(2)}.</div>`;
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Debt Summary", 15, 20);
  let y = 30;
  table.querySelectorAll("tr").forEach((row, i) => {
    const cells = row.querySelectorAll("td,th");
    let txt = [...cells].map(c => c.innerText || c.querySelector("input")?.value || c.querySelector("textarea")?.value).join(" | ");
    doc.text(txt, 15, y);
    y += 10;
    if (y > 280) { doc.addPage(); y = 20; }
  });
  doc.save("Debt_Summary.pdf");
}

auth.onAuthStateChanged(user => {
  if (!user) return;
  db.collection("users").doc(user.uid).collection("debts").get().then(snapshot => {
    table.innerHTML = "";
    snapshot.forEach(doc => addDebtRow(doc.data()));
    calculate();
  });
});
</script>
</body>
</html>
