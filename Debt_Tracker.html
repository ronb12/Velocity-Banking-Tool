<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Debt Tracker â€“ Full Featured</title>

  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f7f8fa; }
    nav { text-align: center; margin-bottom: 20px; }
    nav a { font-weight: bold; color: #007BFF; font-size: 16px; text-decoration: none; }
    h1 { text-align: center; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #222; color: #fff; }

    .priority-urgent { background-color: #ffe5e5; }
    .priority-medium { background-color: #fff3cd; }
    .priority-low { background-color: #e6f4ea; }

    button { margin: 5px; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }

    .summary { margin-top: 20px; font-size: 18px; }

    #amortizationModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000;
    }
    #amortizationModalContent {
      background:white; width:90%; max-width:800px; margin:50px auto; padding:20px; border-radius:8px;
      position:relative; overflow-y:auto; max-height:90%;
    }
    #amortizationModalContent table { margin-top:10px; width:100%; }
    #amortizationModalContent th, #amortizationModalContent td { padding:8px; border:1px solid #ddd; }
    #amortizationModalContent th { background:#007bff; color:white; }

    .amortization-summary {
      margin-top:20px; padding:15px; background:#e9f7ef;
      border:1px solid #d4edda; border-radius:8px; font-size:16px;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">â¬…ï¸ Back to Dashboard</a>
  </nav>

  <h1>Debt Tracker â€“ Full Featured</h1>

  <label for="strategyToggle"><strong>Payoff Strategy:</strong></label>
  <select id="strategyToggle" onchange="calculateSummary()">
    <option value="avalanche">Avalanche (Highest Interest First)</option>
    <option value="snowball">Snowball (Smallest Balance First)</option>
  </select>

  <label for="extraPayment" style="margin-left: 20px;"><strong>Extra Monthly Payment:</strong></label>
  <input type="number" id="extraPayment" value="0" style="width: 80px;" />

  <table id="debtTable">
    <thead>
      <tr>
        <th>Debt Name</th>
        <th>Limit ($)</th>
        <th>Balance ($)</th>
        <th>Interest Rate (%)</th>
        <th>Min Payment ($)</th>
        <th>Months Left</th>
        <th>CFI</th>
        <th>Total Interest</th>
        <th>Priority</th>
        <th>Amortize</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addDebt()">+ Add Debt</button>
  <button onclick="saveDebts()">ğŸ’¾ Save</button>
  <button onclick="loadDebts()">ğŸ“‚ Load</button>
  <button onclick="exportToExcel()">ğŸ“¥ Export to Excel</button>
  <button onclick="window.print()">ğŸ–¨ï¸ Print Page</button>

  <div class="summary" id="summaryText">
    Total Debt: $0 | Total Monthly Payments: $0 | Total Interest: $0 | Total Limit: $0
  </div>

  <div id="aiAdvisor" style="
    margin-top: 15px;
    font-size: 16px;
    background: #ffffff;
    border-left: 4px solid #007bff;
    padding: 12px;
    display: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    border-radius: 8px;
    line-height: 1.6;
  "></div>

  <div id="amortizationModal">
    <div id="amortizationModalContent">
      <button onclick="closeAmortization()" style="position:absolute; top:10px; right:10px; background:#dc3545;">âŒ Close</button>
      <h2>ğŸ“„ Amortization Schedule</h2>
      <button onclick="exportAmortizationToPDF()" style="margin-bottom:10px;">ğŸ“„ Export to PDF</button>
      <div id="amortizationContent"></div>
    </div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
  authDomain: "mobile-debt-tracker.firebaseapp.com",
  projectId: "mobile-debt-tracker"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const tableBody = document.querySelector("#debtTable tbody");

function addDebt(name = '', balance = '', rate = '', payment = '', limit = '') {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input value="${name}" /></td>
    <td><input type="number" value="${limit}" /></td>
    <td><input type="number" value="${balance}" /></td>
    <td><input type="number" value="${rate}" /></td>
    <td><input type="number" value="${payment}" /></td>
    <td class="monthsLeft">-</td>
    <td class="cfi">-</td>
    <td class="interest">-</td>
    <td class="priority">-</td>
    <td><button onclick="amortizeRow(this)">ğŸ“„</button></td>
    <td><button onclick="removeRow(this)" style="background:#dc3545;">âŒ</button></td>
  `;
  tableBody.appendChild(row);
  calculateSummary();
}
function calculateSummary() {
  let totalBalance = 0, totalPayment = 0, totalInterest = 0, totalLimit = 0;
  let creditBalance = 0, creditLimit = 0;

  const rows = Array.from(tableBody.querySelectorAll("tr"));
  const strategy = document.getElementById("strategyToggle")?.value || "avalanche";
  rows.sort((a, b) => {
    const aBal = parseFloat(a.querySelectorAll("input")[2].value) || 0;
    const bBal = parseFloat(b.querySelectorAll("input")[2].value) || 0;
    const aRate = parseFloat(a.querySelectorAll("input")[3].value) || 0;
    const bRate = parseFloat(b.querySelectorAll("input")[3].value) || 0;
    return strategy === "snowball" ? aBal - bBal : bRate - aRate;
  });
  tableBody.innerHTML = "";
  rows.forEach(row => tableBody.appendChild(row));

  rows.forEach(row => {
    const inputs = row.querySelectorAll("input");
    const limit = parseFloat(inputs[1].value) || 0;
    const balance = parseFloat(inputs[2].value) || 0;
    const rate = parseFloat(inputs[3].value) || 0;
    const payment = parseFloat(inputs[4].value) || 0;

    totalBalance += balance;
    totalPayment += payment;
    totalLimit += limit;
    if (limit > 0) { creditBalance += balance; creditLimit += limit; }

    if (balance > 0 && rate > 0 && payment > 0) {
      const months = calcRealMonths(balance, rate, payment);
      const cfi = (balance / payment).toFixed(2);
      const interest = calcTotalInterest(balance, rate, payment);
      const { tag, class: priorityClass } = getPriorityTag(cfi);
      row.querySelector(".monthsLeft").innerText = months;
      row.querySelector(".cfi").innerText = cfi;
      row.querySelector(".interest").innerText = "$" + interest.toFixed(2);
      row.querySelector(".priority").innerText = tag;
      row.className = priorityClass;
      totalInterest += interest;
    }
  });

  const creditUtilization = creditLimit > 0 ? (creditBalance / creditLimit) * 100 : 0;
  document.getElementById("summaryText").innerText =
    `Total Debt: $${totalBalance.toFixed(2)} | Total Monthly Payments: $${totalPayment.toFixed(2)} | Total Interest: $${totalInterest.toFixed(2)} | Total Limit: $${creditLimit.toFixed(2)} | Credit Utilization: ${creditUtilization.toFixed(2)}%`;

  const advisorBox = document.getElementById("aiAdvisor");
  advisorBox.style.display = "block";
  if (totalBalance === 0 || totalPayment === 0) {
    advisorBox.innerHTML = "ğŸ’¡ <strong>No debts found.</strong> Add debts to receive intelligent recommendations.";
    return;
  }

  let suggestion = "", worstCFI = 0, worstDebt = "", highInterestDebt = "", worstIndex = 0, highIndex = 0, highestRate = 0;
  let totalMonthsEstimate = 0;
  rows.forEach((row, i) => {
    const inputs = row.querySelectorAll("input");
    const name = inputs[0].value;
    const balance = parseFloat(inputs[2].value) || 0;
    const rate = parseFloat(inputs[3].value) || 0;
    const payment = parseFloat(inputs[4].value) || 0;
    const cfi = balance > 0 && payment > 0 ? balance / payment : 0;
    if (rate > highestRate) { highestRate = rate; highInterestDebt = name; highIndex = i; }
    if (cfi > worstCFI) { worstCFI = cfi; worstDebt = name; worstIndex = i; }
    const r = rate / 100 / 12;
    const months = r > 0 && payment > 0 ? Math.ceil(-Math.log(1 - r * balance / payment) / Math.log(1 + r)) : 0;
    totalMonthsEstimate = Math.max(totalMonthsEstimate, months);
  });

  let html = "";
  if (worstCFI > 50) {
    html += `<div style="color: #dc3545;">âš ï¸ <strong>${worstDebt}</strong> has a high cost-to-payoff ratio (${Math.ceil(worstCFI)} months). 
      <button onclick="amortizeRow(document.querySelectorAll('#debtTable tbody tr')[${worstIndex}].querySelector('button'))">ğŸ” Analyze</button></div>`;
  }
  html += `<div style="color: #007bff;">ğŸ’¸ Focus on <strong>${highInterestDebt}</strong> â€” highest rate at <strong>${highestRate.toFixed(2)}%</strong>. 
    <button onclick="amortizeRow(document.querySelectorAll('#debtTable tbody tr')[${highIndex}].querySelector('button'))">ğŸ” Analyze</button></div>`;
  const extra = parseFloat(document.getElementById("extraPayment").value) || 0;
  if (extra > 0) {
    const savedMonths = Math.floor(totalMonthsEstimate * 0.15);
    html += `<div style="color: #28a745;">ğŸ“ˆ With your extra $${extra.toFixed(2)}/mo, you could save <strong>${savedMonths}</strong> months!</div>`;
  }
  const projectedDate = new Date();
  projectedDate.setMonth(projectedDate.getMonth() + totalMonthsEstimate);
  html += `<div style="margin-top: 10px;">ğŸ“… Estimated debt-free date: <strong>${projectedDate.toLocaleDateString()}</strong></div>`;
  advisorBox.innerHTML = html;
}

function calcRealMonths(balance, rate, payment) {
  const r = rate / 100 / 12;
  if (balance <= 0 || r <= 0 || payment <= 0) return 0;
  return Math.ceil(-Math.log(1 - r * balance / payment) / Math.log(1 + r));
}

function calcTotalInterest(balance, rate, payment) {
  let r = rate / 100 / 12, total = 0, month = 0;
  while (balance > 0 && month < 1000) {
    const interest = balance * r;
    const principal = payment - interest;
    if (principal <= 0) break;
    balance -= principal;
    total += interest;
    month++;
  }
  return total;
}

function getPriorityTag(cfi) {
  if (cfi < 20) return { tag: "ğŸ”¥ Urgent", class: "priority-urgent" };
  if (cfi < 50) return { tag: "âš ï¸ Medium", class: "priority-medium" };
  return { tag: "âœ… Low", class: "priority-low" };
}

function amortizeRow(button) {
  const row = button.closest("tr");
  const inputs = row.querySelectorAll("input");
  const name = inputs[0].value;
  const balance = parseFloat(inputs[2].value) || 0;
  const rate = parseFloat(inputs[3].value) || 0;
  const base = parseFloat(inputs[4].value) || 0;
  const extra = parseFloat(document.getElementById("extraPayment").value) || 0;
  const payment = base + extra;
  const content = document.getElementById("amortizationContent");
  content.innerHTML = "";

  if (balance <= 0 || rate <= 0 || payment <= 0) {
    content.innerHTML = "<p style='color:red;'>âŒ Invalid debt data.</p>";
    document.getElementById("amortizationModal").style.display = "block";
    return;
  }

  let html = `
    <h3>ğŸ’¼ Debt: <span style="color:#007bff;">${name}</span></h3>
    <p>ğŸ’¸ <strong>Base Payment:</strong> $${base.toFixed(2)}<br>
    â• <strong>Extra Payment:</strong> $${extra.toFixed(2)}<br>
    ğŸ“¦ <strong>Total Payment:</strong> $${payment.toFixed(2)}<br>
    ğŸ“ˆ <strong>Interest Rate:</strong> ${rate.toFixed(2)}%</p>
    <p id="totalMonthsText" style="font-weight:bold;">ğŸ“† Calculating...</p>
    <table><thead><tr>
      <th>Month</th><th>Payment ($)</th><th>Principal ($)</th><th>Interest ($)</th><th>Balance Remaining ($)</th>
    </tr></thead><tbody>`;

  let balanceRemaining = balance, month = 1, totalInterest = 0, totalPaid = 0;
  const monthlyRate = rate / 100 / 12;

  while (balanceRemaining > 0 && month <= 1000) {
    const interest = balanceRemaining * monthlyRate;
    let principal = payment - interest;
    if (principal > balanceRemaining) principal = balanceRemaining;
    const actual = principal + interest;
    balanceRemaining -= principal;
    totalInterest += interest;
    totalPaid += actual;

    html += `<tr>
      <td>${month}</td><td>${actual.toFixed(2)}</td><td>${principal.toFixed(2)}</td>
      <td>${interest.toFixed(2)}</td><td>${balanceRemaining.toFixed(2)}</td>
    </tr>`;
    month++;
  }

  html = html.replace("ğŸ“† Calculating...", `ğŸ“† <strong>Total Months to Pay Off:</strong> ${month - 1} months`);
  html += `</tbody></table>
    <div class="amortization-summary">
      ğŸ“Š <strong>Total Paid:</strong> $${totalPaid.toFixed(2)}<br>
      ğŸ’¸ <strong>Total Interest Paid:</strong> $${totalInterest.toFixed(2)}
    </div>`;
  content.innerHTML = html;
  document.getElementById("amortizationModal").style.display = "block";
}

function closeAmortization() {
  document.getElementById("amortizationModal").style.display = "none";
}

function exportAmortizationToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape" });
  const content = document.getElementById("amortizationContent");
  const rows = content.querySelectorAll("table tbody tr");
  const headers = ["Month", "Payment ($)", "Principal ($)", "Interest ($)", "Balance Remaining ($)"];
  const data = Array.from(rows).map(r => Array.from(r.children).map(c => c.innerText));
  doc.setFontSize(16);
  doc.text("Debt Amortization Schedule", 14, 20);
  let summaryY = 30;
  Array.from(content.querySelectorAll("p, .amortization-summary")).forEach(el => {
    doc.text(el.innerText, 14, summaryY);
    summaryY += 8;
  });
  doc.autoTable({ head: [headers], body: data, startY: summaryY + 5, theme: 'striped', styles: { fontSize: 9 } });
  doc.save("Amortization_Schedule.pdf");
}

function saveDebts() {
  const data = [];
  tableBody.querySelectorAll("tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    data.push({
      name: inputs[0].value,
      limit: inputs[1].value,
      balance: inputs[2].value,
      rate: inputs[3].value,
      payment: inputs[4].value
    });
  });
  localStorage.setItem("debtData", JSON.stringify(data));
  const user = auth.currentUser;
  if (user) {
    db.collection('debts').doc(user.uid).set({ debts: data });
  }
}

function loadDebts() {
  const data = JSON.parse(localStorage.getItem("debtData")) || [];
  tableBody.innerHTML = "";
  data.forEach(d => addDebt(d.name, d.balance, d.rate, d.payment, d.limit));
  calculateSummary();
}

function removeRow(btn) {
  btn.parentElement.parentElement.remove();
  calculateSummary();
}

auth.onAuthStateChanged(user => {
  if (user) {
    db.collection('debts').doc(user.uid).get().then(doc => {
      if (doc.exists) {
        const debts = doc.data().debts || [];
        tableBody.innerHTML = "";
        debts.forEach(d => addDebt(d.name, d.balance, d.rate, d.payment, d.limit));
        calculateSummary();
      }
    });
  } else {
    loadDebts();
  }
});
</script>
</body>
</html>
