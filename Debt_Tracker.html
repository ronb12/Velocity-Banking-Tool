<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Debt Tracker ‚Äì Full Featured</title>
  <link rel="icon" type="image/png" href="favicon.png" />

  <!-- ‚úÖ Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
      authDomain: "mobile-debt-tracker.firebaseapp.com",
      projectId: "mobile-debt-tracker"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f7f8fa; }
    nav { text-align: center; margin-bottom: 20px; }
    nav a { font-weight: bold; color: #007BFF; font-size: 16px; text-decoration: none; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #222; color: #fff; }
    .priority-urgent { background-color: #ffe5e5; }
    .priority-medium { background-color: #fff3cd; }
    .priority-low { background-color: #e6f4ea; }
    button { margin: 5px; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .summary { margin-top: 20px; font-size: 18px; }
    #saveStatus { font-size: 14px; color: green; text-align: right; margin-top: 5px; }
    /* Modal Styling */
    #amortizationModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);
    }
    #amortizationModalContent {
      background:white; width:90%; max-width:800px; margin:50px auto; padding:20px; border-radius:8px;
      position:relative; overflow-y:auto; max-height:90%;
    }
    #amortizationModalContent table { margin-top:10px; }
    #amortizationModalContent th, #amortizationModalContent td { padding:8px; border:1px solid #ddd; }
    #amortizationModalContent th { background:#007bff; color:white; }
  </style>
</head>

<body>
  <nav>
    <a href="index.html">‚¨ÖÔ∏è Back to Dashboard</a>
  </nav>

  <h1>Debt Tracker ‚Äì Full Featured</h1>

  <table id="debtTable">
    <thead>
      <tr>
        <th>Debt Name</th>
        <th>Limit ($)</th>
        <th>Balance ($)</th>
        <th>Interest Rate (%)</th>
        <th>Min Payment ($)</th>
        <th>Months Left</th>
        <th>CFI</th>
        <th>Total Interest</th>
        <th>Priority</th>
        <th>Amortize</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="addDebt()">+ Add Debt</button>
  <button onclick="saveDebts()">üíæ Save</button>
  <button onclick="loadDebts()">üìÇ Load</button>
  <button onclick="exportToExcel()">üì• Export to Excel</button>
  <button onclick="window.print()">üñ®Ô∏è Print Page</button>

  <div id="saveStatus"></div>
  <div class="summary" id="summaryText">
    Total Debt: $0 | Total Monthly Payments: $0 | Total Interest: $0 | Total Limit: $0
  </div>

  <!-- üöÄ AMORTIZATION MODAL -->
  <div id="amortizationModal">
    <div id="amortizationModalContent">
      <button onclick="closeAmortization()" style="position:absolute; top:10px; right:10px; background:#dc3545;">‚ùå Close</button>
      <h2>üìÑ Amortization Schedule</h2>
      <div id="amortizationContent"></div>
      <button onclick="downloadAmortizationCSV()" style="margin-top:15px;">‚¨áÔ∏è Export to CSV</button>
    </div>
  </div>

<script>
// Debt Tracker Core
const tableBody = document.querySelector("#debtTable tbody");
let creditUtilization = 0;
let currentAmortizationCSV = "";

function addDebt(name = '', balance = '', rate = '', payment = '', limit = '') {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input value="${name}" oninput="calculateSummary()" /></td>
    <td><input type="number" value="${limit}" oninput="calculateSummary()" /></td>
    <td><input type="number" value="${balance}" oninput="calculateSummary()" /></td>
    <td><input type="number" value="${rate}" oninput="calculateSummary()" /></td>
    <td><input type="number" value="${payment}" oninput="calculateSummary()" /></td>
    <td class="monthsLeft">-</td>
    <td class="cfi">-</td>
    <td class="interest">-</td>
    <td class="priority">-</td>
    <td><button onclick="amortizeRow(this)">üìÑ</button></td>
    <td><button onclick="removeRow(this)" style="background:#dc3545;">‚ùå</button></td>
  `;
  tableBody.appendChild(row);
  calculateSummary();
}

function calculateSummary() {
  let totalBalance = 0, totalPayment = 0, totalInterest = 0, totalLimit = 0;
  let creditBalance = 0, creditLimit = 0;

  tableBody.querySelectorAll("tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    const limit = parseFloat(inputs[1].value) || 0;
    const balance = parseFloat(inputs[2].value) || 0;
    const rate = parseFloat(inputs[3].value) || 0;
    const payment = parseFloat(inputs[4].value) || 0;

    totalBalance += balance;
    totalPayment += payment;
    totalLimit += limit;

    if (limit > 0) {
      creditBalance += balance;
      creditLimit += limit;
    }

    if (balance > 0 && rate > 0 && payment > 0) {
      const months = calcRealMonths(balance, rate, payment);
      const cfi = (balance / payment).toFixed(2);
      const interest = calcTotalInterest(balance, rate, payment);
      const { tag, class: priorityClass } = getPriorityTag(cfi);

      row.querySelector(".monthsLeft").innerText = months;
      row.querySelector(".cfi").innerText = cfi;
      row.querySelector(".interest").innerText = "$" + interest.toFixed(2);
      row.querySelector(".priority").innerText = tag;
      row.className = priorityClass;

      totalInterest += interest;
    }
  });

  creditUtilization = creditLimit > 0 ? (creditBalance / creditLimit) * 100 : 0;
  document.getElementById("summaryText").innerText =
    `Total Debt: $${totalBalance.toFixed(2)} | Total Monthly Payments: $${totalPayment.toFixed(2)} | Total Interest: $${totalInterest.toFixed(2)} | Total Limit: $${creditLimit.toFixed(2)} | Credit Utilization: ${creditUtilization.toFixed(2)}%`;
}

function saveDebts() {
  const data = [];
  tableBody.querySelectorAll("tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    data.push({
      name: inputs[0].value,
      balance: inputs[2].value,
      rate: inputs[3].value,
      payment: inputs[4].value,
      limit: inputs[1].value
    });
  });
  localStorage.setItem("debtData", JSON.stringify(data));

  const user = auth.currentUser;
  if (user) {
    db.collection('debts').doc(user.uid).set({ debts: data, creditUtilization: creditUtilization.toFixed(2) });
  }
}

function calcRealMonths(balance, rate, payment) {
  const r = rate / 100 / 12;
  if (balance <= 0 || r <= 0 || payment <= 0) return 0;
  return Math.ceil(-Math.log(1 - r * balance / payment) / Math.log(1 + r));
}

function calcTotalInterest(balance, rate, payment) {
  let r = rate / 100 / 12, total = 0, month = 0;
  while (balance > 0 && month < 1000) {
    const interest = balance * r;
    const principal = payment - interest;
    if (principal <= 0) break;
    balance -= principal;
    total += interest;
    month++;
  }
  return total;
}

function getPriorityTag(cfi) {
  if (cfi < 20) return { tag: "üî• Urgent", class: "priority-urgent" };
  if (cfi < 50) return { tag: "‚ö†Ô∏è Medium", class: "priority-medium" };
  return { tag: "‚úÖ Low", class: "priority-low" };
}

function removeRow(btn) {
  btn.parentElement.parentElement.remove();
  calculateSummary();
}

function loadDebts() {
  const data = JSON.parse(localStorage.getItem("debtData")) || [];
  tableBody.innerHTML = "";
  data.forEach(d => addDebt(d.name, d.balance, d.rate, d.payment, d.limit));
  calculateSummary();

  auth.onAuthStateChanged(user => {
    if (user) {
      db.collection('debts').doc(user.uid).get().then(doc => {
        if (doc.exists) {
          const debts = doc.data().debts || [];
          tableBody.innerHTML = "";
          debts.forEach(d => addDebt(d.name, d.balance, d.rate, d.payment, d.limit));
          calculateSummary();
        }
      });
    }
  });
}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Amortization Table</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #007BFF;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #007BFF;
      color: white;
    }
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #e9f7ef;
      border: 1px solid #d4edda;
      border-radius: 8px;
      font-size: 18px;
    }
  </style>
</head>

<body>
<h1>üìÑ Amortization Schedule</h1>

<table id="amortizationTable">
  <thead>
    <tr>
      <th>Month</th>
      <th>Payment ($)</th>
      <th>Principal ($)</th>
      <th>Interest ($)</th>
      <th>Balance Remaining ($)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="summary" id="amortizationSummary">
  <!-- Total Paid + Interest will appear here -->
</div>

<script>
  // Receive these when the popout opens
  const balance = parseFloat(localStorage.getItem('amortize_balance') || 0);
  const rate = parseFloat(localStorage.getItem('amortize_rate') || 0);
  const payment = parseFloat(localStorage.getItem('amortize_payment') || 0);

  function generateAmortization(balance, rate, payment) {
    const table = document.getElementById("amortizationTable").querySelector("tbody");
    table.innerHTML = "";

    let month = 1;
    let totalInterest = 0;
    let totalPaid = 0;
    const monthlyRate = rate / 100 / 12;

    while (balance > 0 && month <= 1000) {
      const interestPayment = balance * monthlyRate;
      let principalPayment = payment - interestPayment;

      if (principalPayment > balance) {
        principalPayment = balance;
      }

      const actualPayment = principalPayment + interestPayment;
      balance -= principalPayment;
      totalInterest += interestPayment;
      totalPaid += actualPayment;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${month}</td>
        <td>${actualPayment.toFixed(2)}</td>
        <td>${principalPayment.toFixed(2)}</td>
        <td>${interestPayment.toFixed(2)}</td>
        <td>${balance.toFixed(2)}</td>
      `;
      table.appendChild(row);
      month++;
    }

    document.getElementById("amortizationSummary").innerHTML = `
      <strong>üìä Total Paid:</strong> $${totalPaid.toFixed(2)}<br>
      <strong>üí∏ Total Interest Paid:</strong> $${totalInterest.toFixed(2)}
    `;
  }

  window.onload = generateAmortization;
</script>
</body>
</html>

