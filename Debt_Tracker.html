<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Debt Tracker ‚Äì Full Featured</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Chart.js for future graphs if needed -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f7f8fa; }
    nav { text-align: center; margin-bottom: 20px; }
    nav a { font-weight: bold; color: #007BFF; font-size: 16px; text-decoration: none; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #222; color: #fff; }
    .priority-urgent { background: #ffe5e5; }
    .priority-medium { background: #fff3cd; }
    .priority-low { background: #e6f4ea; }
    button { margin: 5px; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .summary { margin-top: 20px; font-size: 18px; }
    .popup { background: white; padding: 20px; border: 2px solid #007bff; position: fixed; top: 10%; left: 10%; right: 10%; bottom: 10%; overflow: auto; display: none; z-index: 1000; }
    .popup-header { text-align: center; font-weight: bold; margin-bottom: 10px; }
    .popup-close { position: absolute; top: 10px; right: 20px; cursor: pointer; font-size: 24px; }
  </style>
</head>

<body>
<nav>
  <a href="index.html">‚¨ÖÔ∏è Back to Dashboard</a>
</nav>

<h1>Debt Tracker ‚Äì Full Featured</h1>

<table id="debtTable">
  <thead>
    <tr>
      <th>Debt Name</th>
      <th>Limit ($)</th>
      <th>Balance ($)</th>
      <th>Interest Rate (%)</th>
      <th>Min Payment ($)</th>
      <th>Months Left</th>
      <th>CFI</th>
      <th>Total Interest</th>
      <th>Priority</th>
      <th>Amortize</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="addDebt()">+ Add Debt</button>
<button onclick="saveDebts()">üíæ Save</button>
<button onclick="loadDebts()">üìÇ Load</button>
<button onclick="window.print()">üñ®Ô∏è Print Page</button>

<div class="summary" id="summaryText">Total Debt: $0 | Total Monthly Payments: $0 | Total Interest: $0 | Total Limit: $0</div>

<!-- üìÑ Amortization Popup -->
<div id="amortizationPopup" class="popup">
  <div class="popup-close" onclick="closeAmortization()">√ó</div>
  <div class="popup-header" id="amortizationHeader">Amortization Schedule</div>
  <div id="amortizationContent"></div>
  <button onclick="downloadCSV()">üì• Download CSV</button>
  <button onclick="downloadPDF()">üìÑ Download PDF</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
  authDomain: "mobile-debt-tracker.firebaseapp.com",
  projectId: "mobile-debt-tracker"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const tableBody = document.querySelector("#debtTable tbody");

function addDebt(name = '', balance = '', rate = '', payment = '', limit = '') {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input value="${name}" /></td>
    <td><input type="number" value="${limit}" /></td>
    <td><input type="number" value="${balance}" /></td>
    <td><input type="number" value="${rate}" /></td>
    <td><input type="number" value="${payment}" /></td>
    <td class="monthsLeft">-</td>
    <td class="cfi">-</td>
    <td class="interest">-</td>
    <td class="priority">-</td>
    <td><button onclick="amortizeRow(this)">üìÑ</button></td>
    <td><button onclick="this.parentNode.parentNode.remove();calculateSummary()">‚ùå</button></td>
  `;
  tableBody.appendChild(row);
  calculateSummary();
}

function calcRealMonths(balance, rate, payment) {
  const r = rate / 100 / 12;
  if (balance <= 0 || r <= 0 || payment <= 0) return 0;
  return Math.ceil(-Math.log(1 - r * balance / payment) / Math.log(1 + r));
}

function calcTotalInterest(balance, rate, payment) {
  let r = rate / 100 / 12, total = 0;
  while (balance > 0) {
    const interest = balance * r;
    const principal = payment - interest;
    if (principal <= 0) break;
    balance -= principal;
    total += interest;
  }
  return total;
}

function getPriorityTag(cfi) {
  if (cfi < 20) return { tag: "üî• Urgent", class: "priority-urgent" };
  if (cfi < 50) return { tag: "‚ö†Ô∏è Medium", class: "priority-medium" };
  return { tag: "‚úÖ Low", class: "priority-low" };
}

function calculateSummary() {
  let totalDebt = 0, totalPayment = 0, totalInterest = 0, totalLimit = 0;
  tableBody.querySelectorAll("tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    const limit = parseFloat(inputs[1].value) || 0;
    const balance = parseFloat(inputs[2].value) || 0;
    const rate = parseFloat(inputs[3].value) || 0;
    const payment = parseFloat(inputs[4].value) || 0;

    totalDebt += balance;
    totalPayment += payment;
    totalLimit += limit;

    if (balance > 0 && rate > 0 && payment > 0) {
      const months = calcRealMonths(balance, rate, payment);
      const cfi = (balance / payment).toFixed(2);
      const interest = calcTotalInterest(balance, rate, payment);

      row.querySelector(".monthsLeft").innerText = months;
      row.querySelector(".cfi").innerText = cfi;
      row.querySelector(".interest").innerText = "$" + interest.toFixed(2);
      row.querySelector(".priority").innerText = getPriorityTag(cfi).tag;
      row.className = getPriorityTag(cfi).class;

      totalInterest += interest;
    }
  });

  document.getElementById("summaryText").innerText = 
    `Total Debt: $${totalDebt.toFixed(2)} | Total Monthly Payments: $${totalPayment.toFixed(2)} | Total Interest: $${totalInterest.toFixed(2)} | Total Limit: $${totalLimit.toFixed(2)}`;
}

function amortizeRow(btn) {
  const row = btn.closest("tr");
  const balance = parseFloat(row.querySelectorAll("input")[2].value) || 0;
  const rate = parseFloat(row.querySelectorAll("input")[3].value) || 0;
  const payment = parseFloat(row.querySelectorAll("input")[4].value) || 0;

  let schedule = [];
  let month = 1;
  let r = rate / 100 / 12;
  let currentBalance = balance;
  let totalPaid = 0, totalInterest = 0;

  while (currentBalance > 0 && month <= 1000) {
    let interest = currentBalance * r;
    let principal = payment - interest;
    if (principal <= 0) break;
    if (currentBalance < payment) {
      principal = currentBalance;
      payment = principal + interest;
    }
    currentBalance -= principal;
    totalPaid += payment;
    totalInterest += interest;
    schedule.push([month, payment.toFixed(2), interest.toFixed(2), principal.toFixed(2), Math.max(0, currentBalance).toFixed(2)]);
    month++;
  }

  let html = `<table><tr><th>Month</th><th>Payment</th><th>Interest</th><th>Principal</th><th>Balance</th></tr>`;
  schedule.forEach(row => {
    html += `<tr><td>${row.join("</td><td>")}</td></tr>`;
  });
  html += `</table><br><strong>Total Paid:</strong> $${totalPaid.toFixed(2)} | <strong>Total Interest:</strong> $${totalInterest.toFixed(2)}`;

  document.getElementById("amortizationContent").innerHTML = html;
  document.getElementById("amortizationPopup").style.display = "block";
}

function closeAmortization() {
  document.getElementById("amortizationPopup").style.display = "none";
}

function downloadCSV() {
  const table = document.querySelector("#amortizationContent table");
  let csv = "";
  table.querySelectorAll("tr").forEach(row => {
    let cols = row.querySelectorAll("td,th");
    csv += Array.from(cols).map(col => col.innerText).join(",") + "\n";
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "amortization_schedule.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function downloadPDF() {
  window.print();
}

function saveDebts() {
  const data = [];
  tableBody.querySelectorAll("tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    data.push({
      name: inputs[0].value,
      balance: inputs[2].value,
      rate: inputs[3].value,
      payment: inputs[4].value,
      limit: inputs[1].value
    });
  });
  localStorage.setItem("debtData", JSON.stringify(data));
}

function loadDebts() {
  const data = JSON.parse(localStorage.getItem("debtData")) || [];
  tableBody.innerHTML = "";
  data.forEach(d => addDebt(d.name, d.balance, d.rate, d.payment, d.limit));
  calculateSummary();
}
</script>

</body>
</html>
