<!-- üöÄ AMORTIZATION MODAL -->
<div id="amortizationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
  <div style="background:white; width:90%; max-width:800px; margin:50px auto; padding:20px; border-radius:8px; position:relative; overflow-y:auto; max-height:90%;">
    <button onclick="closeAmortization()" style="position:absolute; top:10px; right:10px; background:#dc3545;">‚ùå Close</button>
    <h2>üìÑ Amortization Schedule</h2>
    <div id="amortizationContent"></div>
    <button onclick="downloadAmortizationCSV()" style="margin-top:15px;">‚¨áÔ∏è Export to CSV</button>
  </div>
</div>

<script>
let currentAmortizationCSV = "";

function amortizeRow(btn) {
  const row = btn.closest("tr");
  const balance = parseFloat(row.querySelectorAll("input")[2].value) || 0;
  const rate = parseFloat(row.querySelectorAll("input")[3].value) || 0;
  const payment = parseFloat(row.querySelectorAll("input")[4].value) || 0;
  
  if (balance > 0 && rate > 0 && payment > 0) {
    let html = `<table style='width:100%; border-collapse:collapse;'>`;
    html += `<thead><tr style='background:#007bff; color:white;'><th>Month</th><th>Payment ($)</th><th>Interest ($)</th><th>Principal ($)</th><th>Balance ($)</th></tr></thead><tbody>`;
    
    let csv = "Month,Payment,Interest,Principal,Balance\n";
    let r = rate / 100 / 12;
    let month = 1;
    let currentBalance = balance;

    while (currentBalance > 0 && month <= 1000) {
      const interest = currentBalance * r;
      const principal = payment - interest;
      if (principal <= 0) break;
      currentBalance -= principal;

      html += `<tr>`;
      html += `<td>${month}</td><td>${payment.toFixed(2)}</td><td>${interest.toFixed(2)}</td><td>${principal.toFixed(2)}</td><td>${Math.max(currentBalance, 0).toFixed(2)}</td>`;
      html += `</tr>`;

      csv += `${month},${payment.toFixed(2)},${interest.toFixed(2)},${principal.toFixed(2)},${Math.max(currentBalance, 0).toFixed(2)}\n`;

      month++;
    }

    html += `</tbody></table>`;

    document.getElementById("amortizationContent").innerHTML = html;
    document.getElementById("amortizationModal").style.display = "block";
    currentAmortizationCSV = csv;
  } else {
    alert("Please fill Balance, Interest Rate, and Min Payment to view Amortization.");
  }
}

function closeAmortization() {
  document.getElementById("amortizationModal").style.display = "none";
}

function downloadAmortizationCSV() {
  const blob = new Blob([currentAmortizationCSV], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "amortization_schedule.csv";
  a.click();
}
</script>
