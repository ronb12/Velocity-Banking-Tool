<script>
  const tableBody = document.querySelector("#debtTable tbody");

  function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.tab-container button').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
  }

  function addDebt(name = '', balance = '', rate = '', payment = '') {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input value="${name}" onchange="update()" /></td>
      <td><input type="number" value="${balance}" onchange="update()" /></td>
      <td><input type="number" value="${rate}" onchange="update()" /></td>
      <td><input type="number" value="${payment}" onchange="update()" /></td>
      <td>
        <button onclick="this.closest('tr').remove(); update();">‚ùå</button><br>
        <button class="amort-btn" onclick="amortizeRow(this)">üìÜ</button>
      </td>
    `;
    tableBody.appendChild(row);
    update();
  }

  function update() {
    let totalBalance = 0, totalPayment = 0;
    let labels = [], data = [];

    tableBody.querySelectorAll("tr").forEach(row => {
      const cells = row.querySelectorAll("input");
      const name = cells[0].value;
      const balance = parseFloat(cells[1].value) || 0;
      const payment = parseFloat(cells[3].value) || 0;

      totalBalance += balance;
      totalPayment += payment;
      labels.push(name);
      data.push(balance);
    });

    document.getElementById("summaryText").innerText =
      `Total Debt: $${totalBalance.toFixed(2)} | Total Monthly Payments: $${totalPayment.toFixed(2)}`;

    const ctx = document.getElementById("debtChart").getContext("2d");
    if (window.debtChart) window.debtChart.destroy();
    window.debtChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Debt Balance ($)',
          data: data,
          backgroundColor: "rgba(54, 162, 235, 0.7)"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });
  }

  function amortizeRow(btn) {
    const row = btn.closest("tr");
    const cells = row.querySelectorAll("input");
    const balance = parseFloat(cells[1].value) || 0;
    const rate = parseFloat(cells[2].value) || 0;
    const payment = parseFloat(cells[3].value) || 0;
    const r = rate / 100 / 12;

    let month = 1, output = "";
    let remaining = balance;
    let totalInterest = 0;

    output += `<h3>Schedule for ${cells[0].value}</h3>`;
    output += `<table border="1" width="100%"><tr><th>Month</th><th>Start</th><th>Interest</th><th>Principal</th><th>End</th></tr>`;

    while (remaining > 0 && month < 1000) {
      const interest = remaining * r;
      const principal = Math.min(payment - interest, remaining);
      const endBalance = remaining + interest - payment;
      output += `<tr><td>${month}</td><td>$${remaining.toFixed(2)}</td><td>$${interest.toFixed(2)}</td><td>$${principal.toFixed(2)}</td><td>$${Math.max(0,endBalance).toFixed(2)}</td></tr>`;
      remaining = endBalance;
      totalInterest += interest;
      month++;
    }

    output += `</table><p><strong>Total Interest:</strong> $${totalInterest.toFixed(2)}</p>`;
    document.getElementById("amortizationSchedule").innerHTML = output;
    switchTab('amortization', document.querySelectorAll('.tab-container button')[2]);
  }

  function saveDebts() {
    const data = [];
    tableBody.querySelectorAll("tr").forEach(row => {
      const cells = row.querySelectorAll("input");
      data.push({
        name: cells[0].value,
        balance: cells[1].value,
        rate: cells[2].value,
        payment: cells[3].value
      });
    });
    localStorage.setItem("debtData", JSON.stringify(data));
    alert("Saved!");
  }

  function loadDebts() {
    const data = JSON.parse(localStorage.getItem("debtData")) || [];
    tableBody.innerHTML = "";
    data.forEach(d => addDebt(d.name, d.balance, d.rate, d.payment));
    update();
  }

  function exportToExcel() {
    const rows = [["Name", "Balance", "Rate", "Payment"]];
    tableBody.querySelectorAll("tr").forEach(row => {
      const cells = row.querySelectorAll("input");
      rows.push([cells[0].value, cells[1].value, cells[2].value, cells[3].value]);
    });
    const csv = rows.map(r => r.join(",")).join("\\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "debt_tracker.csv";
    a.click();
  }

  window.onload = loadDebts;
</script>
