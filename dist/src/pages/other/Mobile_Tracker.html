<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>üíµ Bradley's Finance Hub ‚Äì Mobile Tracker</title>

  <!-- ‚úÖ Manifest for PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" sizes="192x192" type="image/png">

  <!-- ‚úÖ Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  
  <!-- ‚úÖ Load authHelper for waiting for auth.js -->
  <script src="/utils/authHelper.js"></script>

  <!-- ‚úÖ Firebase Initialization (fallback if auth.js not available) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",
      authDomain: "mobile-debt-tracker.firebaseapp.com",
      projectId: "mobile-debt-tracker"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    // Prefer auth.js auth/db, fallback to compat mode
    const compatAuth = firebase.auth();
    const compatDb = firebase.firestore();
    // Will be overridden by auth.js if available
    if (!window.auth) window.auth = compatAuth;
    if (!window.db) window.db = compatDb;
  </script>

  <style>
    :root {
      --bg-color: #f7f8fa;
      --text-color: #000;
      --tab-bg: #007bff;
      --tab-active: #0056b3;
      --table-header: #333;
      --button-bg: #007bff;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #121212;
        --text-color: #eee;
        --tab-bg: #1e1e1e;
        --tab-active: #333;
        --table-header: #444;
        --button-bg: #2c66d3;
      }
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    .top-nav {
      background: var(--tab-active);
      color: white;
      padding: 15px;
      text-align: center;
    }
    .top-nav a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
    }
    .tab-container {
      display: flex;
      justify-content: space-around;
      background: var(--tab-bg);
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 10;
    }
    .tab-container button {
      flex: 1;
      padding: 15px;
      color: white;
      background: none;
      border: none;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
    }
    .tab-container button.active {
      background-color: var(--tab-active);
    }
    .tab-content {
      display: none;
      padding: 20px 10px 80px;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: var(--table-header);
      color: white;
    }
    input {
      width: 90%;
      padding: 6px;
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid #888;
    }
    input[type="date"] {
      padding: 4px;
    }
    button.action {
      margin: 5px 0;
      padding: 10px;
      background: var(--button-bg);
      color: white;
      border: none;
      width: 100%;
      border-radius: 4px;
    }
  </style>
  <script type="module" crossorigin src="/assets/mobileTracker-BgNVV4_F.js"></script>
  <link rel="modulepreload" crossorigin href="/assets/modulepreload-polyfill-YP0FEG5d.js">
  <link rel="modulepreload" crossorigin href="/assets/auth-D-ZYIE7C.js">
  <script type="module">import.meta.url;import("_").catch(()=>1);(async function*(){})().next();if(location.protocol!="file:"){window.__vite_is_modern_browser=true}</script>
  <script type="module">!function(){if(window.__vite_is_modern_browser)return;console.warn("vite: loading legacy chunks, syntax error above and the same error below should be ignored");var e=document.getElementById("vite-legacy-polyfill"),n=document.createElement("script");n.src=e.src,n.onload=function(){System.import(document.getElementById('vite-legacy-entry').getAttribute('data-src'))},document.body.appendChild(n)}();</script>
</head>

<body>

<div class="top-nav">
    <a href="/index.html">‚¨ÖÔ∏è Back to Dashboard</a>
    <h1>üìä Mobile Debt Tracker</h1>
  </div>

<div id="debts" class="tab-content active">
  <h2>Debts</h2>
  <table id="debtTable">
    <thead>
      <tr>
        <th>Name</th><th>Balance</th><th>Rate (%)</th><th>Min Pay</th><th>Due Date</th><th>‚ùå</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="action" onclick="addDebt()">+ Add Debt</button>
</div>

<div id="summary" class="tab-content">
  <h2>Summary</h2>
  <p id="summaryText">Loading...</p>
  <p id="interestText"></p>
  <p id="payoffEstimate"></p>
  <button class="action" onclick="exportToCSV()">üì• Export CSV</button>
  <input type="file" accept=".csv" onchange="importCSV(event)" />
</div>

<div id="calendar" class="tab-content">
  <h2>üìÖ Calendar View</h2>
  <ul id="calendarList"></ul>
</div>

<div class="tab-container">
  <button class="active" onclick="switchTab('debts', this)">Debts</button>
  <button onclick="switchTab('summary', this)">Summary</button>
  <button onclick="switchTab('calendar', this)">Calendar</button>
</div>

<script>
const tableBody = document.querySelector("#debtTable tbody");

function switchTab(tabId, btn) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('.tab-container button').forEach(el => el.classList.remove('active'));
  btn.classList.add('active');
  if (tabId === 'calendar') renderCalendar();
}

function addDebt(name = '', balance = '', rate = '', payment = '', due = '') {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input placeholder="Name" value="${name}" onchange="saveDebts()" /></td>
    <td><input type="number" placeholder="Balance" value="${balance}" onchange="saveDebts()" /></td>
    <td><input type="number" placeholder="Rate %" value="${rate}" onchange="saveDebts()" /></td>
    <td><input type="number" placeholder="Min Pay" value="${payment}" onchange="saveDebts()" /></td>
    <td><input type="date" value="${due}" onchange="saveDebts()" /></td>
    <td><button onclick="this.closest('tr').remove(); saveDebts();">‚ùå</button></td>
  `;
  tableBody.appendChild(row);
  saveDebts();
}

function saveDebts() {
  const data = [];
  tableBody.querySelectorAll("tr").forEach(row => {
    const cells = row.querySelectorAll("input");
    data.push({
      name: cells[0].value,
      balance: parseFloat(cells[1].value) || 0,
      rate: parseFloat(cells[2].value) || 0,
      payment: parseFloat(cells[3].value) || 0,
      due: cells[4].value
    });
  });
  localStorage.setItem("debtData", JSON.stringify(data));
  const user = auth.currentUser;
  if (user) {
    db.collection("debts").doc(user.uid).set({ debts: data });
  }
  update();
}

function update() {
  let totalBalance = 0, totalPayment = 0, totalInterest = 0, maxMonths = 0;
  tableBody.querySelectorAll("tr").forEach(row => {
    const [name, balance, rate, payment] = Array.from(row.querySelectorAll("input")).map(i => i.value);
    const bal = parseFloat(balance) || 0;
    const r = (parseFloat(rate) || 0) / 100 / 12;
    const pmt = parseFloat(payment) || 0;
    let remaining = bal, months = 0;
    while (remaining > 0 && months < 1200) {
      let interest = remaining * r;
      let principal = pmt - interest;
      if (principal <= 0) break;
      remaining -= principal;
      totalInterest += interest;
      months++;
    }
    if (months > maxMonths) maxMonths = months;
    totalBalance += bal;
    totalPayment += pmt;
  });
  document.getElementById("summaryText").innerText = `Total Debt: $${totalBalance.toFixed(2)} | Total Monthly Payment: $${totalPayment.toFixed(2)}`;
  document.getElementById("interestText").innerText = `Est. Total Interest: $${totalInterest.toFixed(2)}`;
  document.getElementById("payoffEstimate").innerText = maxMonths ? `Estimated Debt-Free Date: ${new Date(new Date().setMonth(new Date().getMonth() + maxMonths)).toLocaleDateString()}` : '';
}

function renderCalendar() {
  const calendarList = document.getElementById("calendarList");
  calendarList.innerHTML = "";
  let debts = [];
  tableBody.querySelectorAll("tr").forEach(row => {
    const cells = row.querySelectorAll("input");
    const name = cells[0].value;
    const due = cells[4].value;
    if (name && due) debts.push({ name, due });
  });
  debts.sort((a, b) => new Date(a.due) - new Date(b.due));
  debts.forEach(d => {
    const li = document.createElement("li");
    li.textContent = `${new Date(d.due).toLocaleDateString()}: ${d.name}`;
    calendarList.appendChild(li);
  });
}

function exportToCSV() {
  const rows = [["Name", "Balance", "Rate", "Payment", "DueDate"]];
  tableBody.querySelectorAll("tr").forEach(row => {
    const cells = row.querySelectorAll("input");
    rows.push([cells[0].value, cells[1].value, cells[2].value, cells[3].value, cells[4].value]);
  });
  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "debts.csv";
  a.click();
}

function importCSV(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    const lines = reader.result.split("\n").slice(1);
    tableBody.innerHTML = "";
    lines.forEach(line => {
      const [name, balance, rate, payment, due] = line.split(",");
      if (name) addDebt(name.trim(), balance, rate, payment, due);
    });
    saveDebts();
  };
  reader.readAsText(file);
}

// CRITICAL: Prevent multiple redirects by checking if redirect was already attempted
const checkMobileTrackerRedirectGuard = () => {
  const lastRedirect = sessionStorage.getItem('mobile-tracker-redirect-time');
  const timeSinceRedirect = lastRedirect ? Date.now() - parseInt(lastRedirect) : 10000;
  return timeSinceRedirect > 3000; // Only allow redirect if last one was > 3 seconds ago
};

window.onload = async () => {
  // Wait for auth to be available before using it
  try {
    const { auth: authInstance, db: dbInstance } = await waitForAuth(10000);
    window.auth = authInstance; // Make globally available
    window.db = dbInstance;
    
    let mobileTrackerAuthProcessed = false;
    authInstance.onAuthStateChanged(async user => {
      // Prevent multiple processing
      if (mobileTrackerAuthProcessed) {
        return;
      }
      
      // Wait for auth.js to process first (2 seconds delay)
      setTimeout(async () => {
        if (!user && !IS_LOCALHOST) {
          // Check redirect guard
          if (!checkMobileTrackerRedirectGuard()) {
            console.log('[MobileTracker] Skipping redirect - recent redirect detected');
            return;
          }
          
          // Let auth.js handle the redirect - don't redirect here
          // This prevents conflicts between page-level and global auth.js redirects
          console.log('[MobileTracker] User not authenticated, letting auth.js handle redirect');
          mobileTrackerAuthProcessed = true;
          sessionStorage.setItem('mobile-tracker-redirect-time', Date.now().toString());
          return;
        }
        
        if (user) {
          mobileTrackerAuthProcessed = true;
          const doc = await window.db.collection("debts").doc(user.uid).get();
          if (doc.exists) {
            const debts = doc.data().debts || [];
            debts.forEach(d => addDebt(d.name, d.balance, d.rate, d.payment, d.due));
          } else if (localStorage.getItem("debtData")) {
            const localDebts = JSON.parse(localStorage.getItem("debtData"));
            localDebts.forEach(d => addDebt(d.name, d.balance, d.rate, d.payment, d.due));
          }
          update();
        }
      }, 2000); // Wait 2 seconds for auth.js to process first
    });

    // ‚úÖ Force register service worker for offline support
    if ('serviceWorker' in navigator) {
    // Clear unregister flag
    sessionStorage.removeItem('sw-unregistered');
    
    navigator.serviceWorker.getRegistrations().then(registrations => {
      // Unregister any existing ones first
      if (registrations.length > 0) {
        Promise.all(registrations.map(reg => reg.unregister())).then(() => {
          navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
            .then(registration => {
              console.log('‚úÖ Service Worker Registered:', registration.scope);
            })
            .catch(e => {
              console.error('‚ùå Service Worker registration failed:', e);
            });
        });
      } else {
        navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
          .then(registration => {
            console.log('‚úÖ Service Worker Registered:', registration.scope);
          })
          .catch(e => {
            console.error('‚ùå Service Worker registration failed:', e);
          });
      }
    }).catch(e => {
      console.warn('Service Worker check failed:', e);
      // Still try to register
      navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
        .catch(err => console.error('Registration failed:', err));
    });
    }
  } catch (error) {
    console.error('[MobileTracker] Error waiting for auth:', error);
    // Only redirect if not localhost and guard allows
    const IS_LOCALHOST = ['localhost', '127.0.0.1'].includes(window.location.hostname);
    if (!IS_LOCALHOST && checkMobileTrackerRedirectGuard()) {
      sessionStorage.setItem('mobile-tracker-redirect-time', Date.now().toString());
      // Let auth.js handle the redirect - use absolute path as fallback only
      setTimeout(() => {
        // Use absolute path, but prefer letting auth.js handle it
        console.log('[MobileTracker] Error in auth setup, letting auth.js handle redirect');
      }, 2000);
    }
  }
};
</script>

  <script nomodule>!function(){var e=document,t=e.createElement("script");if(!("noModule"in t)&&"onbeforeload"in t){var n=!1;e.addEventListener("beforeload",(function(e){if(e.target===t)n=!0;else if(!e.target.hasAttribute("nomodule")||!n)return;e.preventDefault()}),!0),t.type="module",t.src=".",e.head.appendChild(t),t.remove()}}();</script>
  <script nomodule crossorigin id="vite-legacy-polyfill" src="/assets/polyfills-legacy-gx6x68nW.js"></script>
  <script nomodule crossorigin id="vite-legacy-entry" data-src="/assets/mobileTracker-legacy-BzIDFKG1.js">System.import(document.getElementById('vite-legacy-entry').getAttribute('data-src'))</script>
</body>
</html>
