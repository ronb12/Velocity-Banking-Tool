<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>üìà Income Tracker - Bradley's Finance Hub</title>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  
  <!-- Utility Scripts -->
  <script src="/config.js"></script>
  <script src="/utils/validation.js"></script>
  <script src="/utils/errorHandler.js"></script>
  <script src="/utils/performance.js"></script>
  <script src="/utils/mobileOptimizer.js"></script>
  <script src="/utils/accessibility.js"></script>
  <script src="/utils/analytics.js"></script>
  <script src="/utils/authHelper.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    h1 {
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 1.1rem;
    }
    
    .nav-links {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .nav-links a {
      display: inline-block;
      margin: 0 10px;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: background 0.3s;
    }
    
    .nav-links a:hover {
      background: #5568d3;
    }
    
    .income-form {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .income-list {
      margin-top: 30px;
    }
    
    .income-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: box-shadow 0.3s;
    }
    
    .income-item:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .income-details {
      flex: 1;
    }
    
    .income-amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: #28a745;
    }
    
    .income-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      margin-top: 30px;
      text-align: center;
    }
    
    .summary h2 {
      margin-bottom: 15px;
    }
    
    .summary-amount {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .income-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .income-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
  <script type="module" crossorigin src="/assets/income-C6n3BlTu.js"></script>
  <link rel="modulepreload" crossorigin href="/assets/modulepreload-polyfill-YP0FEG5d.js">
  <link rel="modulepreload" crossorigin href="/assets/auth-D-ZYIE7C.js">
  <link rel="modulepreload" crossorigin href="/assets/preload-helper-BzSHXCLh.js">
  <link rel="modulepreload" crossorigin href="/assets/activityLogger-C4qvEfwc.js">
  <script type="module">import.meta.url;import("_").catch(()=>1);(async function*(){})().next();if(location.protocol!="file:"){window.__vite_is_modern_browser=true}</script>
  <script type="module">!function(){if(window.__vite_is_modern_browser)return;console.warn("vite: loading legacy chunks, syntax error above and the same error below should be ignored");var e=document.getElementById("vite-legacy-polyfill"),n=document.createElement("script");n.src=e.src,n.onload=function(){System.import(document.getElementById('vite-legacy-entry').getAttribute('data-src'))},document.body.appendChild(n)}();</script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìà Income Tracker</h1>
      <p class="subtitle">Track and manage all your income sources</p>
    </header>
    
    <nav class="nav-links">
      <a href="/index.html">üè† Home</a>
      <a href="/src/pages/other/budget.html">üí∞ Budget</a>
      <a href="/src/pages/debt/Debt_Tracker.html">üìã Debt Tracker</a>
    </nav>
    
    <div class="income-form">
      <h2>Add Income Source</h2>
      <form id="incomeForm">
        <div class="form-group">
          <label for="incomeSource">Income Source</label>
          <input type="text" id="incomeSource" placeholder="e.g., Salary, Freelance, Investment" required>
        </div>
        
        <div class="form-group">
          <label for="incomeAmount">Amount ($)</label>
          <input type="number" id="incomeAmount" step="0.01" min="0" placeholder="0.00" required>
        </div>
        
        <div class="form-group">
          <label for="incomeFrequency">Frequency</label>
          <select id="incomeFrequency" required>
            <option value="">Select frequency</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Bi-weekly</option>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
            <option value="one-time">One-time</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="incomeDate">Date</label>
          <input type="date" id="incomeDate" required>
        </div>
        
        <div class="form-group">
          <label for="incomeNotes">Notes (optional)</label>
          <textarea id="incomeNotes" rows="3" placeholder="Additional details about this income source"></textarea>
        </div>
        
        <button type="submit" class="btn">‚ûï Add Income</button>
      </form>
    </div>
    
    <div class="income-list" id="incomeList">
      <div class="empty-state">
        <div class="empty-state-icon">üí∞</div>
        <h3>No income sources yet</h3>
        <p>Add your first income source above to get started!</p>
      </div>
    </div>
    
    <div class="summary" id="summarySection" style="display: none;">
      <h2>Total Monthly Income</h2>
      <div class="summary-amount" id="totalMonthlyIncome">$0.00</div>
      <p>Based on all recurring income sources</p>
    </div>
  </div>
  
  <script>
    // Initialize date to today
    document.getElementById('incomeDate').valueAsDate = new Date();
    
    // Get auth and db from window (set by auth.js)
    let auth, db;
    
    async function initAuth() {
      if (typeof waitForAuth === 'function') {
        const { auth: authInstance, db: dbInstance } = await waitForAuth(10000);
        auth = authInstance;
        db = dbInstance;
        window.auth = auth;
        window.db = db;
      } else {
        // Fallback: wait for auth/db to be available
        let retries = 0;
        while ((!auth && !window.auth) || (!db && window.db)) {
          if (retries >= 50) break;
          await new Promise(resolve => setTimeout(resolve, 100));
          retries++;
        }
        auth = window.auth;
        db = window.db;
      }
      
      if (!auth || !db) {
        console.error('Auth or DB not available');
        return false;
      }
      
      return true;
    }
    
    // Income data storage
    let incomeSources = [];
    
    // Load income sources from Firestore
    async function loadIncomeSources() {
      if (!db || !auth?.currentUser) {
        console.log('Not authenticated, using local storage');
        const localData = localStorage.getItem('incomeSources');
        if (localData) {
          incomeSources = JSON.parse(localData);
          renderIncomeList();
        }
        return;
      }
      
      try {
        const incomeRef = db.collection('users').doc(auth.currentUser.uid).collection('income');
        const snapshot = await incomeRef.get();
        
        incomeSources = [];
        snapshot.forEach(doc => {
          incomeSources.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Also save to localStorage as backup
        localStorage.setItem('incomeSources', JSON.stringify(incomeSources));
        
        renderIncomeList();
      } catch (error) {
        console.error('Error loading income sources:', error);
        // Fallback to localStorage
        const localData = localStorage.getItem('incomeSources');
        if (localData) {
          incomeSources = JSON.parse(localData);
          renderIncomeList();
        }
      }
    }
    
    // Save income source
    async function saveIncomeSource(incomeData) {
      if (!db || !auth?.currentUser) {
        // Save to localStorage
        incomeSources.push({
          id: Date.now().toString(),
          ...incomeData,
          createdAt: new Date().toISOString()
        });
        localStorage.setItem('incomeSources', JSON.stringify(incomeSources));
        renderIncomeList();
        return;
      }
      
      try {
        const incomeRef = db.collection('users').doc(auth.currentUser.uid).collection('income');
        const docRef = await incomeRef.add({
          ...incomeData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        incomeSources.push({
          id: docRef.id,
          ...incomeData
        });
        
        // Also save to localStorage as backup
        localStorage.setItem('incomeSources', JSON.stringify(incomeSources));
        
        renderIncomeList();
      } catch (error) {
        console.error('Error saving income source:', error);
        // Fallback to localStorage
        incomeSources.push({
          id: Date.now().toString(),
          ...incomeData,
          createdAt: new Date().toISOString()
        });
        localStorage.setItem('incomeSources', JSON.stringify(incomeSources));
        renderIncomeList();
      }
    }
    
    // Delete income source
    async function deleteIncomeSource(id) {
      if (!db || !auth?.currentUser) {
        // Remove from localStorage
        incomeSources = incomeSources.filter(item => item.id !== id);
        localStorage.setItem('incomeSources', JSON.stringify(incomeSources));
        renderIncomeList();
        return;
      }
      
      try {
        const incomeRef = db.collection('users').doc(auth.currentUser.uid).collection('income').doc(id);
        await incomeRef.delete();
        
        incomeSources = incomeSources.filter(item => item.id !== id);
        localStorage.setItem('incomeSources', JSON.stringify(incomeSources));
        
        renderIncomeList();
      } catch (error) {
        console.error('Error deleting income source:', error);
        // Fallback: remove from array anyway
        incomeSources = incomeSources.filter(item => item.id !== id);
        localStorage.setItem('incomeSources', JSON.stringify(incomeSources));
        renderIncomeList();
      }
    }
    
    // Render income list
    function renderIncomeList() {
      const incomeList = document.getElementById('incomeList');
      const summarySection = document.getElementById('summarySection');
      
      if (incomeSources.length === 0) {
        incomeList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí∞</div>
            <h3>No income sources yet</h3>
            <p>Add your first income source above to get started!</p>
          </div>
        `;
        summarySection.style.display = 'none';
        return;
      }
      
      // Calculate monthly total
      let monthlyTotal = 0;
      incomeSources.forEach(income => {
        const amount = parseFloat(income.amount) || 0;
        switch(income.frequency) {
          case 'weekly':
            monthlyTotal += amount * 4.33;
            break;
          case 'biweekly':
            monthlyTotal += amount * 2.17;
            break;
          case 'monthly':
            monthlyTotal += amount;
            break;
          case 'yearly':
            monthlyTotal += amount / 12;
            break;
          case 'one-time':
            // Don't add one-time to monthly total
            break;
        }
      });
      
      // Show summary
      document.getElementById('totalMonthlyIncome').textContent = `$${monthlyTotal.toFixed(2)}`;
      summarySection.style.display = 'block';
      
      // Render list
      incomeList.innerHTML = incomeSources.map(income => {
        const date = income.date ? new Date(income.date).toLocaleDateString() : 'N/A';
        return `
          <div class="income-item">
            <div class="income-details">
              <h3>${income.source || 'Income Source'}</h3>
              <p><strong>Amount:</strong> $${parseFloat(income.amount || 0).toFixed(2)}</p>
              <p><strong>Frequency:</strong> ${income.frequency || 'N/A'}</p>
              <p><strong>Date:</strong> ${date}</p>
              ${income.notes ? `<p><strong>Notes:</strong> ${income.notes}</p>` : ''}
            </div>
            <div class="income-actions">
              <button class="btn btn-small btn-danger" onclick="deleteIncome('${income.id}')">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Delete income function (global for onclick)
    window.deleteIncome = function(id) {
      if (confirm('Are you sure you want to delete this income source?')) {
        deleteIncomeSource(id);
      }
    };
    
    // Form submission
    document.getElementById('incomeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const incomeData = {
        source: document.getElementById('incomeSource').value.trim(),
        amount: parseFloat(document.getElementById('incomeAmount').value),
        frequency: document.getElementById('incomeFrequency').value,
        date: document.getElementById('incomeDate').value,
        notes: document.getElementById('incomeNotes').value.trim()
      };
      
      await saveIncomeSource(incomeData);
      
      // Reset form
      document.getElementById('incomeForm').reset();
      document.getElementById('incomeDate').valueAsDate = new Date();
      
      // Show success message
      alert('Income source added successfully!');
    });
    
    // Initialize
    (async () => {
      const authReady = await initAuth();
      if (authReady) {
        await loadIncomeSources();
      } else {
        // Still try to load from localStorage
        await loadIncomeSources();
      }
    })();
  </script>
  <script nomodule>!function(){var e=document,t=e.createElement("script");if(!("noModule"in t)&&"onbeforeload"in t){var n=!1;e.addEventListener("beforeload",(function(e){if(e.target===t)n=!0;else if(!e.target.hasAttribute("nomodule")||!n)return;e.preventDefault()}),!0),t.type="module",t.src=".",e.head.appendChild(t),t.remove()}}();</script>
  <script nomodule crossorigin id="vite-legacy-polyfill" src="/assets/polyfills-legacy-gx6x68nW.js"></script>
  <script nomodule crossorigin id="vite-legacy-entry" data-src="/assets/income-legacy-yZqXkOV6.js">System.import(document.getElementById('vite-legacy-entry').getAttribute('data-src'))</script>
</body>
</html>
