var e,t,o,n,i,r,s,a,l,c,u;import{initializeApp as d}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";import{getAuth as m,signOut as g,signInWithEmailAndPassword as w,createUserWithEmailAndPassword as h,updateProfile as p}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";import{getFirestore as f,doc as S,getDoc as y,setDoc as I,updateDoc as v}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";const b=d((null==(e=window.CONFIG)?void 0:e.firebase)||{apiKey:"AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",authDomain:"mobile-debt-tracker.firebaseapp.com",projectId:"mobile-debt-tracker",storageBucket:"mobile-debt-tracker.appspot.com",messagingSenderId:"153601029964",appId:"1:153601029964:web:ddd1880ba21bce2e9041e9"}),D=m(b),E=f(b);"undefined"!=typeof window&&(window.auth=D,window.db=E);let T=null,O=null,x=0,N=null,C=!1;const k=(null==(o=null==(t=window.CONFIG)?void 0:t.app)?void 0:o.sessionTimeout)||18e5,A=(null==(i=null==(n=window.CONFIG)?void 0:n.security)?void 0:i.maxLoginAttempts)||5,q=(null==(s=null==(r=window.CONFIG)?void 0:r.security)?void 0:s.lockoutDuration)||9e5,F=Boolean(null==(l=null==(a=window.CONFIG)?void 0:a.security)?void 0:l.allowUnverifiedLocalLogin)&&["localhost","127.0.0.1"].includes(window.location.hostname),L=new Set(((null==(u=null==(c=window.CONFIG)?void 0:c.security)?void 0:u.allowUnverifiedAccounts)||[]).map(e=>e.toLowerCase())),j=[];function H(){clearTimeout(O),O=setTimeout(()=>{document.getElementById("sessionTimeout").style.display="block",function(){let e=60;const t=document.getElementById("timeoutCountdown"),o=setInterval(()=>{const n=Math.floor(e/60),i=e%60;t.textContent="".concat(n,":").concat(i.toString().padStart(2,"0")),e<=0&&(clearInterval(o),J()),e--},1e3)}()},k-6e4)}function G(){document.getElementById("sessionTimeout").style.display="none",H()}async function J(){try{sessionStorage.setItem("logout-in-progress","true");let t="src/pages/auth/login.html";const o=window.location.pathname;if(o.includes("index.html")||"/"===o||o.endsWith("/")?t="src/pages/auth/login.html":o.includes("/src/pages/")?t="../../src/pages/auth/login.html":o.includes("/pages/")?t="../auth/login.html":("/login.html"===o||o.endsWith("/login.html"))&&(t="src/pages/auth/login.html"),clearTimeout(O),T=null,x=0,N=null,localStorage.removeItem("userSession"),localStorage.clear(),D)try{await g(D)}catch(e){}sessionStorage.getItem("logout-in-progress");sessionStorage.clear(),sessionStorage.setItem("logout-in-progress","true"),setTimeout(()=>{try{const e=t.startsWith("/")?t:"/"+t,o=window.location.origin+e;window.location.replace(o)}catch(e){window.location.href=t.startsWith("/")?t:"/"+t}},100)}catch(t){try{sessionStorage.setItem("logout-in-progress","true"),localStorage.clear(),sessionStorage.clear(),sessionStorage.setItem("logout-in-progress","true"),window.ErrorHandler&&"function"==typeof window.ErrorHandler.handleFirebaseError&&window.ErrorHandler.handleFirebaseError(t);const e=window.location.pathname.includes("/src/pages/")?"../../src/pages/auth/login.html":"src/pages/auth/login.html";window.location.replace(window.location.origin+"/"+e)}catch(o){window.location.href=window.location.origin+"/src/pages/auth/login.html"}}}async function W(e,t){if(function(){if(N&&Date.now()<N){const e=Math.ceil((N-Date.now())/1e3/60);return ErrorHandler.showError("Account locked. Try again in ".concat(e," minutes.")),!0}return!1}())return null;try{const o=await w(D,e,t);return x=0,N=null,j.forEach(e=>e(o.user)),j.length=0,o.user}catch(o){return"auth/user-not-found"!==o.code&&"auth/wrong-password"!==o.code&&"auth/invalid-email"!==o.code||function(){if(x++,x>=A)N=Date.now()+q,ErrorHandler.showError("Too many failed attempts. Account locked for ".concat(q/1e3/60," minutes."));else{const e=A-x;ErrorHandler.showWarning("".concat(e," login attempts remaining."))}}(),ErrorHandler.handleFirebaseError(o),null}}let B=null,U=null,M=0,z=!1,K=Date.now();D.onAuthStateChanged(async e=>{B&&clearTimeout(B);const t=(null==e?void 0:e.uid)||null;if(t===U)return;if(z)return;const o=Date.now()-K,n=window.location.pathname.split("/").pop()||"index.html",i=["login.html","register.html","reset.html"].includes(n);o<2e3&&i&&!e&&(B=setTimeout(()=>{D.currentUser},2e3-o+500)),M++,B=setTimeout(async()=>{if(z||null===B)return;if(z=!0,U=t,T=e,M>10)return B=null,void(z=!1);const o=JSON.parse(sessionStorage.getItem("reload-history")||"[]"),n=Date.now();if(o.filter(e=>n-e<1e4).length>=2)return B=null,void(z=!1);if(e){C=!0;const t=(e.email||"").toLowerCase(),o=F||L.has(t);if(!e.emailVerified&&!o){await g(D);return JSON.parse(sessionStorage.getItem("reload-history")||"[]").filter(e=>Date.now()-e<5e3).length<2&&(window.location.href="login.html?error=Please verify your email first"),void(B=null)}const n=["login.html","register.html","reset.html"],r=window.location.pathname.split("/").pop()||"index.html",s="index.html"===r||""===r||"/"===r;if(n.includes(r)&&!s){const e=Date.now()-K;if(e<3e3)return sessionStorage.setItem("pending-auth-redirect","true"),B=null,z=!1,void setTimeout(()=>{if(D.currentUser&&"true"===sessionStorage.getItem("pending-auth-redirect")){sessionStorage.removeItem("pending-auth-redirect");const e=D.currentUser;D.onAuthStateChanged.call(null,e)}},3e3-e);if("true"===sessionStorage.getItem("login-handling-redirect"))return setTimeout(()=>{sessionStorage.removeItem("login-handling-redirect")},5e3),B=null,void(z=!1);const t=parseInt(sessionStorage.getItem("last-auth-redirect-time")||"0");if(Date.now()-t<5e3)return B=null,void(z=!1);if("true"===sessionStorage.getItem("reload-blocked"))return B=null,void(z=!1);const o=JSON.parse(sessionStorage.getItem("reload-history")||"[]");if(0===o.filter(e=>Date.now()-e<1e4).length&&!sessionStorage.getItem("auth-redirect-done")){sessionStorage.setItem("auth-redirect-done","true"),sessionStorage.setItem("last-auth-redirect-time",Date.now().toString());let e="/index.html";const t=window.location.pathname;e=(t.includes("/src/pages/auth/"),window.location.origin+"/index.html"),o.push(Date.now()),sessionStorage.setItem("reload-history",JSON.stringify(o)),setTimeout(()=>{try{window.location.replace(e)}catch(t){window.location.replace(window.location.origin+"/index.html")}},500)}}setTimeout(()=>{sessionStorage.removeItem("auth-redirect-done"),sessionStorage.removeItem("last-auth-redirect-time"),sessionStorage.removeItem("login-handling-redirect")},2e3),H(),function(e){const t=document.querySelector(".user-menu");t&&(t.innerHTML='\n      <span class="user-email">'.concat(e.email,'</span>\n      <button onclick="logout()" class="logout-btn">Logout</button>\n    '))}(e),document.querySelectorAll(".auth-required").forEach(e=>{e.style.display="block"}),document.querySelectorAll(".auth-not-required").forEach(e=>{e.style.display="none"});try{const t=S(E,"users",e.uid);(await y(t)).exists()?await v(t,{lastLogin:(new Date).toISOString()}):await I(t,{email:e.email,joined:(new Date).toISOString(),lastLogin:(new Date).toISOString()})}catch(i){}B=null,z=!1}else{const e=Date.now()-K,t=window.location.pathname.split("/").pop()||"index.html",o=["login.html","register.html","reset.html"].includes(t);if(!C)return C=!0,B=null,void(z=!1);if(document.querySelectorAll(".auth-required").forEach(e=>{e.style.display="none"}),document.querySelectorAll(".auth-not-required").forEach(e=>{e.style.display="block"}),o)return B=null,void(z=!1);if("true"===sessionStorage.getItem("logout-in-progress"))return setTimeout(()=>{sessionStorage.removeItem("logout-in-progress")},2e3),B=null,void(z=!1);if(e<3e3)return B=null,void(z=!1);const n=window.location.pathname,i=n.toLowerCase(),r="index.html"===t||""===t||"/"===t||"/"===i||"/index.html"===i||i.endsWith("/index.html"),s=n.includes("/src/pages/")&&!n.includes("/src/pages/auth/"),a=parseInt(sessionStorage.getItem("last-redirect-attempt")||"0"),l=Date.now()-a<5e3;if(!r&&s&&!o&&!l){sessionStorage.setItem("last-redirect-attempt",Date.now().toString());const e=JSON.parse(sessionStorage.getItem("reload-history")||"[]");if(e.filter(e=>Date.now()-e<1e4).length<1){if(!window.location.href.includes("login.html")){const t=window.location.origin+"/src/pages/auth/login.html";e.push(Date.now()),sessionStorage.setItem("reload-history",JSON.stringify(e)),setTimeout(()=>{window.location.replace(t)},500)}}else sessionStorage.removeItem("last-redirect-attempt")}else r&&(sessionStorage.removeItem("last-redirect-attempt"),sessionStorage.removeItem("pending-auth-redirect"));B=null,z=!1}},500)}),"undefined"!=typeof window&&(window.auth=D,window.db=E,window.logout=J,window.extendSession=G,window.login=W,window.register=async function(e,t,o=""){try{const n=await h(D,e,t);return o&&await p(n.user,{displayName:o}),j.forEach(e=>e(n.user)),j.length=0,n.user}catch(n){return ErrorHandler.handleFirebaseError(n),null}});export{D as a,G as e,W as l};
