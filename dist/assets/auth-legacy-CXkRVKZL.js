System.register(["https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js","https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js","https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"],function(e,t){"use strict";var o,n,r,i,s,a,l,c,u,d,g;return{setters:[e=>{o=e.initializeApp},e=>{n=e.getAuth,r=e.signOut,i=e.signInWithEmailAndPassword,s=e.createUserWithEmailAndPassword,a=e.updateProfile},e=>{l=e.getFirestore,c=e.doc,u=e.getDoc,d=e.setDoc,g=e.updateDoc}],execute:function(){e({e:A,l:C});const t=window.CONFIG?.firebase||{apiKey:"AIzaSyDrdga_hOO52nicYN3AwqqDjSbcnre6iM4",authDomain:"mobile-debt-tracker.firebaseapp.com",projectId:"mobile-debt-tracker",storageBucket:"mobile-debt-tracker.appspot.com",messagingSenderId:"153601029964",appId:"1:153601029964:web:ddd1880ba21bce2e9041e9"},m=o(t),w=e("a",n(m)),h=l(m);"undefined"!=typeof window&&(window.auth=w,window.db=h);let p=null,f=null,S=0,y=null,I=!1;const b=window.CONFIG?.app?.sessionTimeout||18e5,v=window.CONFIG?.security?.maxLoginAttempts||5,D=window.CONFIG?.security?.lockoutDuration||9e5,E=Boolean(window.CONFIG?.security?.allowUnverifiedLocalLogin)&&["localhost","127.0.0.1"].includes(window.location.hostname),T=new Set((window.CONFIG?.security?.allowUnverifiedAccounts||[]).map(e=>e.toLowerCase())),O=[];function x(){clearTimeout(f),f=setTimeout(()=>{document.getElementById("sessionTimeout").style.display="block",function(){let e=60;const t=document.getElementById("timeoutCountdown"),o=setInterval(()=>{const n=Math.floor(e/60),r=e%60;t.textContent=`${n}:${r.toString().padStart(2,"0")}`,e<=0&&(clearInterval(o),N()),e--},1e3)}()},b-6e4)}function A(){document.getElementById("sessionTimeout").style.display="none",x()}async function N(){try{sessionStorage.setItem("logout-in-progress","true");let t="src/pages/auth/login.html";const o=window.location.pathname;if(o.includes("index.html")||"/"===o||o.endsWith("/")?t="src/pages/auth/login.html":o.includes("/src/pages/")?t="../../src/pages/auth/login.html":o.includes("/pages/")?t="../auth/login.html":("/login.html"===o||o.endsWith("/login.html"))&&(t="src/pages/auth/login.html"),clearTimeout(f),p=null,S=0,y=null,localStorage.removeItem("userSession"),localStorage.clear(),w)try{await r(w)}catch(e){}sessionStorage.getItem("logout-in-progress"),sessionStorage.clear(),sessionStorage.setItem("logout-in-progress","true"),setTimeout(()=>{try{const e=t.startsWith("/")?t:"/"+t,o=window.location.origin+e;window.location.replace(o)}catch(e){window.location.href=t.startsWith("/")?t:"/"+t}},100)}catch(t){try{sessionStorage.setItem("logout-in-progress","true"),localStorage.clear(),sessionStorage.clear(),sessionStorage.setItem("logout-in-progress","true"),window.ErrorHandler&&"function"==typeof window.ErrorHandler.handleFirebaseError&&window.ErrorHandler.handleFirebaseError(t);const e=window.location.pathname.includes("/src/pages/")?"../../src/pages/auth/login.html":"src/pages/auth/login.html";window.location.replace(window.location.origin+"/"+e)}catch(o){window.location.href=window.location.origin+"/src/pages/auth/login.html"}}}async function C(e,t){if(function(){if(y&&Date.now()<y){const e=Math.ceil((y-Date.now())/1e3/60);return ErrorHandler.showError(`Account locked. Try again in ${e} minutes.`),!0}return!1}())return null;try{const o=await i(w,e,t);return S=0,y=null,O.forEach(e=>e(o.user)),O.length=0,o.user}catch(o){return"auth/user-not-found"!==o.code&&"auth/wrong-password"!==o.code&&"auth/invalid-email"!==o.code||function(){if(S++,S>=v)y=Date.now()+D,ErrorHandler.showError(`Too many failed attempts. Account locked for ${D/1e3/60} minutes.`);else{const e=v-S;ErrorHandler.showWarning(`${e} login attempts remaining.`)}}(),ErrorHandler.handleFirebaseError(o),null}}let k=null,q=null,F=0,L=!1,j=Date.now();w.onAuthStateChanged(async e=>{k&&clearTimeout(k);const t=e?.uid||null;if(t===q)return;if(L)return;const o=Date.now()-j,n=window.location.pathname.split("/").pop()||"index.html",i=["login.html","register.html","reset.html"].includes(n);o<2e3&&i&&!e&&(k=setTimeout(()=>{w.currentUser},2e3-o+500)),F++,k=setTimeout(async()=>{if(L||null===k)return;if(L=!0,q=t,p=e,F>10)return k=null,void(L=!1);const o=JSON.parse(sessionStorage.getItem("reload-history")||"[]"),n=Date.now();if(o.filter(e=>n-e<1e4).length>=2)return k=null,void(L=!1);if(e){I=!0;const t=(e.email||"").toLowerCase(),o=E||T.has(t);if(!e.emailVerified&&!o)return await r(w),JSON.parse(sessionStorage.getItem("reload-history")||"[]").filter(e=>Date.now()-e<5e3).length<2&&(window.location.href="login.html?error=Please verify your email first"),void(k=null);const n=["login.html","register.html","reset.html"],s=window.location.pathname.split("/").pop()||"index.html",a="index.html"===s||""===s||"/"===s;if(n.includes(s)&&!a){const e=Date.now()-j;if(e<3e3)return sessionStorage.setItem("pending-auth-redirect","true"),k=null,L=!1,void setTimeout(()=>{if(w.currentUser&&"true"===sessionStorage.getItem("pending-auth-redirect")){sessionStorage.removeItem("pending-auth-redirect");const e=w.currentUser;w.onAuthStateChanged.call(null,e)}},3e3-e);if("true"===sessionStorage.getItem("login-handling-redirect"))return setTimeout(()=>{sessionStorage.removeItem("login-handling-redirect")},5e3),k=null,void(L=!1);const t=parseInt(sessionStorage.getItem("last-auth-redirect-time")||"0");if(Date.now()-t<5e3)return k=null,void(L=!1);if("true"===sessionStorage.getItem("reload-blocked"))return k=null,void(L=!1);const o=JSON.parse(sessionStorage.getItem("reload-history")||"[]");if(0===o.filter(e=>Date.now()-e<1e4).length&&!sessionStorage.getItem("auth-redirect-done")){sessionStorage.setItem("auth-redirect-done","true"),sessionStorage.setItem("last-auth-redirect-time",Date.now().toString());let e="/index.html";const t=window.location.pathname;t.includes("/src/pages/auth/"),e=window.location.origin+"/index.html",o.push(Date.now()),sessionStorage.setItem("reload-history",JSON.stringify(o)),setTimeout(()=>{try{window.location.replace(e)}catch(t){window.location.replace(window.location.origin+"/index.html")}},500)}}setTimeout(()=>{sessionStorage.removeItem("auth-redirect-done"),sessionStorage.removeItem("last-auth-redirect-time"),sessionStorage.removeItem("login-handling-redirect")},2e3),x(),function(e){const t=document.querySelector(".user-menu");t&&(t.innerHTML=`\n      <span class="user-email">${e.email}</span>\n      <button onclick="logout()" class="logout-btn">Logout</button>\n    `)}(e),document.querySelectorAll(".auth-required").forEach(e=>{e.style.display="block"}),document.querySelectorAll(".auth-not-required").forEach(e=>{e.style.display="none"});try{const t=c(h,"users",e.uid);(await u(t)).exists()?await g(t,{lastLogin:(new Date).toISOString()}):await d(t,{email:e.email,joined:(new Date).toISOString(),lastLogin:(new Date).toISOString()})}catch(i){}k=null,L=!1}else{const e=Date.now()-j,t=window.location.pathname.split("/").pop()||"index.html",o=["login.html","register.html","reset.html"].includes(t);if(!I)return I=!0,k=null,void(L=!1);if(document.querySelectorAll(".auth-required").forEach(e=>{e.style.display="none"}),document.querySelectorAll(".auth-not-required").forEach(e=>{e.style.display="block"}),o)return k=null,void(L=!1);if("true"===sessionStorage.getItem("logout-in-progress"))return setTimeout(()=>{sessionStorage.removeItem("logout-in-progress")},2e3),k=null,void(L=!1);if(e<3e3)return k=null,void(L=!1);const n=window.location.pathname,r=n.toLowerCase(),i="index.html"===t||""===t||"/"===t||"/"===r||"/index.html"===r||r.endsWith("/index.html"),s=n.includes("/src/pages/")&&!n.includes("/src/pages/auth/"),a=parseInt(sessionStorage.getItem("last-redirect-attempt")||"0"),l=Date.now()-a<5e3;if(i||!s||o||l)i&&(sessionStorage.removeItem("last-redirect-attempt"),sessionStorage.removeItem("pending-auth-redirect"));else{sessionStorage.setItem("last-redirect-attempt",Date.now().toString());const e=JSON.parse(sessionStorage.getItem("reload-history")||"[]");if(e.filter(e=>Date.now()-e<1e4).length<1){if(!window.location.href.includes("login.html")){const t=window.location.origin+"/src/pages/auth/login.html";e.push(Date.now()),sessionStorage.setItem("reload-history",JSON.stringify(e)),setTimeout(()=>{window.location.replace(t)},500)}}else sessionStorage.removeItem("last-redirect-attempt")}k=null,L=!1}},500)}),"undefined"!=typeof window&&(window.auth=w,window.db=h,window.logout=N,window.extendSession=A,window.login=C,window.register=async function(e,t,o=""){try{const n=await s(w,e,t);return o&&await a(n.user,{displayName:o}),O.forEach(e=>e(n.user)),O.length=0,n.user}catch(n){return ErrorHandler.handleFirebaseError(n),null}})}}});
